<script>
// ===== 1ì°¨ í‰ê°€ ê´€ë ¨ í•¨ìˆ˜ =====
function checkExistingEvaluation() {
    const evalMonth = document.getElementById('evalMonth').value;
    const teamleadId = document.getElementById('teamleadSelect').value;
    
    if (!evalMonth || !teamleadId) {
        document.getElementById('evaluationModeArea').style.display = 'none';
        showLoading(false);
        return;
    }
    
    if (currentUser.level === 1) {
        const selectedEmail = document.querySelector(`#teamleadSelect option[value="${teamleadId}"]`).dataset.email;
        if (selectedEmail && selectedEmail !== currentUser.email) {
            showNotification('ë³¸ì¸ì˜ í‰ê°€ë§Œ ì‘ì„±/ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
            document.getElementById('evaluationModeArea').style.display = 'none';
            showLoading(false);
            return;
        }
    }
    
    evaluationData.currentEvalMonth = evalMonth;
    evaluationData.currentTeamleadId = teamleadId;
    
    showLoading(true);
    
    google.script.run
        .withSuccessHandler(function(evalInfo) {
            if (evalInfo) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        evaluationData.currentEvalInfo = evalInfo;
                        evaluationData.existingEvaluations = result.evaluations;
                        evaluationData.selectedChannels = result.evaluatedChannels;
                        
                        displayExistingEvaluation(evalInfo, result.evaluatedChannels);
                        showLoading(false);
                    })
                    .withFailureHandler(function(error) {
                        showNotification('í‰ê°€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
                        showLoading(false);
                    })
                    .getFirstEvaluationByTeamlead(evalMonth, teamleadId);
            } else {
                evaluationData.evaluationMode = 'new';
                displayNewEvaluation();
                showLoading(false);
            }
        })
        .withFailureHandler(function(error) {
            showNotification('í‰ê°€ ì •ë³´ í™•ì¸ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getEvaluationInfo(evalMonth, teamleadId);
}

function displayExistingEvaluation(evalInfo, evaluatedChannels) {
    evaluationData.evaluationMode = 'view';
    
    document.getElementById('evaluationModeArea').style.display = 'block';
    document.getElementById('existingEvalInfo').style.display = 'block';
    document.getElementById('evaluationEditArea').style.display = 'none';
    document.getElementById('submitFirstEvalBtn').style.display = 'none';
    document.getElementById('channelEvaluationsArea').style.display = 'block';
    
    document.getElementById('lastModified').textContent = evalInfo.lastModified;
    
    const channelNames = evaluatedChannels.map(chId => {
        const channel = evaluationData.channels.find(c => c.id === chId);
        return channel ? channel.name : chId;
    });
    document.getElementById('evaluatedChannelsList').textContent = channelNames.join(', ');
    
    displayEvaluationReadOnly();
}

function displayNewEvaluation() {
    evaluationData.evaluationMode = 'new';
    
    document.getElementById('evaluationModeArea').style.display = 'block';
    document.getElementById('existingEvalInfo').style.display = 'none';
    document.getElementById('evaluationEditArea').style.display = 'block';
    document.getElementById('submitFirstEvalBtn').style.display = 'none';
    
    document.getElementById('channelEvaluationsArea').innerHTML = '';
    evaluationData.selectedChannels = [];
    evaluationData.currentChannels = {};
    
    if (currentUser.level === 1 && currentUser.teamId) {
        setTimeout(() => {
            const teamSelect = document.getElementById('evaluationTeamSelect');
            if (teamSelect) {
                for (let option of teamSelect.options) {
                    if (option.value && option.value !== currentUser.teamId) {
                        option.disabled = true;
                        option.style.color = '#666';
                        option.style.backgroundColor = '#2a2a2a';
                    }
                }
                teamSelect.value = currentUser.teamId;
                loadTeamChannels();
            }
        }, 50);
    }
}

function displayEvaluationReadOnly() {
    const evaluationsArea = document.getElementById('channelEvaluationsArea');
    evaluationsArea.innerHTML = '';
    
    for (const channelId in evaluationData.existingEvaluations) {
        const channelEval = evaluationData.existingEvaluations[channelId];
        const html = displayChannelEvaluationReadOnly(channelId, channelEval);
        evaluationsArea.innerHTML += html;
    }
}

function displayChannelEvaluationReadOnly(channelId, channelEval) {
    // MM ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
    channelEval.members.sort((a, b) => (b.mm || 0) - (a.mm || 0));
    
    let html = `
        <div class="channel-evaluation-section readonly-mode" data-channel-id="${channelId}">
            <div class="channel-info-card">
                <h4>${channelEval.channelName}</h4>
                <p class="channel-members-count">íŒ€ì› ìˆ˜: ${channelEval.members.length}ëª…</p>
                ${channelEval.channelComment ? `<p style="color: #666; margin-top: 10px;"><strong>ì±„ë„ ì½”ë©˜íŠ¸:</strong> ${channelEval.channelComment}</p>` : ''}
            </div>
            
            <table class="evaluation-table">
                <thead>
                    <tr>
                        <th>íŒ€ì›ëª…</th>
                        <th>ì†Œì†íŒ€</th>
                        <th>íˆ¬ì… MM</th>
                        <th>1ì°¨ ê¸°ì—¬ë„(%)</th>
                        <th>í•µì‹¬ì„±ê³¼</th>
                        <th>1ì°¨ ì½”ë©˜íŠ¸</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    channelEval.members.forEach(member => {
        const formattedAchievements = formatAchievements(member.achievement);
        html += `
            <tr>
                <td>${member.name}</td>
                <td>${member.teamName}</td>
                <td>${member.mm}</td>
                <td class="percentage">${member.contribution1}%</td>
                <td><div class="achievement-display">${formattedAchievements}</div></td>
                <td>${member.comment1 || ''}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    return html;
}

function loadTeamChannels() {
    const selectedTeam = document.getElementById('evaluationTeamSelect').value;
    const channelsArea = document.getElementById('teamChannelsArea');
    const checkboxArea = document.getElementById('channelCheckboxArea');
    
    if (!selectedTeam) {
        channelsArea.style.display = 'none';
        return;
    }
    
    if (currentUser.level === 1 && currentUser.teamId && selectedTeam !== currentUser.teamId) {
        showNotification('ìì‹ ì˜ íŒ€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
        document.getElementById('evaluationTeamSelect').value = currentUser.teamId;
        return;
    }
    
    channelsArea.style.display = 'block';
    checkboxArea.innerHTML = '';
    
    const teamChannels = evaluationData.channels.filter(c => c.teamId === selectedTeam);
    
    if (teamChannels.length === 0) {
        checkboxArea.innerHTML = '<p style="color: #aaa;">ì´ íŒ€ì— í‰ê°€í•  ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    teamChannels.forEach(channel => {
        const isChecked = evaluationData.selectedChannels.includes(channel.id);
        const item = document.createElement('label');  // div ëŒ€ì‹  label ì‚¬ìš©
        item.className = 'channel-checkbox-item';
        item.innerHTML = `
            <input type="checkbox" id="ch_${channel.id}" value="${channel.id}" ${isChecked ? 'checked' : ''} onchange="updateSelectedChannels('${channel.id}')">
            ${channel.name}
        `;
        checkboxArea.appendChild(item);
    });
}

function updateSelectedChannels(channelId) {
    const checkbox = document.getElementById(`ch_${channelId}`);
    if (checkbox.checked) {
        if (!evaluationData.selectedChannels.includes(channelId)) {
            evaluationData.selectedChannels.push(channelId);
        }
    } else {
        const index = evaluationData.selectedChannels.indexOf(channelId);
        if (index > -1) {
            evaluationData.selectedChannels.splice(index, 1);
        }
        removeChannelEvaluation(channelId);
    }
}

function loadSelectedChannels() {
    const selectedChannels = [];
    document.querySelectorAll('#channelCheckboxArea input[type="checkbox"]:checked').forEach(checkbox => {
        selectedChannels.push(checkbox.value);
    });
    
    if (selectedChannels.length === 0) {
        showNotification('í‰ê°€í•  ì±„ë„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    // ê¸°ì¡´ í‘œì‹œëœ ì±„ë„ ì´ˆê¸°í™”
    const evaluationsArea = document.getElementById('channelEvaluationsArea');
    evaluationsArea.innerHTML = ''; // ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ì´ˆê¸°í™”
    
    showLoading(true);
    
    Promise.all([
        new Promise((resolve) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(() => resolve({}))
                .getMultipleChannelMembersData(selectedChannels);
        }),
        new Promise((resolve) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(() => resolve({}))
                .getMultipleExistingEvaluations(selectedChannels, evaluationData.currentEvalMonth);
        })
    ]).then(([allChannelMembers, allExistingEvals]) => {
        selectedChannels.forEach(channelId => {
            const channelMembers = allChannelMembers[channelId] || [];
            const existingEval = allExistingEvals[channelId] || {};
            evaluationData.currentChannels[channelId] = channelMembers;
            
            const html = displayChannelEvaluation(channelId, channelMembers, existingEval);
            evaluationsArea.innerHTML += html;
        });
        
        showLoading(false);
        document.getElementById('submitFirstEvalBtn').style.display = 'block';
    });
}

function displayChannelEvaluation(channelId, channelMembers, existingEval) {
    const channel = evaluationData.channels.find(c => c.id === channelId);
    
    // ê¸°ì¡´ í‰ê°€ê°€ ìˆìœ¼ë©´ ê·¸ ê°’ìœ¼ë¡œ ì •ë ¬, ì—†ìœ¼ë©´ ì´ë¦„ìˆœ
    if (existingEval && Object.keys(existingEval).length > 0) {
        channelMembers.sort((a, b) => {
            const mmA = existingEval[a.id]?.mm || 0;
            const mmB = existingEval[b.id]?.mm || 0;
            return mmB - mmA;
        });
    }
    
    let html = `
        <div class="channel-evaluation-section" data-channel-id="${channelId}">
            <div class="channel-info-card">
                <div class="channel-header">
                    <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                        <h4>${channel.name}</h4>
                        <p class="channel-members-count">íŒ€ì› ìˆ˜: ${channelMembers.length}ëª…</p>
                        <!-- ì±„ë„ ì½”ë©˜íŠ¸ ë²„íŠ¼ì„ ì±„ë„ëª… ì˜†ì— ë°°ì¹˜ -->
                        <button class="btn btn-primary" style="padding: 5px 15px; font-size: 14px;" onclick="toggleChannelComment('${channelId}')">
                            <span id="commentToggle_${channelId}">ğŸ“ ì±„ë„ ì½”ë©˜íŠ¸</span>
                        </button>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <!-- ë‚˜ë¨¸ì§€ ê¸°ëŠ¥ ë²„íŠ¼ë“¤ -->
                        <button class="btn btn-success" style="padding: 5px 15px; font-size: 14px;" onclick="distributeEvenly('${channelId}')" title="ê¸°ì—¬ë„ë¥¼ íŒ€ì› ìˆ˜ì— ë§ì¶° ê· ë“±í•˜ê²Œ ë¶„ë°°í•©ë‹ˆë‹¤">
                            âš–ï¸ ê· ë“± ë¶„ë°°
                        </button>
                        <button class="btn btn-primary" style="padding: 5px 15px; font-size: 14px;" onclick="sortByMM('${channelId}')">
                            ğŸ”„ MMìˆœ ì •ë ¬
                        </button>
                        <button class="btn btn-warning" style="padding: 5px 15px; font-size: 14px;" onclick="toggleMemberManagement('${channelId}')">
                            <span id="memberToggle_${channelId}">ğŸ‘¥ íŒ€ì› ê´€ë¦¬</span>
                        </button>
                        <button class="btn btn-danger" onclick="removeChannelEvaluation('${channelId}')">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </div>
                </div>
                ${Object.keys(existingEval).length > 0 ? '<p style="color: #ff6b6b; font-weight: bold; margin-top: 10px;">â€» ê¸°ì¡´ í‰ê°€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤</p>' : ''}
            </div>
                    
            <div id="channelComment_${channelId}" class="channel-comment-section" style="display: none;">
                <label><strong>ì±„ë„ ì „ì²´ ì½”ë©˜íŠ¸:</strong></label>
                <textarea id="channelCommentText_${channelId}" placeholder="ì´ ì±„ë„ì— ëŒ€í•œ ì „ì²´ì ì¸ í‰ê°€ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; min-height: 80px; margin-top: 10px;">${existingEval.channelComment || ''}</textarea>
            </div>
            
            <div id="memberManagement_${channelId}" class="member-management-section" style="display: none;">
                <h5>ğŸ‘¥ ì±„ë„ íŒ€ì› ê´€ë¦¬</h5>
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label>íŒ€ ì„ íƒ:</label>
                        <select id="teamSelect_${channelId}" onchange="loadTeamMembers('${channelId}')">
                            <option value="">íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="team1">ìŠ¤íŠœë””ì˜¤ 1íŒ€</option>
                            <option value="team2">ìŠ¤íŠœë””ì˜¤ 2íŒ€</option>
                            <option value="team3">ìŠ¤íŠœë””ì˜¤ 3íŒ€</option>
                            <option value="team4">ìŠ¤íŠœë””ì˜¤ 4íŒ€</option>
                            <option value="team5">ìŠ¤íŠœë””ì˜¤ 5íŒ€</option>
                            <option value="team6">ì´¬ì˜íŒ€</option>
                        </select>
                    </div>
                    <div style="flex: 2;">
                        <label>íŒ€ì› ì¶”ê°€:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="memberSelect_${channelId}" style="flex: 1;">
                                <option value="">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                            <button class="btn btn-success" onclick="addMemberToChannelEval('${channelId}')">â• ì¶”ê°€</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="summary-box">
                <div class="summary-item">
                    <span class="summary-label">íˆ¬ì… MM í•©ê³„:</span>
                    <span class="summary-value" id="totalMM_${channelId}">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ì”ì—¬ ê¸°ì—¬ë„:</span>
                    <span class="summary-value percentage" id="remainingText_${channelId}">100%</span>
                </div>
                <div class="progress-bar" style="margin-top: 10px;">
                    <div class="progress-fill" id="contributionBar_${channelId}" style="width: 0%; background: #e74c3c;">0%</div>
                </div>
            </div>
            
            <table class="evaluation-table">
                <thead>
                    <tr>
                        <th>íŒ€ì›ëª…</th>
                        <th>ì†Œì†íŒ€</th>
                        <th>íˆ¬ì… MM</th>
                        <th>1ì°¨ ê¸°ì—¬ë„(%)</th>
                        <th>ìƒì„¸ì •ë³´</th>
                        <th>ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody id="tbody_${channelId}">
    `;
    
    channelMembers.forEach(member => {
        const existing = existingEval[member.id] || existingEval.members?.find(m => m.id === member.id) || {};
        const achievements = existing.achievement ? existing.achievement.split('|') : [''];
        
        html += createMemberRow(channelId, member, existing, achievements);
    });
    
    html += '</tbody></table></div>';
    
    if (Object.keys(existingEval).length > 0) {
        setTimeout(() => {
            updateMMTotal(channelId);
            updateContributionBar(channelId);
            forceDarkModeForChannel(channelId);
        }, 100);
    } else {
        setTimeout(() => {
            forceDarkModeForChannel(channelId);
        }, 100);
    }
    
    return html;
}

function createMemberRow(channelId, member, existing, achievements) {
    let html = `
        <tr id="row_${channelId}_${member.id}" data-member-id="${member.id}">
            <td>${member.name}</td>
            <td>${member.teamName}</td>
            <td><input type="number" id="mm_${channelId}_${member.id}" step="0.1" min="0" max="1" placeholder="0.0" value="${existing.mm || ''}" onchange="updateMMTotalAndSort('${channelId}')"></td>
            <td><input type="number" id="contrib_${channelId}_${member.id}" step="1" min="0" max="100" placeholder="0" value="${existing.contribution1 || ''}" onchange="updateContributionBar('${channelId}')"></td>
            <td><button class="detail-btn" onclick="toggleDetail('${channelId}_${member.id}')">+</button></td>
            <td><button class="btn btn-danger" style="padding: 2px 8px; font-size: 12px;" onclick="removeMemberFromChannelEval('${channelId}', '${member.id}')">ğŸ—‘ï¸</button></td>
        </tr>
        <tr id="detail_row_${channelId}_${member.id}" data-member-id="${member.id}" style="display: none;">
            <td colspan="6">
                <div id="detail_${channelId}_${member.id}" class="detail-panel show">
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 1;">
                            <strong>ğŸ† ê°œì¸ë³„ í•µì‹¬ ì„±ê³¼:</strong>
                            <div id="achievements_${channelId}_${member.id}" class="achievements-list">
    `;
    
    achievements.forEach((achievement, index) => {
        if (achievement || index === 0) {
            html += `
                <div class="achievement-item">
                    <input type="text" placeholder="í•µì‹¬ ì„±ê³¼ ì…ë ¥" value="${achievement}">
                    <button onclick="removeAchievement(this)" class="btn btn-danger" style="padding: 2px 8px; font-size: 12px;">âŒ</button>
                </div>
            `;
        }
    });
    
    html += `
                            </div>
                            <button onclick="addAchievement('${channelId}_${member.id}')" class="btn btn-primary" style="margin-top: 10px; padding: 5px 10px; font-size: 12px;">â• ì„±ê³¼ ì¶”ê°€</button>
                        </div>
                        <div style="flex: 1;">
                            <strong>ğŸ’¬ 1ì°¨ ì½”ë©˜íŠ¸:</strong>
                            <textarea id="comment1_${channelId}_${member.id}" placeholder="í‰ê°€ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">${existing.comment1 || ''}</textarea>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    `;
    
    return html;
}

// MM ê°’ ì—…ë°ì´íŠ¸ ë° ìë™ ì •ë ¬
function updateMMTotalAndSort(channelId) {
    updateMMTotal(channelId);
    // ìë™ìœ¼ë¡œ MM ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
    sortByMM(channelId);
}

// MM ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ëŠ” í•¨ìˆ˜
function sortByMM(channelId) {
    const tbody = document.getElementById(`tbody_${channelId}`);
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // ë©¤ë²„ í–‰ê³¼ ìƒì„¸ì •ë³´ í–‰ì„ ìŒìœ¼ë¡œ ë¬¶ê¸°
    const memberPairs = [];
    for (let i = 0; i < rows.length; i += 2) {
        if (rows[i] && rows[i + 1]) {
            const memberId = rows[i].dataset.memberId;
            const mmInput = document.getElementById(`mm_${channelId}_${memberId}`);
            const mmValue = parseFloat(mmInput?.value) || 0;
            
            memberPairs.push({
                memberRow: rows[i],
                detailRow: rows[i + 1],
                mmValue: mmValue
            });
        }
    }
    
    // MM ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
    memberPairs.sort((a, b) => b.mmValue - a.mmValue);
    
    // tbody ë¹„ìš°ê³  ì •ë ¬ëœ ìˆœì„œë¡œ ë‹¤ì‹œ ì¶”ê°€
    tbody.innerHTML = '';
    memberPairs.forEach(pair => {
        tbody.appendChild(pair.memberRow);
        tbody.appendChild(pair.detailRow);
    });
}

function toggleChannelComment(channelId) {
    const commentSection = document.getElementById(`channelComment_${channelId}`);
    const toggleButton = document.getElementById(`commentToggle_${channelId}`);
    
    if (commentSection.style.display === 'none') {
        commentSection.style.display = 'block';
        toggleButton.textContent = 'ğŸ“ ì±„ë„ ì½”ë©˜íŠ¸ ë‹«ê¸°';
    } else {
        commentSection.style.display = 'none';
        toggleButton.textContent = 'ğŸ“ ì±„ë„ ì½”ë©˜íŠ¸';
    }
}

function toggleDetail(id) {
    const detailRow = document.getElementById(`detail_row_${id}`);
    const detailPanel = document.getElementById(`detail_${id}`);
    
    if (detailRow.style.display === 'none') {
        detailRow.style.display = 'table-row';
    } else {
        detailRow.style.display = 'none';
    }
}

function updateMMTotal(channelId) {
    const members = evaluationData.currentChannels[channelId];
    if (!members) return;
    
    let totalMM = 0;
    
    members.forEach(member => {
        const mmInput = document.getElementById(`mm_${channelId}_${member.id}`);
        if (mmInput) {
            const mm = parseFloat(mmInput.value) || 0;
            totalMM += mm;
        }
    });
    
    document.getElementById(`totalMM_${channelId}`).textContent = totalMM.toFixed(1);
}

function updateContributionBar(channelId) {
    const members = evaluationData.currentChannels[channelId];
    if (!members) return;
    
    let totalContribution = 0;
    
    members.forEach(member => {
        const contribInput = document.getElementById(`contrib_${channelId}_${member.id}`);
        if (contribInput) {
            const contrib = parseFloat(contribInput.value) || 0;
            totalContribution += contrib;
        }
    });
    
    const remaining = 100 - totalContribution;
    const used = Math.min(totalContribution, 100);
    
    document.getElementById(`remainingText_${channelId}`).textContent = `${remaining}%`;
    
    const bar = document.getElementById(`contributionBar_${channelId}`);
    bar.style.width = `${used}%`;
    bar.textContent = `${used}%`;
    
    if (totalContribution === 100) {
        bar.style.background = '#27ae60';
    } else if (totalContribution > 100) {
        bar.style.background = '#e74c3c';
    } else {
        bar.style.background = '#3498db';
    }
}

function addAchievement(memberId) {
    const container = document.getElementById(`achievements_${memberId}`);
    const newItem = document.createElement('div');
    newItem.className = 'achievement-item';
    newItem.innerHTML = `
        <input type="text" placeholder="í•µì‹¬ ì„±ê³¼ ì…ë ¥">
        <button onclick="removeAchievement(this)" class="btn btn-danger" style="padding: 2px 8px; font-size: 12px;">âŒ</button>
    `;
    container.appendChild(newItem);
}

function removeAchievement(button) {
    const container = button.parentElement.parentElement;
    if (container.children.length > 1) {
        button.parentElement.remove();
    }
}

function removeChannelEvaluation(channelId) {
    const section = document.querySelector(`[data-channel-id="${channelId}"]`);
    if (section) {
        section.remove();
    }
    
    delete evaluationData.currentChannels[channelId];
    delete evaluationData.existingEvaluations[channelId];
    
    const index = evaluationData.selectedChannels.indexOf(channelId);
    if (index > -1) {
        evaluationData.selectedChannels.splice(index, 1);
    }
}

function enableEditMode() {
    evaluationData.evaluationMode = 'edit';
    
    document.getElementById('existingEvalInfo').style.display = 'none';
    document.getElementById('evaluationEditArea').style.display = 'block';
    document.getElementById('submitFirstEvalBtn').style.display = 'block';
    
    if (currentUser.level === 1 && currentUser.teamId) {
        setTimeout(() => {
            const teamSelect = document.getElementById('evaluationTeamSelect');
            if (teamSelect) {
                for (let option of teamSelect.options) {
                    if (option.value && option.value !== currentUser.teamId) {
                        option.disabled = true;
                        option.style.color = '#666';
                        option.style.backgroundColor = '#2a2a2a';
                    }
                }
                teamSelect.value = currentUser.teamId;
            }
        }, 50);
    }
    
    const evaluationsArea = document.getElementById('channelEvaluationsArea');
    evaluationsArea.innerHTML = '';
    
    evaluationData.currentChannels = {};
    
    for (const channelId in evaluationData.existingEvaluations) {
        const channelEval = evaluationData.existingEvaluations[channelId];
        evaluationData.currentChannels[channelId] = channelEval.members;
        
        const html = displayChannelEvaluation(channelId, channelEval.members, channelEval);
        evaluationsArea.innerHTML += html;
    }
}

function submitFirstEvaluation() {
    const evaluations = [];
    const sections = document.querySelectorAll('.channel-evaluation-section');
    
    if (sections.length === 0) {
        showNotification('í‰ê°€í•  ì±„ë„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const evalMonth = document.getElementById('evalMonth').value;
    const teamleadId = document.getElementById('teamleadSelect').value;
    const teamleadName = document.getElementById('teamleadSelect').selectedOptions[0].text.split(' (')[0];
    
    if (!evalMonth || !teamleadId) {
        showNotification('í‰ê°€ì›”ê³¼ íŒ€ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    let hasError = false;
    
    sections.forEach(section => {
        const channelId = section.dataset.channelId;
        const channel = evaluationData.channels.find(c => c.id === channelId);
        const members = evaluationData.currentChannels[channelId];
        
        const channelComment = document.getElementById(`channelCommentText_${channelId}`)?.value || '';
        
        const channelEvaluation = {
            evalMonth: evalMonth,
            channelId: channelId,
            channelName: channel.name,
            channelComment: channelComment,
            evaluatorId: teamleadId,
            members: []
        };
        
        let totalContribution = 0;
        
        members.forEach(member => {
            const mmInput = document.getElementById(`mm_${channelId}_${member.id}`);
            const contribInput = document.getElementById(`contrib_${channelId}_${member.id}`);
            
            if (!mmInput || !contribInput) return;
            
            const mm = parseFloat(mmInput.value) || 0;
            const contribution = parseFloat(contribInput.value) || 0;
            
            const achievements = [];
            const achievementInputs = document.querySelectorAll(`#achievements_${channelId}_${member.id} input[type="text"]`);
            achievementInputs.forEach(input => {
                if (input.value.trim()) {
                    achievements.push(input.value.trim());
                }
            });
            
            const commentElement = document.getElementById(`comment1_${channelId}_${member.id}`);
            const comment = commentElement ? commentElement.value : '';
            
            totalContribution += contribution;
            
            channelEvaluation.members.push({
                id: member.id,
                name: member.name,
                teamName: member.teamName,
                mm: mm,
                contribution1: contribution,
                achievement: achievements.join('|'),
                comment1: comment
            });
        });
        
        if (Math.abs(totalContribution - 100) > 0.01) {
            showNotification(`${channel.name} ì±„ë„ì˜ ê¸°ì—¬ë„ í•©ê³„ê°€ 100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.`, 'error');
            hasError = true;
        }
        
        evaluations.push(channelEvaluation);
    });
    
    if (hasError) return;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            let savedCount = 0;
            
            evaluations.forEach(evaluation => {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            savedCount++;
                            if (savedCount === evaluations.length) {
                                showNotification('ëª¨ë“  1ì°¨ í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                                showLoading(false);
                                checkExistingEvaluation();
                            }
                        } else {
                            showNotification(result.message, 'error');
                            showLoading(false);
                        }
                    })
                    .withFailureHandler(function(error) {
                        showNotification('ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
                        showLoading(false);
                    })
                    .saveFirstEvaluation(evaluation);
            });
        })
        .withFailureHandler(function(error) {
            showNotification('í‰ê°€ ì •ë³´ ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .saveEvaluationInfo(evalMonth, teamleadId, teamleadName, '1ì°¨ í‰ê°€ ì™„ë£Œ');
}

// ===== 2ì°¨ í‰ê°€ ê´€ë ¨ í•¨ìˆ˜ =====
function loadSecondEvaluation() {
    const evalMonth = document.getElementById('evalMonth2nd').value;
    if (!evalMonth) {
        showNotification('í‰ê°€ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    // ì„ íƒëœ íŒ€ í™•ì¸
    const selectedTeams = [];
    document.querySelectorAll('#managerContent .team-checkbox-area input[type="checkbox"]:checked').forEach(checkbox => {
        selectedTeams.push(checkbox.value);
    });
    
    if (selectedTeams.length === 0) {
        showNotification('í‰ê°€í•  íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    // ì„ íƒëœ íŒ€ ì €ì¥
    evaluationData.secondEvalTeamFilter = selectedTeams;
    
    showLoading(true);
    
    // 1ì°¨ í‰ê°€ì™€ 2ì°¨ í‰ê°€ ë°ì´í„° ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°
    Promise.all([
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getFirstEvaluationData(evalMonth);
        }),
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getSecondEvaluationData(evalMonth);
        })
    ]).then(([firstData, secondData]) => {
        // ì„ íƒëœ íŒ€ì˜ ë°ì´í„°ë§Œ í•„í„°ë§
        const filteredFirstData = {};
        const filteredSecondData = {};
        
        for (const channelId in firstData) {
            const channel = evaluationData.channels.find(c => c.id === channelId);
            if (channel && selectedTeams.includes(channel.teamId)) {
                filteredFirstData[channelId] = firstData[channelId];
            }
        }
        
        for (const channelId in secondData) {
            const channel = evaluationData.channels.find(c => c.id === channelId);
            if (channel && selectedTeams.includes(channel.teamId)) {
                filteredSecondData[channelId] = secondData[channelId];
            }
        }
        
        evaluationData.firstEvaluation = filteredFirstData;
        evaluationData.existingSecondEvaluation = filteredSecondData;
        
        displaySecondEvaluation();
        document.getElementById('sortChannelsBtn2nd').style.display = 'block';
        showLoading(false);
    }).catch(error => {
        showNotification('í‰ê°€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
        showLoading(false);
    });
}

function displaySecondEvaluation() {
    const area = document.getElementById('secondEvaluationArea');
    let html = '<h3>ğŸ“‹ ì„ íƒí•œ íŒ€ì˜ 1ì°¨ í‰ê°€ ê²°ê³¼ ê²€í†  ë° 2ì°¨ í‰ê°€</h3>';
    
    if (Object.keys(evaluationData.firstEvaluation).length === 0) {
        html += '<p>ì„ íƒí•œ íŒ€ì˜ 1ì°¨ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        area.innerHTML = html;
        document.getElementById('submitSecondEvalBtn').style.display = 'none';
        return;
    }

    document.getElementById('submitSecondEvalBtn').style.display = 'block';
    
    const channelsByTeam = {};
    for (const channelId in evaluationData.firstEvaluation) {
        const channel = evaluationData.channels.find(c => c.id === channelId);
        if (channel) {
            const teamId = channel.teamId;
            if (!channelsByTeam[teamId]) {
                channelsByTeam[teamId] = [];
            }
            channelsByTeam[teamId].push({
                channelId: channelId,
                channelData: evaluationData.firstEvaluation[channelId]
            });
        }
    }
    
    evaluationData.secondEvalTeamFilter = evaluationData.secondEvalTeamFilter || Object.keys(channelsByTeam);
    
    for (const teamId of evaluationData.secondEvalTeamFilter) {
        if (!channelsByTeam[teamId]) continue;
        
        const teamName = evaluationData.teams[teamId]?.name || teamId;
        
        html += `
            <div class="team-group-section second-eval" data-team-id="${teamId}">
                <h3 style="color: #1a73e8;">ğŸ“ ${teamName}</h3>
        `;
        
        channelsByTeam[teamId].forEach(({ channelId, channelData }) => {
            // ê¸°ì¡´ 2ì°¨ í‰ê°€ ë°ì´í„° í™•ì¸
            const existingSecondEval = evaluationData.existingSecondEvaluation?.[channelId];
            
            // MM ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
            channelData.members.sort((a, b) => (b.mm || 0) - (a.mm || 0));
            
            let totalMM = 0;
            let totalContrib1 = 0;
            channelData.members.forEach(member => {
                totalMM += parseFloat(member.mm) || 0;
                totalContrib1 += parseFloat(member.contribution1) || 0;
            });
            
            html += `
                <div class="summary-box">
                    <h4>${channelData.channelName}</h4>
                    ${channelData.channelComment ? `
                        <button class="channel-comment-toggle" onclick="toggleSecondEvalChannelComment('${channelId}')">
                            ğŸ“ ì±„ë„ ì½”ë©˜íŠ¸ ë³´ê¸°
                        </button>
                        <div id="secondEvalChannelComment_${channelId}" style="display: none; background: #272727; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #3f3f3f;">
                            <p style="color: #f1f1f1;"><strong>ì±„ë„ ì½”ë©˜íŠ¸:</strong> ${channelData.channelComment}</p>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                        <div class="summary-item">
                            <span class="summary-label">íˆ¬ì… MM í•©ê³„:</span>
                            <span class="summary-value">${totalMM.toFixed(1)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">1ì°¨ ê¸°ì—¬ë„ í•©ê³„:</span>
                            <span class="summary-value percentage">${totalContrib1}%</span>
                        </div>
                    </div>
                    
                    <div class="contribution-progress">
                        <div class="summary-item">
                            <span class="summary-label">2ì°¨ ê¸°ì—¬ë„ í•©ê³„:</span>
                            <span class="summary-value percentage" id="totalContrib2_${channelId}">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="contrib2Bar_${channelId}" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <table class="evaluation-table">
                        <thead>
                            <tr>
                                <th>íŒ€ì›ëª…</th>
                                <th>ì†Œì†íŒ€</th>
                                <th>íˆ¬ì… MM</th>
                                <th>1ì°¨ ê¸°ì—¬ë„</th>
                                <th>2ì°¨ ê¸°ì—¬ë„(%)</th>
                                <th>ìƒì„¸ì •ë³´</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            channelData.members.forEach(member => {
                // ê¸°ì¡´ 2ì°¨ í‰ê°€ ë°ì´í„°ì—ì„œ í•´ë‹¹ ë©¤ë²„ì˜ ê¸°ì—¬ë„ ì°¾ê¸°
                let contribution2Value = member.contribution1; // ê¸°ë³¸ê°’ì€ 1ì°¨ ê¸°ì—¬ë„
                let comment2Value = '';
                
                if (existingSecondEval && existingSecondEval.members) {
                    const existingMember = existingSecondEval.members.find(m => m.id === member.id);
                    if (existingMember) {
                        contribution2Value = existingMember.contribution2;
                        comment2Value = existingMember.comment2 || '';
                    }
                }
                
                html += `
                    <tr>
                        <td>${member.name}</td>
                        <td>${member.teamName}</td>
                        <td>${member.mm}</td>
                        <td class="percentage">${member.contribution1}%</td>
                        <td><input type="number" id="contrib2_${channelId}_${member.id}" step="1" min="0" max="100" value="${contribution2Value}" onchange="updateContrib2Total('${channelId}')"></td>
                        <td><button class="detail-btn" onclick="toggleDetail2('${channelId}_${member.id}')">+</button></td>
                    </tr>
                    <tr>
                        <td colspan="6">
                            <div id="detail2_${channelId}_${member.id}" class="detail-panel">
                                <strong>ê°œì¸ë³„ í•µì‹¬ ì„±ê³¼:</strong>
                                <div class="achievement-display">${formatAchievements(member.achievement) || 'ì—†ìŒ'}</div>
                                <strong>1ì°¨ ì½”ë©˜íŠ¸:</strong>
                                <p>${member.comment1 || 'ì—†ìŒ'}</p>
                                <strong>ğŸ“ 2ì°¨ ì½”ë©˜íŠ¸:</strong>
                                <textarea id="comment2_${channelId}_${member.id}" placeholder="2ì°¨ í‰ê°€ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">${comment2Value}</textarea>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
        });
        
        html += '</div>';
    }
    
    area.innerHTML = html;
    
    // ì´ˆê¸° í•©ê³„ ê³„ì‚°
    for (const channelId in evaluationData.firstEvaluation) {
        updateContrib2Total(channelId);
    }
}

function applySecondEvalTeamFilter() {
    const selectedTeams = [];
    document.querySelectorAll('#secondEvalTeamFilter input[type="checkbox"]:checked').forEach(checkbox => {
        selectedTeams.push(checkbox.value);
    });
    
    if (selectedTeams.length === 0) {
        showNotification('ìµœì†Œ í•˜ë‚˜ì˜ íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    evaluationData.secondEvalTeamFilter = selectedTeams;
    displaySecondEvaluation();
}

function toggleSecondEvalChannelComment(channelId) {
    const commentDiv = document.getElementById(`secondEvalChannelComment_${channelId}`);
    const button = event.target;
    
    if (commentDiv.style.display === 'none') {
        commentDiv.style.display = 'block';
        button.textContent = 'ğŸ“ ì±„ë„ ì½”ë©˜íŠ¸ ë‹«ê¸°';
    } else {
        commentDiv.style.display = 'none';
        button.textContent = 'ğŸ“ ì±„ë„ ì½”ë©˜íŠ¸ ë³´ê¸°';
    }
}

function updateContrib2Total(channelId) {
    const channelEval = evaluationData.firstEvaluation[channelId];
    let total = 0;
    
    channelEval.members.forEach(member => {
        const contrib2Input = document.getElementById(`contrib2_${channelId}_${member.id}`);
        if (contrib2Input) {
            // ë¹ˆ ê°’ì´ë‚˜ 0ë„ ì •í™•íˆ ì²˜ë¦¬
            const value = contrib2Input.value;
            if (value !== '') {
                total += parseFloat(value) || 0;
            }
        }
    });
    
    const totalElement = document.getElementById(`totalContrib2_${channelId}`);
    const progressBar = document.getElementById(`contrib2Bar_${channelId}`);
    
    if (totalElement) {
        totalElement.textContent = `${total}%`;
        totalElement.style.color = (total === 100) ? '#27ae60' : (total > 100) ? '#e74c3c' : '#3498db';
    }
    
    if (progressBar) {
        const width = Math.min(total, 100);
        progressBar.style.width = `${width}%`;
        progressBar.textContent = `${total}%`;
        
        if (total === 100) {
            progressBar.classList.add('complete');
            progressBar.classList.remove('over');
        } else if (total > 100) {
            progressBar.classList.add('over');
            progressBar.classList.remove('complete');
        } else {
            progressBar.classList.remove('complete', 'over');
        }
    }
}

function toggleDetail2(id) {
    const detailPanel = document.getElementById(`detail2_${id}`);
    detailPanel.classList.toggle('show');
}

function submitSecondEvaluationSelective() {
    console.log('=== 2ì°¨ í‰ê°€ ì €ì¥ ë””ë²„ê¹… ì‹œì‘ ===');
    
    const evalMonth = document.getElementById('evalMonth2nd').value;
    if (!evalMonth) {
        showNotification('í‰ê°€ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    // ë¨¼ì € í™”ë©´ì— í‘œì‹œëœ ëª¨ë“  ê°’ í™•ì¸
    console.log('--- í™”ë©´ì— ì…ë ¥ëœ ê°’ í™•ì¸ ---');
    const allInputs = document.querySelectorAll('input[id^="contrib2_"]');
    allInputs.forEach(input => {
        console.log(`${input.id}: value="${input.value}", type=${typeof input.value}`);
    });
    
    const secondEvalData = {
        evalMonth: evalMonth,
        channels: {}
    };
    
    // ë°ì´í„° ìˆ˜ì§‘ ë° ê²€ì¦
    let hasValidData = false;
    let hasError = false;
    
    // í™”ë©´ì— í‘œì‹œëœ ì±„ë„ë“¤ë§Œ ì²˜ë¦¬
    const displayedChannels = document.querySelectorAll('#secondEvaluationArea .summary-box');
    
    displayedChannels.forEach(channelElement => {
        // ì±„ë„ ë‚´ì˜ ëª¨ë“  2ì°¨ ê¸°ì—¬ë„ ì…ë ¥ ì°¾ê¸°
        const channelInputs = channelElement.querySelectorAll('input[id^="contrib2_"]');
        if (channelInputs.length === 0) return;
        
        // ì²« ë²ˆì§¸ ì…ë ¥ì—ì„œ ì±„ë„ ID ì¶”ì¶œ
        const firstInputId = channelInputs[0].id;
        const channelId = firstInputId.split('_')[1];
        
        console.log(`\n--- ì±„ë„ ${channelId} ì²˜ë¦¬ ì¤‘ ---`);
        
        const channelEval = evaluationData.firstEvaluation[channelId];
        if (!channelEval) {
            console.error(`ì±„ë„ ${channelId}ì˜ 1ì°¨ í‰ê°€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
            return;
        }
        
        const channel = evaluationData.channels.find(c => c.id === channelId);
        
        // íŒ€ í•„í„° í™•ì¸
        if (evaluationData.secondEvalTeamFilter && 
            !evaluationData.secondEvalTeamFilter.includes(channel.teamId)) {
            console.log(`ì±„ë„ ${channelId}ëŠ” íŒ€ í•„í„°ì— ì˜í•´ ì œì™¸ë¨`);
            return;
        }
        
        const secondChannelEval = {
            channelId: channelId,
            channelName: channelEval.channelName,
            channelComment: channelEval.channelComment || '',
            members: []
        };
        
        let totalContribution = 0;
        
        // ê° ì…ë ¥ í•„ë“œ ì²˜ë¦¬
        channelInputs.forEach(input => {
            const parts = input.id.split('_');
            const memberId = parts[2];
            
            const member = channelEval.members.find(m => m.id === memberId);
            if (!member) {
                console.error(`ë©¤ë²„ ${memberId}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                return;
            }
            
            // ì‹¤ì œ ì…ë ¥ê°’ í™•ì¸
            const inputValue = input.value;
            let contribution2 = parseFloat(inputValue);
            
            // NaN ì²´í¬
            if (isNaN(contribution2)) {
                contribution2 = 0;
            }
            
            console.log(`${member.name} (${memberId}): 
                ì…ë ¥ê°’="${inputValue}", 
                íŒŒì‹±í›„=${contribution2}, 
                1ì°¨ê¸°ì—¬ë„=${member.contribution1}`);
            
            const comment2Element = document.getElementById(`comment2_${channelId}_${memberId}`);
            const comment2 = comment2Element ? comment2Element.value : '';
            
            totalContribution += contribution2;
            
            secondChannelEval.members.push({
                id: member.id,
                name: member.name,
                teamName: member.teamName,
                mm: member.mm,
                contribution1: member.contribution1,
                contribution2: contribution2, // í™”ë©´ì˜ ì…ë ¥ê°’ ì‚¬ìš©
                achievement: member.achievement,
                comment1: member.comment1,
                comment2: comment2
            });
            
            hasValidData = true;
        });
        
        console.log(`${channelEval.channelName} ì±„ë„ ê¸°ì—¬ë„ í•©ê³„: ${totalContribution}%`);
        
        if (Math.abs(totalContribution - 100) > 0.01) {
            showNotification(`${channelEval.channelName} ì±„ë„ì˜ 2ì°¨ ê¸°ì—¬ë„ í•©ê³„ê°€ 100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬: ${totalContribution}%)`, 'error');
            hasError = true;
        }
        
        if (secondChannelEval.members.length > 0) {
            secondEvalData.channels[channelId] = secondChannelEval;
        }
    });
    
    if (!hasValidData) {
        showNotification('ì €ì¥í•  í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    if (hasError) {
        return;
    }
    
    const channelCount = Object.keys(secondEvalData.channels).length;
    if (channelCount === 0) {
        showNotification('ì„ íƒëœ íŒ€ì˜ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    console.log('=== ìµœì¢… ì €ì¥ ë°ì´í„° ===');
    console.log(JSON.stringify(secondEvalData, null, 2));
    
    // ë°ì´í„° í•œ ë²ˆ ë” ê²€ì¦
    for (const channelId in secondEvalData.channels) {
        const channel = secondEvalData.channels[channelId];
        console.log(`\n${channel.channelName}:`);
        channel.members.forEach(m => {
            console.log(`  ${m.name}: 2ì°¨=${m.contribution2}%`);
        });
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification(`${channelCount}ê°œ ì±„ë„ì˜ 2ì°¨ í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                evaluationData.secondEvaluation = secondEvalData;
            } else {
                showNotification(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .saveSecondEvaluation(secondEvalData);
}

// ===== ìµœì¢… í‰ê°€ ê´€ë ¨ í•¨ìˆ˜ =====
function loadFinalEvaluation() {
    const evalMonth = document.getElementById('evalMonthFinal').value;
    if (!evalMonth) {
        showNotification('í‰ê°€ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    // ì„ íƒëœ íŒ€ í™•ì¸
    const selectedTeams = [];
    document.querySelectorAll('#executiveContent .team-checkbox-area input[type="checkbox"]:checked').forEach(checkbox => {
        selectedTeams.push(checkbox.value);
    });
    
    if (selectedTeams.length === 0) {
        showNotification('í‰ê°€í•  íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    // ì„ íƒëœ íŒ€ ì €ì¥
    evaluationData.finalEvalTeamFilter = selectedTeams;
    
    showLoading(true);
    
    Promise.all([
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getFinalEvaluationDetailData(evalMonth);
        }),
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getExistingFinalEvaluation(evalMonth);
        })
    ]).then(([secondEvalData, existingFinalData]) => {
        // ì„ íƒëœ íŒ€ì˜ ë°ì´í„°ë§Œ í•„í„°ë§
        const filteredSecondEval = {};
        const filteredFinalEval = {};
        
        for (const channelId in secondEvalData) {
            const channel = evaluationData.channels.find(c => c.id === channelId);
            if (channel && selectedTeams.includes(channel.teamId)) {
                filteredSecondEval[channelId] = secondEvalData[channelId];
            }
        }
        
        for (const channelId in existingFinalData) {
            const channel = evaluationData.channels.find(c => c.id === channelId);
            if (channel && selectedTeams.includes(channel.teamId)) {
                filteredFinalEval[channelId] = existingFinalData[channelId];
            }
        }
        
        evaluationData.secondEvaluation = filteredSecondEval;
        evaluationData.existingFinalEvaluation = filteredFinalEval;
        
        displayFinalEvaluation();
        document.getElementById('sortChannelsBtnFinal').style.display = 'block';
        showLoading(false);
    }).catch(error => {
        showNotification('í‰ê°€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
        showLoading(false);
    });
}

function displayFinalEvaluation() {
    const area = document.getElementById('finalEvaluationArea');
    let html = '<h3>ğŸ’° ì„ íƒí•œ íŒ€ì˜ ìµœì¢… ì„±ê³¼ê¸ˆ ì±…ì •</h3>';
    
    if (Object.keys(evaluationData.secondEvaluation).length === 0) {
        html += '<p>ì„ íƒí•œ íŒ€ì˜ 2ì°¨ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        area.innerHTML = html;
        document.getElementById('submitFinalEvalBtn').style.display = 'none';
        return;
    }
    
    document.getElementById('submitFinalEvalBtn').style.display = 'block';
    
    // ì„ì‹œ ì €ì¥ëœ ê¸ˆì•¡ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì¤‘ì²© ë¡œë”© ë°©ì§€ - ì´ë¯¸ loadFinalEvaluationì—ì„œ ë¡œë”© ì¤‘)
    const evalMonth = document.getElementById('evalMonthFinal').value;
    // showLoading(true); // ì œê±°: ì´ë¯¸ ìƒìœ„ í•¨ìˆ˜ì—ì„œ ë¡œë”© ì¤‘
    
    google.script.run
        .withSuccessHandler(function(tempAmounts) {
            evaluationData.tempChannelAmounts = tempAmounts;
            
            evaluationData.finalEvaluation = { channels: {} };
            
            const channelsByTeam = {};
            const teamLeaderAmounts = {};
            
            for (const channelId in evaluationData.secondEvaluation) {
                const channel = evaluationData.channels.find(c => c.id === channelId);
                if (channel) {
                    const teamId = channel.teamId;
                    if (!channelsByTeam[teamId]) {
                        channelsByTeam[teamId] = [];
                        teamLeaderAmounts[teamId] = 0;
                    }
                    channelsByTeam[teamId].push({
                        channelId: channelId,
                        channelData: evaluationData.secondEvaluation[channelId]
                    });
                }
            }
            
            evaluationData.finalEvalTeamFilter = evaluationData.finalEvalTeamFilter || Object.keys(channelsByTeam);
            
            for (const teamId of evaluationData.finalEvalTeamFilter) {
                if (!channelsByTeam[teamId]) continue;
                
                const teamName = evaluationData.teams[teamId]?.name || teamId;
                
                html += `
                    <div class="team-group-section final-eval" data-team-id="${teamId}">
                        <h3>
                            <span style="color: #27ae60;">ğŸ’¼ ${teamName}</span>
                            <span class="team-leader-amount-summary" id="teamLeaderSum_${teamId}">íŒ€ì¥ ì„±ê³¼ê¸ˆ í•©ê³„: 0ë§Œì›</span>
                        </h3>
                `;
                
                channelsByTeam[teamId].forEach(({ channelId, channelData }) => {
                    // MM ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
                    channelData.members.sort((a, b) => (b.mm || 0) - (a.mm || 0));
                    
                    let totalMM = 0;
                    channelData.members.forEach(member => {
                        totalMM += parseFloat(member.mm) || 0;
                    });
                    
                    const existingFinal = evaluationData.existingFinalEvaluation?.[channelId] || {};
                    const tempAmount = tempAmounts[channelId] || {};
                    
                    evaluationData.finalEvaluation.channels[channelId] = {
                        channelName: channelData.channelName,
                        channelComment: channelData.channelComment || '',
                        members: channelData.members,
                        totalAmount: tempAmount.totalAmount ? tempAmount.totalAmount / 10000 : 
                                   (existingFinal.totalAmount ? existingFinal.totalAmount / 10000 : 0),
                        leaderPercentage: tempAmount.leaderPercentage || existingFinal.leaderPercentage || 0,
                        teamId: teamId
                    };
                    
                    html += `
                        <div class="summary-box" style="margin-bottom: 30px;">
                            <h4>${channelData.channelName}</h4>
                            
                            <!-- ì±„ë„ ì½”ë©˜íŠ¸ ë¶€ë¶„ ë³µì› -->
                            ${channelData.channelComment ? `
                                <div style="background: #272727; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #3f3f3f;">
                                    <button class="btn btn-primary" style="padding: 5px 15px; font-size: 14px; margin-bottom: 10px;" onclick="toggleChannelDetail('${channelId}')">
                                        <span id="channelDetailToggle_${channelId}">ğŸ“‹ ì±„ë„ ìƒì„¸ì •ë³´ ë³´ê¸°</span>
                                    </button>
                                    <div id="channelDetail_${channelId}" class="channel-detail-box" style="display: none;">
                                        <p><strong>ì±„ë„ ì½”ë©˜íŠ¸:</strong> ${channelData.channelComment}</p>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- ê¸ˆì•¡ ì…ë ¥ ë¶€ë¶„ - ì»´íŒ©íŠ¸ ë²„ì „ -->
                            <div style="background: #212121; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <!-- 1ì°¨ ì„±ê³¼ê¸ˆ -->
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="font-size: 18px; font-weight: bold; white-space: nowrap;">
                                            ğŸ’° 1ì°¨ ì„±ê³¼ê¸ˆ(ë§Œì›):
                                        </label>
                                        <input type="number" id="total_${channelId}" placeholder="0" 
                                              value="${evaluationData.finalEvaluation.channels[channelId].totalAmount}" 
                                              onchange="calculateDistribution('${channelId}')" 
                                              style="width: 100px; padding: 5px;">
                                    </div>
                                    
                                    <!-- íŒ€ì¥ % -->
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="font-size: 18px; font-weight: bold; white-space: nowrap;">
                                            ğŸ‘” íŒ€ì¥(%):
                                        </label>
                                        <input type="number" id="leader_${channelId}" placeholder="0" min="0" max="100" 
                                              value="${evaluationData.finalEvaluation.channels[channelId].leaderPercentage}" 
                                              onchange="calculateDistribution('${channelId}')" 
                                              style="width: 60px; padding: 5px;">
                                    </div>
                                    
                                    <!-- ë²„íŠ¼ -->
                                    <button class="btn btn-primary" onclick="saveChannelAmountOnly('${channelId}')" 
                                            style="padding: 5px 18px; font-size: 18px;">
                                        ğŸ’¾ ê¸ˆì•¡ ì €ì¥
                                    </button>
                                    
                                    <!-- ìƒíƒœ -->
                                    <span id="saveStatus_${channelId}" style="font-size: 12px; color: #666;">
                                    </span>
                                    
                                    <!-- íŒ€ì¥ ì„±ê³¼ê¸ˆ (ì˜¤ë¥¸ìª½ ë) -->
                                    <div style="flex: 1; text-align: right;">
                                        <span id="leaderAmount_${channelId}" 
                                              style="display: inline-block;
                                                    font-weight: bold !important; 
                                                    color: #1a73e8 !important; 
                                                    font-size: 16px;
                                                    background: rgba(26, 115, 232, 0.1);
                                                    border: 2px solid #1a73e8;
                                                    border-radius: 20px;
                                                    padding: 6px 18px;
                                                    animation: pulse 2s infinite;
                                                    box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.4);">
                                            íŒ€ì¥ ì„±ê³¼ê¸ˆ: 0ë§Œì›
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- MM í•©ê³„ ë° ë°°ë¶„ ëŒ€ìƒ -->
                            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                                <div class="summary-item" style="flex: 1;">
                                    <span class="summary-label">íˆ¬ì… MM í•©ê³„:</span>
                                    <span class="summary-value">${totalMM.toFixed(1)}</span>
                                </div>
                                <div class="summary-item" style="flex: 1;">
                                    <span class="summary-label">2ì°¨ ì„±ê³¼ê¸ˆ(ë°°ë¶„ëŒ€ìƒ):</span>
                                    <span class="summary-value amount" id="dist_${channelId}" style="font-size: 20px;">0ë§Œì›</span>
                                </div>
                            </div>
                            
                            <div class="final-eval-progress">
                                <label>ğŸ’¸ ì„±ê³¼ê¸ˆ ë¶„ë°° í˜„í™©:</label>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress_${channelId}" style="width: 0%">0%</div>
                                </div>
                                <div id="overDistribution_${channelId}" style="color: #e74c3c; font-weight: bold; margin-top: 5px; display: none;">
                                    âš ï¸ ë¶„ë°° ê¸ˆì•¡ì´ ë°°ë¶„ ëŒ€ìƒì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!
                                </div>
                            </div>
                            
                            <table class="evaluation-table">
                                <thead>
                                    <tr>
                                        <th>íŒ€</th>
                                        <th>íŒ€ì›ëª…</th>
                                        <th>íˆ¬ì… MM</th>
                                        <th>1ì°¨ ê¸°ì—¬ë„</th>
                                        <th>2ì°¨ ê¸°ì—¬ë„</th>
                                        <th>ê¸°ì—¬ë„ ì„±ê³¼ê¸ˆ</th>
                                        <th>ì‹¤ì§€ê¸‰ ì„±ê³¼ê¸ˆ</th>
                                        <th>ìƒì„¸ì •ë³´</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    channelData.members.forEach(member => {
                        const contribution1 = member.contribution1 || 0;
                        const contribution2 = member.contribution2 || 0;
                        const contributionChanged = contribution1 !== contribution2;
                        
                        const finalAmount = existingFinal.members && existingFinal.members[member.id] ? 
                            existingFinal.members[member.id] / 10000 : 0;
                        
                        html += `
                            <tr>
                                <td>${member.teamName}</td>
                                <td>${member.name}</td>
                                <td>${member.mm}</td>
                                <td class="percentage ${contributionChanged ? 'contribution-changed' : ''}">${contribution1}%</td>
                                <td class="percentage ${contributionChanged ? 'contribution-changed' : ''}">${contribution2}%</td>
                                <td class="amount" id="calc_${channelId}_${member.id}">0ë§Œì›</td>
                                <td>
                                    <input type="number" id="final_${channelId}_${member.id}" 
                                          placeholder="0" value="${finalAmount}" 
                                          onchange="updateDistributionBar('${channelId}')" 
                                          style="width: 100px;"> ë§Œì›
                                </td>
                                <td><button class="detail-btn" onclick="toggleFinalDetail('${channelId}_${member.id}')">+</button></td>
                            </tr>
                            <tr id="detail_row_${channelId}_${member.id}" style="display: none;">
                                <td colspan="8">
                                    <div id="finalDetail_${channelId}_${member.id}" class="detail-panel show">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                            <div>
                                                <strong>ğŸ† ê°œì¸ë³„ í•µì‹¬ ì„±ê³¼:</strong>
                                                <div class="achievement-display" style="background: #272727; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                                    ${formatAchievements(member.achievement) || 'ì—†ìŒ'}
                                                </div>
                                            </div>
                                            <div>
                                                <strong>ğŸ’¬ 1ì°¨ ì½”ë©˜íŠ¸:</strong>
                                                <p style="background: #272727; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                                    ${member.comment1 || 'ì—†ìŒ'}
                                                </p>
                                            </div>
                                            <div style="grid-column: 1 / -1;">
                                                <strong>ğŸ“ 2ì°¨ ì½”ë©˜íŠ¸:</strong>
                                                <p style="background: #272727; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                                    ${member.comment2 || 'ì—†ìŒ'}
                                                </p>
                                            </div>
                                            <div style="grid-column: 1 / -1;">
                                                <strong>âœï¸ 3ì°¨ ì½”ë©˜íŠ¸ (ìµœì¢…):</strong>
                                                <textarea id="finalComment_${channelId}_${member.id}" 
                                                          placeholder="ìµœì¢… í‰ê°€ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                                                          style="width: 100%; min-height: 80px; margin-top: 5px; 
                                                                background: #0f0f0f; color: #f1f1f1; 
                                                                border: 1px solid #3f3f3f; padding: 10px; 
                                                                border-radius: 4px;"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            area.innerHTML = html;
            
            // ì´ˆê¸° ê³„ì‚°
            for (const channelId in evaluationData.finalEvaluation.channels) {
                if (evaluationData.finalEvaluation.channels[channelId].totalAmount > 0) {
                    calculateDistribution(channelId);
                }
            }
            
            // showLoading(false); // ì œê±°: ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬
        })
        .withFailureHandler(function(error) {
            console.error('ì„ì‹œ ì €ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            // showLoading(false); // ì œê±°: ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬
        })
        .getTempChannelAmounts(evalMonth);
}


 // ì´ˆê¸° ê³„ì‚°
    for (const channelId in evaluationData.finalEvaluation.channels) {
        if (evaluationData.finalEvaluation.channels[channelId].totalAmount > 0) {
            calculateDistribution(channelId);
        }
    }




function applyFinalEvalTeamFilter() {
    const selectedTeams = [];
    document.querySelectorAll('#finalEvalTeamFilter input[type="checkbox"]:checked').forEach(checkbox => {
        selectedTeams.push(checkbox.value);
    });
    
    if (selectedTeams.length === 0) {
        showNotification('ìµœì†Œ í•˜ë‚˜ì˜ íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    evaluationData.finalEvalTeamFilter = selectedTeams;
    displayFinalEvaluation();
}

function toggleChannelDetail(channelId) {
    const detailDiv = document.getElementById(`channelDetail_${channelId}`);
    const toggleBtn = document.getElementById(`channelDetailToggle_${channelId}`);
    
    if (detailDiv.style.display === 'none') {
        detailDiv.style.display = 'block';
        toggleBtn.textContent = 'ğŸ“‹ ì±„ë„ ìƒì„¸ì •ë³´ ë‹«ê¸°';
    } else {
        detailDiv.style.display = 'none';
        toggleBtn.textContent = 'ğŸ“‹ ì±„ë„ ìƒì„¸ì •ë³´ ë³´ê¸°';
    }
}

function toggleFinalDetail(id) {
    const detailRow = document.getElementById(`detail_row_${id}`);
    const detailPanel = document.getElementById(`finalDetail_${id}`);
    const button = event.target;
    
    if (detailRow) {
        if (detailRow.style.display === 'none' || detailRow.style.display === '') {
            detailRow.style.display = 'table-row';
            if (button) button.textContent = '-';
        } else {
            detailRow.style.display = 'none';
            if (button) button.textContent = '+';
        }
    }
}

function calculateDistribution(channelId) {
    const totalAmountInManwon = parseFloat(document.getElementById(`total_${channelId}`).value) || 0;
    const leaderPercentage = parseFloat(document.getElementById(`leader_${channelId}`).value) || 0;
    
    const leaderAmountInManwon = totalAmountInManwon * leaderPercentage / 100;
    
    const leaderAmountDisplay = document.getElementById(`leaderAmount_${channelId}`);
    const formattedLeaderAmount = leaderAmountInManwon % 1 === 0 
        ? leaderAmountInManwon.toString() 
        : leaderAmountInManwon.toFixed(1);
    leaderAmountDisplay.textContent = `íŒ€ì¥ ì„±ê³¼ê¸ˆ: ${formattedLeaderAmount}ë§Œì›`;
    
    const distributionAmountInManwon = totalAmountInManwon * (100 - leaderPercentage) / 100;
    
    const formattedAmount = distributionAmountInManwon % 1 === 0 
        ? distributionAmountInManwon.toString() 
        : distributionAmountInManwon.toFixed(1);
    
    document.getElementById(`dist_${channelId}`).textContent = `${formattedAmount}ë§Œì›`;
    
    const channelData = evaluationData.finalEvaluation.channels[channelId];
    channelData.members.forEach(member => {
        const calcAmountInManwon = distributionAmountInManwon * member.contribution2 / 100;
        
        const formattedCalcAmount = calcAmountInManwon % 1 === 0 
            ? calcAmountInManwon.toString() 
            : calcAmountInManwon.toFixed(1);
        
        document.getElementById(`calc_${channelId}_${member.id}`).textContent = `${formattedCalcAmount}ë§Œì›`;
    });
    
    updateDistributionBar(channelId);
    
    const teamId = channelData.teamId;
    updateTeamLeaderSum(teamId);
}

function updateDistributionBar(channelId) {
    const totalAmountInManwon = parseFloat(document.getElementById(`total_${channelId}`).value) || 0;
    const leaderPercentage = parseFloat(document.getElementById(`leader_${channelId}`).value) || 0;
    const distributionAmountInManwon = totalAmountInManwon * (100 - leaderPercentage) / 100;
    
    if (distributionAmountInManwon === 0) return;
    
    let totalDistributedInManwon = 0;
    const channelData = evaluationData.finalEvaluation.channels[channelId];
    
    channelData.members.forEach(member => {
        const finalAmountInManwon = parseFloat(document.getElementById(`final_${channelId}_${member.id}`).value) || 0;
        totalDistributedInManwon += finalAmountInManwon;
    });
    
    const percentage = (totalDistributedInManwon / distributionAmountInManwon) * 100;
    const progressBar = document.getElementById(`progress_${channelId}`);
    const overDistributionWarning = document.getElementById(`overDistribution_${channelId}`);
    
    progressBar.style.width = `${Math.min(percentage, 100)}%`;
    progressBar.textContent = `${Math.round(percentage)}%`;
    
    if (percentage > 100) {
        progressBar.style.background = '#e74c3c';
        overDistributionWarning.style.display = 'block';
        
        const overAmount = totalDistributedInManwon - distributionAmountInManwon;
        const formattedOverAmount = overAmount % 1 === 0 
            ? overAmount.toString() 
            : overAmount.toFixed(1);
        
        overDistributionWarning.textContent = `âš ï¸ ${formattedOverAmount}ë§Œì› ì´ˆê³¼ ë¶„ë°°ë˜ì—ˆìŠµë‹ˆë‹¤!`;
    } else if (percentage === 100) {
        progressBar.style.background = 'linear-gradient(to right, #27ae60, #2ecc71)';
        overDistributionWarning.style.display = 'none';
    } else {
        progressBar.style.background = 'linear-gradient(to right, #3498db, #2980b9)';
        overDistributionWarning.style.display = 'none';
    }
}

function updateTeamLeaderSum(teamId) {
    let teamLeaderSum = 0;
    
    for (const channelId in evaluationData.finalEvaluation.channels) {
        const channel = evaluationData.finalEvaluation.channels[channelId];
        if (channel.teamId === teamId) {
            const totalAmount = parseFloat(document.getElementById(`total_${channelId}`).value) || 0;
            const leaderPercentage = parseFloat(document.getElementById(`leader_${channelId}`).value) || 0;
            teamLeaderSum += totalAmount * leaderPercentage / 100;
        }
    }
    
    const teamLeaderSumElement = document.getElementById(`teamLeaderSum_${teamId}`);
    if (teamLeaderSumElement) {
        const formattedSum = teamLeaderSum % 1 === 0 
            ? teamLeaderSum.toString() 
            : teamLeaderSum.toFixed(1);
        teamLeaderSumElement.textContent = `íŒ€ì¥ ì„±ê³¼ê¸ˆ í•©ê³„: ${formattedSum}ë§Œì›`;
    }
}

function submitFinalEvaluationSelective() {
    const evalMonth = document.getElementById('evalMonthFinal').value;
    const channelData = {
        evalMonth: evalMonth,
        channels: {}
    };
    
    // ì„ íƒëœ íŒ€ì˜ ì±„ë„ë§Œ ì²˜ë¦¬
    for (const channelId in evaluationData.finalEvaluation.channels) {
        const channelInfo = evaluationData.finalEvaluation.channels[channelId];
        
        // íŒ€ í•„í„° í™•ì¸
        if (evaluationData.finalEvalTeamFilter && 
            !evaluationData.finalEvalTeamFilter.includes(channelInfo.teamId)) {
            continue;
        }
        
        // ì±„ë„ ë°ì´í„° ìˆ˜ì§‘
        channelInfo.totalAmount = (parseFloat(document.getElementById(`total_${channelId}`).value) || 0) * 10000;
        channelInfo.leaderPercentage = parseFloat(document.getElementById(`leader_${channelId}`).value) || 0;
        
        // ë©¤ë²„ë³„ ë°ì´í„° ìˆ˜ì§‘
        channelInfo.members.forEach(member => {
            member.finalAmount = (parseFloat(document.getElementById(`final_${channelId}_${member.id}`).value) || 0) * 10000;
            
            // 3ì°¨ ì½”ë©˜íŠ¸ ìˆ˜ì§‘
            const finalCommentElement = document.getElementById(`finalComment_${channelId}_${member.id}`);
            member.finalComment = finalCommentElement ? finalCommentElement.value : '';
        });
        
        channelData.channels[channelId] = channelInfo;
    }
    
    if (Object.keys(channelData.channels).length === 0) {
        showNotification('ì €ì¥í•  í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification(result.message, 'success');
            } else {
                showNotification(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .saveFinalEvaluation(channelData);
}

// ===== ì „ì›” ë¹„êµ ê¸°ëŠ¥ =====
function loadComparisonData() {
    const year1 = document.getElementById('compareYear1').value;
    const month1Select = document.getElementById('compareMonth1Select').value;
    const year2 = document.getElementById('compareYear2').value;
    const month2Select = document.getElementById('compareMonth2Select').value;
    const selectedTeam = document.getElementById('compareTeamSelect').value; // ì¶”ê°€
    
    const month1 = `${year1}-${month1Select}`;
    const month2 = `${year2}-${month2Select}`;
    
    if (!month1 || !month2) {
        showNotification('ë¹„êµí•  ë‘ ë‹¬ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    showLoading(true);
    
    Promise.all([
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getComparisonData(month1, selectedTeam ? true : false);
        }),
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getComparisonData(month2, selectedTeam ? true : false);
        })
    ]).then(([data1, data2]) => {
        // ì„ íƒëœ íŒ€ì˜ ë°ì´í„°ë§Œ í•„í„°ë§
        if (selectedTeam) {
            const filtered1 = filterByTeam(data1, selectedTeam);
            const filtered2 = filterByTeam(data2, selectedTeam);
            displayComparison(month1, filtered1, month2, filtered2);
        } else {
            displayComparison(month1, data1, month2, data2);
        }
        showLoading(false);
    }).catch(error => {
        showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
        showLoading(false);
    });
}

function displayComparison(month1, data1, month2, data2) {
    const area = document.getElementById('comparisonArea');
    let html = `
        <h3>ğŸ“Š í‰ê°€ ë°ì´í„° ë¹„êµ ë¶„ì„</h3>
        <div class="comparison-summary">
            <div class="summary-item">
                <span class="summary-label">ë¹„êµ ê¸°ê°„:</span>
                <span class="summary-value">${month1} â†’ ${month2}</span>
            </div>
        </div>
    `;
    
    const allChannels = new Set([...Object.keys(data1.evaluations), ...Object.keys(data2.evaluations)]);
    
    allChannels.forEach(channelId => {
        const channel1 = data1.evaluations[channelId];
        const channel2 = data2.evaluations[channelId];
        
        if (!channel1 && !channel2) return;
        
        const channelName = channel1?.channelName || channel2?.channelName || channelId;
        
        html += `
            <div class="channel-comparison-section">
                <h4>${channelName}</h4>
        `;
        
        if (data1.finalEval[channelId] && data2.finalEval[channelId]) {
            const total1 = data1.finalEval[channelId].totalAmount / 10000;
            const total2 = data2.finalEval[channelId].totalAmount / 10000;
            const diff = total2 - total1;
            const diffPercent = total1 ? ((diff / total1) * 100).toFixed(1) : 0;
            
            const formatAmount = (amount) => {
                return amount % 1 === 0 ? amount.toString() : amount.toFixed(1);
            };
            
            html += `
                <div class="comparison-box">
                    <div class="comparison-item">
                        <span>ì´ ì„±ê³¼ê¸ˆ:</span>
                        <span>${month1}: ${formatAmount(total1)}ë§Œì›</span>
                        <span>${month2}: ${formatAmount(total2)}ë§Œì›</span>
                        <span class="${diff >= 0 ? 'positive-change' : 'negative-change'}">
                            ${diff >= 0 ? 'â–²' : 'â–¼'} ${formatAmount(Math.abs(diff))}ë§Œì› (${diffPercent}%)
                        </span>
                    </div>
                </div>
            `;
        }
        
        html += `
            <table class="evaluation-table">
                <thead>
                    <tr>
                        <th>íŒ€ì›ëª…</th>
                        <th>íŒ€</th>
                        <th>${month1} MM</th>
                        <th>${month2} MM</th>
                        <th>MM ë³€í™”</th>
                        <th>${month1} ê¸°ì—¬ë„</th>
                        <th>${month2} ê¸°ì—¬ë„</th>
                        <th>ê¸°ì—¬ë„ ë³€í™”</th>
                        <th>${month1} ì„±ê³¼ê¸ˆ</th>
                        <th>${month2} ì„±ê³¼ê¸ˆ</th>
                        <th>ì„±ê³¼ê¸ˆ ë³€í™”</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        const allMembers = new Map();
        
        if (channel1) {
            channel1.members.forEach(m => {
                allMembers.set(m.id, { 
                    name: m.name, 
                    teamName: m.teamName,
                    month1: m 
                });
            });
        }
        
        if (channel2) {
            channel2.members.forEach(m => {
                if (allMembers.has(m.id)) {
                    allMembers.get(m.id).month2 = m;
                } else {
                    allMembers.set(m.id, { 
                        name: m.name, 
                        teamName: m.teamName,
                        month2: m 
                    });
                }
            });
        }
        
        allMembers.forEach((memberData, memberId) => {
            const m1 = memberData.month1 || {};
            const m2 = memberData.month2 || {};
            
            const mm1 = m1.mm || 0;
            const mm2 = m2.mm || 0;
            const mmDiff = mm2 - mm1;
            
            const contrib1 = m1.contribution2 || m1.contribution1 || 0;
            const contrib2 = m2.contribution2 || m2.contribution1 || 0;
            const contribDiff = contrib2 - contrib1;
            
            const final1 = data1.finalEval[channelId]?.members[memberId] || 0;
            const final2 = data2.finalEval[channelId]?.members[memberId] || 0;
            const finalDiff = final2 - final1;
            
            const formatAmount = (amount) => {
                return amount % 1 === 0 ? amount.toString() : amount.toFixed(1);
            };
            
            html += `
                <tr>
                    <td>${memberData.name}</td>
                    <td>${memberData.teamName}</td>
                    <td>${mm1}</td>
                    <td>${mm2}</td>
                    <td class="${mmDiff >= 0 ? 'positive-change' : 'negative-change'}">
                        ${mmDiff >= 0 ? '+' : ''}${mmDiff.toFixed(1)}
                    </td>
                    <td>${contrib1}%</td>
                    <td>${contrib2}%</td>
                    <td class="${contribDiff >= 0 ? 'positive-change' : 'negative-change'}">
                        ${contribDiff >= 0 ? '+' : ''}${contribDiff}%
                    </td>
                    <td>${formatAmount(final1/10000)}ë§Œì›</td>
                    <td>${formatAmount(final2/10000)}ë§Œì›</td>
                    <td class="${finalDiff >= 0 ? 'positive-change' : 'negative-change'}">
                        ${finalDiff >= 0 ? '+' : ''}${formatAmount(finalDiff/10000)}ë§Œì›
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
            </div>
        `;
    });
    
    area.innerHTML = html;
}

// ===== í—¬í¼ í•¨ìˆ˜ë“¤ =====
function formatAchievements(achievementString) {
    if (!achievementString) return '';
    return achievementString.split('|').filter(a => a.trim()).join('\n');
}

// ===== í‰ê°€ì›” ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ =====
function updateEvalMonth() {
    const year = document.getElementById('evalYear').value;
    const month = document.getElementById('evalMonthSelect').value;
    document.getElementById('evalMonth').value = `${year}-${month}`;
    
    if (document.getElementById('teamleadSelect').value) {
        checkExistingEvaluation();
    }
}

function updateEvalMonth2nd() {
    const year = document.getElementById('evalYear2nd').value;
    const month = document.getElementById('evalMonthSelect2nd').value;
    document.getElementById('evalMonth2nd').value = `${year}-${month}`;
}

function updateEvalMonthFinal() {
    const year = document.getElementById('evalYearFinal').value;
    const month = document.getElementById('evalMonthSelectFinal').value;
    document.getElementById('evalMonthFinal').value = `${year}-${month}`;
    
    // í‰ê°€ ìƒíƒœ ìë™ ë¡œë“œ
    setTimeout(() => {
        loadEvaluationStatus();
    }, 100);
}

function updateCompareMonth1() {
    const year = document.getElementById('compareYear1').value;
    const month = document.getElementById('compareMonth1Select').value;
    window.compareMonth1 = `${year}-${month}`;
}

function updateCompareMonth2() {
    const year = document.getElementById('compareYear2').value;
    const month = document.getElementById('compareMonth2Select').value;
    window.compareMonth2 = `${year}-${month}`;
}

// ===== select ìš”ì†Œ ë‹¤í¬ëª¨ë“œ ì ìš© =====
document.addEventListener('DOMContentLoaded', function() {
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) {
                    if (node.tagName === 'SELECT') {
                        applyDarkModeToSelect(node);
                    } else if (node.querySelectorAll) {
                        const selects = node.querySelectorAll('select');
                        selects.forEach(select => applyDarkModeToSelect(select));
                    }
                }
            });
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
});

function applyDarkModeToSelect(select) {
    select.style.backgroundColor = '#0f0f0f';
    select.style.color = '#f1f1f1';
    select.style.border = '1px solid #3f3f3f';
    
    const options = select.querySelectorAll('option');
    options.forEach(option => {
        option.style.backgroundColor = '#0f0f0f';
        option.style.color = '#f1f1f1';
    });
}

// ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” =====
document.addEventListener('DOMContentLoaded', function() {
    // ë‹¨ì¶•í‚¤ ì•ˆë‚´ íˆ´íŒ
    const shortcutInfo = document.querySelector('.shortcut-info');
    if (shortcutInfo) {
        shortcutInfo.title = 'ë‹¨ì¶•í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë” ë¹ ë¥´ê²Œ ì‘ì—…í•˜ì„¸ìš”!';
    }
    
    // ìë™ ì €ì¥ ìƒíƒœ í‘œì‹œ ì´ˆê¸°í™”
    updateAutoSaveStatus('ëŒ€ê¸° ì¤‘');
});

// ===== ìë™ ì €ì¥ ìƒíƒœ ì—…ë°ì´íŠ¸ =====
function updateAutoSaveStatus(status) {
    const statusElement = document.getElementById('autoSaveStatus');
    if (!statusElement) return;
    
    switch(status) {
        case 'ì €ì¥ ì¤‘':
            statusElement.textContent = 'ìë™ ì €ì¥ ì¤‘...';
            statusElement.classList.add('saving');
            break;
        case 'ì™„ë£Œ':
            statusElement.textContent = 'ìë™ ì €ì¥ ì™„ë£Œ âœ“';
            statusElement.classList.remove('saving');
            setTimeout(() => {
                statusElement.textContent = 'ìë™ ì €ì¥: 5ë¶„ë§ˆë‹¤';
            }, 3000);
            break;
        default:
            statusElement.textContent = 'ìë™ ì €ì¥: 5ë¶„ë§ˆë‹¤';
            statusElement.classList.remove('saving');
    }
}

// ===== ì§„í–‰ë¥  í‘œì‹œ í—¬í¼ =====
function showProgress(show = true) {
    const container = document.getElementById('progressContainer');
    if (container) {
        container.style.display = show ? 'block' : 'none';
    }
}

function setProgress(percentage) {
    const bar = document.getElementById('progressBar');
    if (bar) {
        bar.style.width = `${percentage}%`;
        bar.setAttribute('data-progress', `${percentage}%`);
    }
}

// ===== ì¶©ëŒ ê°ì§€ ë° ì•Œë¦¼ =====
function handleConflict(conflictData) {
    const warningHtml = `
        <div class="conflict-warning">
            <div>
                <strong>ë™ì‹œ í¸ì§‘ ê°ì§€</strong><br>
                ${conflictData.lastUser}ë‹˜ì´ ${conflictData.lastModified}ì— ì´ ë°ì´í„°ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.<br>
                ê³„ì† ì§„í–‰í•˜ì‹œë ¤ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìµœì‹  ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.
            </div>
            <button class="btn btn-warning" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
    `;
    
    // í˜„ì¬ í™œì„± ì½˜í…ì¸  ì˜ì—­ ìƒë‹¨ì— ê²½ê³  í‘œì‹œ
    const activeContent = document.querySelector('.role-content.active');
    if (activeContent && !activeContent.querySelector('.conflict-warning')) {
        activeContent.insertAdjacentHTML('afterbegin', warningHtml);
    }
}

// ===== ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ =====
const performanceMonitor = {
    start(operation) {
        this[operation] = performance.now();
    },
    
    end(operation) {
        if (this[operation]) {
            const duration = performance.now() - this[operation];
            console.log(`${operation} ì†Œìš” ì‹œê°„: ${duration.toFixed(2)}ms`);
            
            // 3ì´ˆ ì´ìƒ ê±¸ë¦¬ë©´ ê²½ê³ 
            if (duration > 3000) {
                showNotification('ì²˜ë¦¬ ì‹œê°„ì´ ê¸¸ì–´ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'warning');
            }
        }
    }
};

// ===== ë°ì´í„° ê²€ì¦ ê°•í™” =====
function validateEvaluationData(data, type) {
    const errors = [];
    
    switch(type) {
        case 'first':
            // 1ì°¨ í‰ê°€ ê²€ì¦
            for (const channelId in data) {
                const channel = data[channelId];
                let totalMM = 0;
                let totalContribution = 0;
                
                channel.members.forEach(member => {
                    if (member.mm < 0 || member.mm > 1) {
                        errors.push(`${member.name}ì˜ MM ê°’ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (0-1 ì‚¬ì´ì—¬ì•¼ í•¨)`);
                    }
                    if (member.contribution1 < 0 || member.contribution1 > 100) {
                        errors.push(`${member.name}ì˜ ê¸°ì—¬ë„ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (0-100 ì‚¬ì´ì—¬ì•¼ í•¨)`);
                    }
                    totalMM += member.mm;
                    totalContribution += member.contribution1;
                });
                
                if (Math.abs(totalContribution - 100) > 0.01) {
                    errors.push(`${channel.channelName}ì˜ ê¸°ì—¬ë„ í•©ê³„ê°€ 100%ê°€ ì•„ë‹™ë‹ˆë‹¤`);
                }
            }
            break;
            
        case 'second':
            // 2ì°¨ í‰ê°€ ê²€ì¦
            for (const channelId in data.channels) {
                const channel = data.channels[channelId];
                let totalContribution = 0;
                
                channel.members.forEach(member => {
                    totalContribution += member.contribution2;
                });
                
                if (Math.abs(totalContribution - 100) > 0.01) {
                    errors.push(`${channel.channelName}ì˜ 2ì°¨ ê¸°ì—¬ë„ í•©ê³„ê°€ 100%ê°€ ì•„ë‹™ë‹ˆë‹¤`);
                }
            }
            break;
            
        case 'final':
            // ìµœì¢… í‰ê°€ ê²€ì¦
            for (const channelId in data.channels) {
                const channel = data.channels[channelId];
                
                if (channel.totalAmount < 0) {
                    errors.push(`${channel.channelName}ì˜ ì„±ê³¼ê¸ˆì´ ìŒìˆ˜ì…ë‹ˆë‹¤`);
                }
                if (channel.leaderPercentage < 0 || channel.leaderPercentage > 100) {
                    errors.push(`${channel.channelName}ì˜ íŒ€ì¥ ì„±ê³¼ìœ¨ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤`);
                }
                
                let totalDistributed = 0;
                channel.members.forEach(member => {
                    if (member.finalAmount < 0) {
                        errors.push(`${member.name}ì˜ ì„±ê³¼ê¸ˆì´ ìŒìˆ˜ì…ë‹ˆë‹¤`);
                    }
                    totalDistributed += member.finalAmount;
                });
                
                const expectedDistribution = channel.totalAmount * (100 - channel.leaderPercentage) / 100;
                if (Math.abs(totalDistributed - expectedDistribution) > expectedDistribution * 0.1) {
                    errors.push(`${channel.channelName}ì˜ ì„±ê³¼ê¸ˆ ë¶„ë°°ê°€ 10% ì´ìƒ ì°¨ì´ë‚©ë‹ˆë‹¤`);
                }
            }
            break;
    }
    
    return errors;
}

// ===== ì˜¤ë¥˜ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜ =====
function recoverFromError(error, operation) {
    console.error(`${operation} ì¤‘ ì˜¤ë¥˜ ë°œìƒ:`, error);
    
    // ìë™ ì €ì¥ëœ ë°ì´í„° ë³µêµ¬ ì‹œë„
    const savedData = localStorage.getItem(`autosave_${operation}`);
    if (savedData) {
        if (confirm('ìë™ ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
                const data = JSON.parse(savedData);
                // ë°ì´í„° ë³µêµ¬ ë¡œì§
                showNotification('ìë™ ì €ì¥ëœ ë°ì´í„°ë¥¼ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤.', 'success');
                return true;
            } catch (e) {
                console.error('ë°ì´í„° ë³µêµ¬ ì‹¤íŒ¨:', e);
            }
        }
    }
    
    return false;
}

// ===== ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ìë™ ì €ì¥ =====
function autoSaveToLocal(operation, data) {
    try {
        localStorage.setItem(`autosave_${operation}`, JSON.stringify(data));
        localStorage.setItem(`autosave_${operation}_time`, new Date().toISOString());
    } catch (e) {
        console.error('ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨:', e);
    }
}

// ===== ì…ë ¥ ë„ìš°ë¯¸ í•¨ìˆ˜ =====
function distributeEvenly(channelId) {
    const members = evaluationData.currentChannels[channelId];
    if (!members || members.length === 0) return;
    
    const evenContribution = Math.floor(100 / members.length);
    let remainder = 100 - (evenContribution * members.length);
    
    members.forEach((member, index) => {
        const contribInput = document.getElementById(`contrib_${channelId}_${member.id}`);
        if (contribInput) {
            // ë‚˜ë¨¸ì§€ë¥¼ ì²« ë²ˆì§¸ ë©¤ë²„ë“¤ì—ê²Œ ë°°ë¶„
            contribInput.value = evenContribution + (index < remainder ? 1 : 0);
        }
    });
    
    updateContributionBar(channelId);
    showNotification('ê¸°ì—¬ë„ë¥¼ ê· ë“± ë¶„ë°°í–ˆìŠµë‹ˆë‹¤.', 'success');
}

// ===== ìµœì¢… ì´ˆê¸°í™” =====
console.log('ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œ ê°œì„ ì‚¬í•­ ì ìš© ì™„ë£Œ');
console.log('- ë‹¨ì¶•í‚¤ ê¸°ëŠ¥ í™œì„±í™” (Ctrl+S, Esc)');
console.log('- ì´ì „ ë‹¬ ë°ì´í„° ë³µì‚¬ ê¸°ëŠ¥ ì¶”ê°€');
console.log('- ì„ íƒì  íŒ€ ì œì¶œ ê¸°ëŠ¥ í™œì„±í™”');
console.log('- ë™ì‹œ ì‘ì—… ì¶©ëŒ ë°©ì§€ ê¸°ëŠ¥ í™œì„±í™”');
console.log('- ìë™ ì €ì¥ ê¸°ëŠ¥ í™œì„±í™” (5ë¶„)');
console.log('- ì„±ëŠ¥ ìµœì í™” ì ìš©');

// ===== ì´ì „ë‹¬ ê³„ì‚° ë²„ê·¸ ìˆ˜ì • (copyFromPreviousMonth í•¨ìˆ˜) =====
function copyFromPreviousMonth() {
    const currentMonth = document.getElementById('evalMonth').value;
    if (!currentMonth) {
        showNotification('í˜„ì¬ í‰ê°€ì›”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    // ì´ì „ ë‹¬ ê³„ì‚° ìˆ˜ì •
    const [year, month] = currentMonth.split('-').map(n => parseInt(n));
    let previousYear = year;
    let previousMonth = month - 1;
    
    if (previousMonth === 0) {
        previousMonth = 12;
        previousYear = year - 1;
    }
    
    const previousMonthStr = `${previousYear}-${String(previousMonth).padStart(2, '0')}`;
    
    if (!confirm(`${previousMonthStr}ì˜ í‰ê°€ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    showLoading(true);
    
    // ì´ì „ ë‹¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.evaluations && Object.keys(result.evaluations).length > 0) {
                // í˜„ì¬ ì„ íƒëœ ì±„ë„ë“¤ì— ëŒ€í•´ ì´ì „ ë‹¬ ë°ì´í„° ì ìš©
                for (const channelId in result.evaluations) {
                    if (evaluationData.currentChannels[channelId]) {
                        const prevData = result.evaluations[channelId];
                        prevData.members.forEach(prevMember => {
                            // MM ê°’ ë³µì‚¬
                            const mmInput = document.getElementById(`mm_${channelId}_${prevMember.id}`);
                            if (mmInput) {
                                mmInput.value = prevMember.mm || '';
                            }
                            
                            // ê¸°ì—¬ë„ ë³µì‚¬
                            const contribInput = document.getElementById(`contrib_${channelId}_${prevMember.id}`);
                            if (contribInput) {
                                contribInput.value = prevMember.contribution1 || '';
                            }
                            
                            // ì„±ê³¼ ë³µì‚¬
                            const achievementContainer = document.getElementById(`achievements_${channelId}_${prevMember.id}`);
                            if (achievementContainer && prevMember.achievement) {
                                const achievements = prevMember.achievement.split('|');
                                achievementContainer.innerHTML = '';
                                achievements.forEach(achievement => {
                                    if (achievement.trim()) {
                                        const newItem = document.createElement('div');
                                        newItem.className = 'achievement-item';
                                        newItem.innerHTML = `
                                            <input type="text" placeholder="í•µì‹¬ ì„±ê³¼ ì…ë ¥" value="${achievement}">
                                            <button onclick="removeAchievement(this)" class="btn btn-danger" style="padding: 2px 8px; font-size: 12px;">âŒ</button>
                                        `;
                                        achievementContainer.appendChild(newItem);
                                    }
                                });
                            }
                            
                            // ì½”ë©˜íŠ¸ ë³µì‚¬
                            const commentElement = document.getElementById(`comment1_${channelId}_${prevMember.id}`);
                            if (commentElement && prevMember.comment1) {
                                commentElement.value = prevMember.comment1;
                            }
                        });
                        
                        // ì±„ë„ ì½”ë©˜íŠ¸ ë³µì‚¬
                        const channelCommentInput = document.getElementById(`channelCommentText_${channelId}`);
                        if (channelCommentInput && prevData.channelComment) {
                            channelCommentInput.value = prevData.channelComment;
                        }
                        
                        // í•©ê³„ ì—…ë°ì´íŠ¸
                        updateMMTotal(channelId);
                        updateContributionBar(channelId);
                    }
                }
                
                showNotification(`${previousMonthStr}ì˜ ë°ì´í„°ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.`, 'success');
            } else {
                showNotification(`${previousMonthStr}ì˜ í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì´ì „ ë‹¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getFirstEvaluationByTeamlead(previousMonthStr, evaluationData.currentTeamleadId);
}

// DocumentFragmentë¥¼ ì‚¬ìš©í•œ DOM ì¡°ì‘ ìµœì í™”
function displayChannelEvaluationOptimized(channelId, channelMembers, existingEval) {
    const fragment = document.createDocumentFragment();
    const wrapper = document.createElement('div');
    
    // HTML ë¬¸ìì—´ ëŒ€ì‹  í•œ ë²ˆì— ìƒì„±
    let html = generateChannelEvaluationHTML(channelId, channelMembers, existingEval);
    wrapper.innerHTML = html;
    
    // ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©
    wrapper.addEventListener('change', function(e) {
        if (e.target.matches(`[id^="mm_${channelId}"]`)) {
            updateMMTotalAndSort(channelId);
        } else if (e.target.matches(`[id^="contrib_${channelId}"]`)) {
            updateContributionBar(channelId);
        }
    });
    
    fragment.appendChild(wrapper.firstChild);
    document.getElementById('channelEvaluationsArea').appendChild(fragment);
}


// ìŠ¤í¬ë¡¤ ê¸°ë°˜ ì§€ì—° ë¡œë”©
function implementLazyLoading() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const channelId = entry.target.dataset.channelId;
                if (!entry.target.dataset.loaded) {
                    loadChannelDetails(channelId);
                    entry.target.dataset.loaded = 'true';
                }
            }
        });
    }, { threshold: 0.1 });
    
    document.querySelectorAll('.channel-evaluation-section').forEach(section => {
        observer.observe(section);
    });
}

// evaluation.jsì— ì¶”ê°€
function saveChannelAmountOnly(channelId) {
    const evalMonth = document.getElementById('evalMonthFinal').value;
    const totalAmount = parseFloat(document.getElementById(`total_${channelId}`).value) || 0;
    const leaderPercentage = parseFloat(document.getElementById(`leader_${channelId}`).value) || 0;
    
    if (totalAmount === 0) {
        showNotification('ì„±ê³¼ê¸ˆ ì´ì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const data = {
        evalMonth: evalMonth,
        channelId: channelId,
        totalAmount: totalAmount * 10000,
        leaderPercentage: leaderPercentage
    };
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification(`${channelId} ì±„ë„ì˜ ì„±ê³¼ê¸ˆ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                
                // ì €ì¥ ìƒíƒœ í‘œì‹œ
                const saveIndicator = document.getElementById(`saveStatus_${channelId}`);
                if (saveIndicator) {
                    saveIndicator.textContent = 'âœ… ì €ì¥ë¨';
                    saveIndicator.style.color = '#27ae60';
                }
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .saveChannelAmountTemp(data);
}


</script>
