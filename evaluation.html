<script>
// ===== 1ì°¨ í‰ê°€ ê´€ë ¨ í•¨ìˆ˜ =====
function checkExistingEvaluation() {
    const evalMonth = document.getElementById('evalMonth').value;
    const teamleadId = document.getElementById('teamleadSelect').value;
    
    if (!evalMonth || !teamleadId) {
        document.getElementById('evaluationModeArea').style.display = 'none';
        return;
    }
    
    evaluationData.currentEvalMonth = evalMonth;
    evaluationData.currentTeamleadId = teamleadId;
    
    showLoading(true);
    
    // í‰ê°€ ì •ë³´ í™•ì¸
    google.script.run
        .withSuccessHandler(function(evalInfo) {
            if (evalInfo) {
                // ê¸°ì¡´ í‰ê°€ ë°ì´í„° ë¡œë“œ
                google.script.run
                    .withSuccessHandler(function(result) {
                        evaluationData.currentEvalInfo = evalInfo;
                        evaluationData.existingEvaluations = result.evaluations;
                        evaluationData.selectedChannels = result.evaluatedChannels;
                        
                        displayExistingEvaluation(evalInfo, result.evaluatedChannels);
                        showLoading(false);
                    })
                    .withFailureHandler(function(error) {
                        showAlert('í‰ê°€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
                        showLoading(false);
                    })
                    .getFirstEvaluationByTeamlead(evalMonth, teamleadId);
            } else {
                // ì‹ ê·œ í‰ê°€
                evaluationData.evaluationMode = 'new';
                displayNewEvaluation();
                showLoading(false);
            }
        })
        .withFailureHandler(function(error) {
            showAlert('í‰ê°€ ì •ë³´ í™•ì¸ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getEvaluationInfo(evalMonth, teamleadId);
}

function displayExistingEvaluation(evalInfo, evaluatedChannels) {
    evaluationData.evaluationMode = 'view';
    
    document.getElementById('evaluationModeArea').style.display = 'block';
    document.getElementById('existingEvalInfo').style.display = 'block';
    document.getElementById('evaluationEditArea').style.display = 'none';
    document.getElementById('submitFirstEvalBtn').style.display = 'none';
    document.getElementById('channelEvaluationsArea').style.display = 'block';
    
    // í‰ê°€ ì •ë³´ í‘œì‹œ
    document.getElementById('lastModified').textContent = evalInfo.lastModified;
    
    // í‰ê°€ëœ ì±„ë„ ëª©ë¡
    const channelNames = evaluatedChannels.map(chId => {
        const channel = evaluationData.channels.find(c => c.id === chId);
        return channel ? channel.name : chId;
    });
    document.getElementById('evaluatedChannelsList').textContent = channelNames.join(', ');
    
    // ê¸°ì¡´ í‰ê°€ ë‚´ìš© í‘œì‹œ
    displayEvaluationReadOnly();
}

function displayNewEvaluation() {
    evaluationData.evaluationMode = 'new';
    
    document.getElementById('evaluationModeArea').style.display = 'block';
    document.getElementById('existingEvalInfo').style.display = 'none';
    document.getElementById('evaluationEditArea').style.display = 'block';
    document.getElementById('submitFirstEvalBtn').style.display = 'block';
    
    // ì´ˆê¸°í™”
    document.getElementById('channelEvaluationsArea').innerHTML = '';
    evaluationData.selectedChannels = [];
    evaluationData.currentChannels = {};
}

function displayEvaluationReadOnly() {
    const evaluationsArea = document.getElementById('channelEvaluationsArea');
    evaluationsArea.innerHTML = '';
    
    for (const channelId in evaluationData.existingEvaluations) {
        const channelEval = evaluationData.existingEvaluations[channelId];
        const html = displayChannelEvaluationReadOnly(channelId, channelEval);
        evaluationsArea.innerHTML += html;
    }
}

function displayChannelEvaluationReadOnly(channelId, channelEval) {
    let html = `
        <div class="channel-evaluation-section readonly-mode">
            <div class="channel-info-card">
                <h4>${channelEval.channelName}</h4>
                <p class="channel-members-count">íŒ€ì› ìˆ˜: ${channelEval.members.length}ëª…</p>
                ${channelEval.channelComment ? `<p style="color: #666; margin-top: 10px;"><strong>ì±„ë„ ì½”ë©˜íŠ¸:</strong> ${channelEval.channelComment}</p>` : ''}
            </div>
            
            <table class="evaluation-table">
                <thead>
                    <tr>
                        <th>íŒ€ì›ëª…</th>
                        <th>ì†Œì†íŒ€</th>
                        <th>íˆ¬ì… MM</th>
                        <th>1ì°¨ ê¸°ì—¬ë„(%)</th>
                        <th>í•µì‹¬ì„±ê³¼</th>
                        <th>1ì°¨ ì½”ë©˜íŠ¸</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    channelEval.members.forEach(member => {
        const achievements = member.achievement ? member.achievement.split('|').join(', ') : '';
        html += `
            <tr>
                <td>${member.name}</td>
                <td>${member.teamName}</td>
                <td>${member.mm}</td>
                <td class="percentage">${member.contribution1}%</td>
                <td>${achievements}</td>
                <td>${member.comment1 || ''}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    return html;
}

function enableEditMode() {
    evaluationData.evaluationMode = 'edit';
    
    document.getElementById('existingEvalInfo').style.display = 'none';
    document.getElementById('evaluationEditArea').style.display = 'block';
    document.getElementById('submitFirstEvalBtn').style.display = 'block';
    
    // ê¸°ì¡´ í‰ê°€ ì±„ë„ë“¤ì„ ë‹¤ì‹œ ë¡œë“œ
    const evaluationsArea = document.getElementById('channelEvaluationsArea');
    evaluationsArea.innerHTML = '';
    
    evaluationData.currentChannels = {};
    
    // ê¸°ì¡´ í‰ê°€ëœ ì±„ë„ë“¤ì„ í¸ì§‘ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë‹¤ì‹œ í‘œì‹œ
    for (const channelId in evaluationData.existingEvaluations) {
        const channelEval = evaluationData.existingEvaluations[channelId];
        evaluationData.currentChannels[channelId] = channelEval.members;
        
        const html = displayChannelEvaluation(channelId, channelEval.members, channelEval);
        evaluationsArea.innerHTML += html;
    }
}

function loadTeamChannels() {
    const selectedTeam = document.getElementById('evaluationTeamSelect').value;
    const channelsArea = document.getElementById('teamChannelsArea');
    const checkboxArea = document.getElementById('channelCheckboxArea');
    
    if (!selectedTeam) {
        channelsArea.style.display = 'none';
        return;
    }
    
    channelsArea.style.display = 'block';
    checkboxArea.innerHTML = '';
    
    const teamChannels = evaluationData.channels.filter(c => c.teamId === selectedTeam);
    
    teamChannels.forEach(channel => {
        const isChecked = evaluationData.selectedChannels.includes(channel.id);
        const item = document.createElement('div');
        item.className = 'channel-checkbox-item';
        item.innerHTML = `
            <input type="checkbox" id="ch_${channel.id}" value="${channel.id}" ${isChecked ? 'checked' : ''} onchange="updateSelectedChannels('${channel.id}')">
            <label for="ch_${channel.id}">${channel.name}</label>
        `;
        checkboxArea.appendChild(item);
    });
}

function updateSelectedChannels(channelId) {
    const checkbox = document.getElementById(`ch_${channelId}`);
    if (checkbox.checked) {
        if (!evaluationData.selectedChannels.includes(channelId)) {
            evaluationData.selectedChannels.push(channelId);
        }
    } else {
        const index = evaluationData.selectedChannels.indexOf(channelId);
        if (index > -1) {
            evaluationData.selectedChannels.splice(index, 1);
        }
        // ì²´í¬ í•´ì œ ì‹œ í•´ë‹¹ ì±„ë„ í‰ê°€ ì‚­ì œ
        removeChannelEvaluation(channelId);
    }
}

function removeChannelEvaluation(channelId) {
    // UIì—ì„œ ì œê±°
    const section = document.querySelector(`[data-channel-id="${channelId}"]`);
    if (section) {
        section.remove();
    }
    
    // ë°ì´í„°ì—ì„œ ì œê±°
    delete evaluationData.currentChannels[channelId];
    delete evaluationData.existingEvaluations[channelId];
    
    // ì„ íƒëœ ì±„ë„ ëª©ë¡ì—ì„œ ì œê±°
    const index = evaluationData.selectedChannels.indexOf(channelId);
    if (index > -1) {
        evaluationData.selectedChannels.splice(index, 1);
    }
}

function loadSelectedChannels() {
    const selectedChannels = [];
    document.querySelectorAll('#channelCheckboxArea input[type="checkbox"]:checked').forEach(checkbox => {
        selectedChannels.push(checkbox.value);
    });
    
    if (selectedChannels.length === 0) {
        showAlert('í‰ê°€í•  ì±„ë„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const evaluationsArea = document.getElementById('channelEvaluationsArea');
    
    showLoading(true);
    let loadedCount = 0;
    
    selectedChannels.forEach(channelId => {
        // ì´ë¯¸ ë¡œë“œëœ ì±„ë„ì€ ìŠ¤í‚µ
        if (evaluationData.currentChannels[channelId]) {
            loadedCount++;
            if (loadedCount === selectedChannels.length) {
                showLoading(false);
            }
            return;
        }
        
        google.script.run
            .withSuccessHandler(function(channelMembers) {
                evaluationData.currentChannels[channelId] = channelMembers;
                
                // ê¸°ì¡´ í‰ê°€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                google.script.run
                    .withSuccessHandler(function(existingEval) {
                        const html = displayChannelEvaluation(channelId, channelMembers, existingEval);
                        evaluationsArea.innerHTML += html;
                        
                        loadedCount++;
                        if (loadedCount === selectedChannels.length) {
                            showLoading(false);
                            document.getElementById('submitFirstEvalBtn').style.display = 'block';
                        }
                    })
                    .withFailureHandler(function(error) {
                        const html = displayChannelEvaluation(channelId, channelMembers, {});
                        evaluationsArea.innerHTML += html;
                        
                        loadedCount++;
                        if (loadedCount === selectedChannels.length) {
                            showLoading(false);
                            document.getElementById('submitFirstEvalBtn').style.display = 'block';
                        }
                    })
                    .getExistingFirstEvaluation(channelId, evaluationData.currentEvalMonth);
            })
            .withFailureHandler(function(error) {
                showAlert('ì±„ë„ ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
                showLoading(false);
            })
            .getChannelMembersData(channelId);
    });
}

function displayChannelEvaluation(channelId, channelMembers, existingEval) {
    const channel = evaluationData.channels.find(c => c.id === channelId);
    
    let html = `
        <div class="channel-evaluation-section" data-channel-id="${channelId}">
            <div class="channel-info-card">
                <div class="channel-header">
                    <div style="flex: 1;">
                        <h4>${channel.name}</h4>
                        <p class="channel-members-count">íŒ€ì› ìˆ˜: ${channelMembers.length}ëª…</p>
                        ${Object.keys(existingEval).length > 0 ? '<p style="color: #ff6b6b; font-weight: bold;">â€» ê¸°ì¡´ í‰ê°€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤</p>' : ''}
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn btn-primary" style="padding: 5px 15px; font-size: 14px;" onclick="toggleChannelComment('${channelId}')">
                            <span id="commentToggle_${channelId}">ğŸ“ ì±„ë„ ì½”ë©˜íŠ¸</span>
                        </button>
                        <button class="btn btn-warning" style="padding: 5px 15px; font-size: 14px;" onclick="toggleMemberManagement('${channelId}')">
                            <span id="memberToggle_${channelId}">ğŸ‘¥ íŒ€ì› ê´€ë¦¬</span>
                        </button>
                        <button class="btn btn-danger" onclick="removeChannelEvaluation('${channelId}')">ğŸ—‘ï¸ ì±„ë„ í‰ê°€ ì‚­ì œ</button>
                    </div>
                </div>
            </div>
            
            <div id="channelComment_${channelId}" class="channel-comment-section" style="display: none;">
                <label><strong>ì±„ë„ ì „ì²´ ì½”ë©˜íŠ¸:</strong></label>
                <textarea id="channelCommentText_${channelId}" placeholder="ì´ ì±„ë„ì— ëŒ€í•œ ì „ì²´ì ì¸ í‰ê°€ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; min-height: 80px; margin-top: 10px;">${existingEval.channelComment || ''}</textarea>
            </div>
            
            <div id="memberManagement_${channelId}" class="member-management-section" style="display: none;">
                <h5>ğŸ‘¥ ì±„ë„ íŒ€ì› ê´€ë¦¬</h5>
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label>íŒ€ ì„ íƒ:</label>
                        <select id="teamSelect_${channelId}" onchange="loadTeamMembers('${channelId}')" style="width: 100%;">
                            <option value="">íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="team1">ìŠ¤íŠœë””ì˜¤ 1íŒ€</option>
                            <option value="team2">ìŠ¤íŠœë””ì˜¤ 2íŒ€</option>
                            <option value="team3">ìŠ¤íŠœë””ì˜¤ 3íŒ€</option>
                            <option value="team4">ìŠ¤íŠœë””ì˜¤ 4íŒ€</option>
                            <option value="team5">ìŠ¤íŠœë””ì˜¤ 5íŒ€</option>
                        </select>
                    </div>
                    <div style="flex: 2;">
                        <label>íŒ€ì› ì¶”ê°€:</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="memberSelect_${channelId}" style="flex: 1;">
                                <option value="">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                            <button class="btn btn-success" onclick="addMemberToChannelEval('${channelId}')">â• ì¶”ê°€</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="summary-box">
                <div class="summary-item">
                    <span class="summary-label">íˆ¬ì… MM í•©ê³„:</span>
                    <span class="summary-value" id="totalMM_${channelId}">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ì”ì—¬ ê¸°ì—¬ë„:</span>
                    <span class="summary-value percentage" id="remainingText_${channelId}">100%</span>
                </div>
                <div class="progress-bar" style="margin-top: 10px;">
                    <div class="progress-fill" id="contributionBar_${channelId}" style="width: 0%; background: #e74c3c;">0%</div>
                </div>
            </div>
            
            <table class="evaluation-table">
                <thead>
                    <tr>
                        <th>íŒ€ì›ëª…</th>
                        <th>ì†Œì†íŒ€</th>
                        <th>íˆ¬ì… MM</th>
                        <th>1ì°¨ ê¸°ì—¬ë„(%)</th>
                        <th>ìƒì„¸ì •ë³´</th>
                        <th>ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody id="tbody_${channelId}">
    `;
    
    channelMembers.forEach(member => {
        const existing = existingEval[member.id] || existingEval.members?.find(m => m.id === member.id) || {};
        const achievements = existing.achievement ? existing.achievement.split('|') : [''];
        
        html += createMemberRow(channelId, member, existing, achievements);
    });
    
    html += '</tbody></table></div>';
    
    // ì´ˆê¸°ê°’ì´ ìˆìœ¼ë©´ í•©ê³„ ì—…ë°ì´íŠ¸ ì˜ˆì•½
    if (Object.keys(existingEval).length > 0) {
        setTimeout(() => {
            updateMMTotal(channelId);
            updateContributionBar(channelId);
        }, 100);
    }
    
    return html;
}

// íŒ€ì› í–‰ ìƒì„± í•¨ìˆ˜
function createMemberRow(channelId, member, existing, achievements) {
    let html = `
        <tr id="row_${channelId}_${member.id}">
            <td>${member.name}</td>
            <td>${member.teamName}</td>
            <td><input type="number" id="mm_${channelId}_${member.id}" step="0.1" min="0" max="1" placeholder="0.0" value="${existing.mm || ''}" onchange="updateMMTotal('${channelId}')"></td>
            <td><input type="number" id="contrib_${channelId}_${member.id}" step="1" min="0" max="100" placeholder="0" value="${existing.contribution1 || ''}" onchange="updateContributionBar('${channelId}')"></td>
            <td><button class="detail-btn" onclick="toggleDetail('${channelId}_${member.id}')">+</button></td>
            <td><button class="btn btn-danger" style="padding: 2px 8px; font-size: 12px;" onclick="removeMemberFromChannelEval('${channelId}', '${member.id}')">ğŸ—‘ï¸ ì‚­ì œ</button></td>
        </tr>
        <tr id="detail_row_${channelId}_${member.id}">
            <td colspan="6">
                <div id="detail_${channelId}_${member.id}" class="detail-panel">
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 1;">
                            <strong>ğŸ† ê°œì¸ë³„ í•µì‹¬ ì„±ê³¼:</strong>
                            <div id="achievements_${channelId}_${member.id}" class="achievements-list">
    `;
    
    achievements.forEach((achievement, index) => {
        if (achievement || index === 0) {
            html += `
                <div class="achievement-item">
                    <input type="text" placeholder="í•µì‹¬ ì„±ê³¼ ì…ë ¥" value="${achievement}">
                    <button onclick="removeAchievement(this)" class="btn btn-danger" style="padding: 2px 8px; font-size: 12px;">âŒ ì‚­ì œ</button>
                </div>
            `;
        }
    });
    
    html += `
                            </div>
                            <button onclick="addAchievement('${channelId}_${member.id}')" class="btn btn-primary" style="margin-top: 10px; padding: 5px 10px; font-size: 12px;">â• ì„±ê³¼ ì¶”ê°€</button>
                        </div>
                        <div style="flex: 1;">
                            <strong>ğŸ’¬ 1ì°¨ ì½”ë©˜íŠ¸:</strong>
                            <textarea id="comment1_${channelId}_${member.id}" placeholder="í‰ê°€ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">${existing.comment1 || ''}</textarea>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    `;
    
    return html;
}

// íŒ€ì› ê´€ë¦¬ í† ê¸€
function toggleMemberManagement(channelId) {
    const managementSection = document.getElementById(`memberManagement_${channelId}`);
    const toggleButton = document.getElementById(`memberToggle_${channelId}`);
    
    if (managementSection.style.display === 'none') {
        managementSection.style.display = 'block';
        toggleButton.textContent = 'ğŸ‘¥ íŒ€ì› ê´€ë¦¬ ë‹«ê¸°';
    } else {
        managementSection.style.display = 'none';
        toggleButton.textContent = 'ğŸ‘¥ íŒ€ì› ê´€ë¦¬';
    }
}

// íŒ€ë³„ ë©¤ë²„ ë¡œë“œ
function loadTeamMembers(channelId) {
    const teamId = document.getElementById(`teamSelect_${channelId}`).value;
    const memberSelect = document.getElementById(`memberSelect_${channelId}`);
    
    if (!teamId) {
        memberSelect.innerHTML = '<option value="">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        return;
    }
    
    // í˜„ì¬ ì±„ë„ì— ì´ë¯¸ ìˆëŠ” ë©¤ë²„ ID ëª©ë¡
    const existingMemberIds = Object.keys(evaluationData.currentChannels[channelId] || {})
        .map(key => evaluationData.currentChannels[channelId][key].id);
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(teamMembers) {
            memberSelect.innerHTML = '<option value="">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            
            teamMembers.forEach(member => {
                // ì´ë¯¸ ì¶”ê°€ëœ ë©¤ë²„ëŠ” ì œì™¸
                if (!existingMemberIds.includes(member.id)) {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    option.dataset.teamName = evaluationData.teams[member.teamId].name;
                    memberSelect.appendChild(option);
                }
            });
            
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showAlert('íŒ€ì› ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getTeamMembersData(teamId);
}

// ì±„ë„ì— íŒ€ì› ì¶”ê°€
function addMemberToChannelEval(channelId) {
    const memberSelect = document.getElementById(`memberSelect_${channelId}`);
    const selectedOption = memberSelect.selectedOptions[0];
    
    if (!selectedOption || !selectedOption.value) {
        showAlert('ì¶”ê°€í•  íŒ€ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const memberId = selectedOption.value;
    const memberName = selectedOption.textContent;
    const teamName = selectedOption.dataset.teamName;
    
    // ë°ì´í„°ë² ì´ìŠ¤ì— ì¶”ê°€
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                // UIì— ì¶”ê°€
                const tbody = document.getElementById(`tbody_${channelId}`);
                const newMember = {
                    id: memberId,
                    name: memberName,
                    teamName: teamName
                };
                
                // í˜„ì¬ ì±„ë„ ë©¤ë²„ ëª©ë¡ì— ì¶”ê°€
                if (!evaluationData.currentChannels[channelId]) {
                    evaluationData.currentChannels[channelId] = [];
                }
                evaluationData.currentChannels[channelId].push(newMember);
                
                // í…Œì´ë¸”ì— í–‰ ì¶”ê°€
                const newRow = createMemberRow(channelId, newMember, {}, ['']);
                tbody.insertAdjacentHTML('beforeend', newRow);
                
                // ì„ íƒ ì˜µì…˜ì—ì„œ ì œê±°
                selectedOption.remove();
                
                // íŒ€ì› ìˆ˜ ì—…ë°ì´íŠ¸
                const countElement = document.querySelector(`[data-channel-id="${channelId}"] .channel-members-count`);
                countElement.textContent = `íŒ€ì› ìˆ˜: ${evaluationData.currentChannels[channelId].length}ëª…`;
                
                showAlert(result.message, 'success');
            } else {
                showAlert(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showAlert('íŒ€ì› ì¶”ê°€ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .addMemberToChannel(channelId, memberId);
}

// ì±„ë„ì—ì„œ íŒ€ì› ì œê±°
function removeMemberFromChannelEval(channelId, memberId) {
    if (!confirm('ì´ íŒ€ì›ì„ ì±„ë„ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                // UIì—ì„œ ì œê±°
                document.getElementById(`row_${channelId}_${memberId}`).remove();
                document.getElementById(`detail_row_${channelId}_${memberId}`).remove();
                
                // ë°ì´í„°ì—ì„œ ì œê±°
                evaluationData.currentChannels[channelId] = evaluationData.currentChannels[channelId]
                    .filter(m => m.id !== memberId);
                
                // íŒ€ì› ìˆ˜ ì—…ë°ì´íŠ¸
                const countElement = document.querySelector(`[data-channel-id="${channelId}"] .channel-members-count`);
                countElement.textContent = `íŒ€ì› ìˆ˜: ${evaluationData.currentChannels[channelId].length}ëª…`;
                
                // í•©ê³„ ì—…ë°ì´íŠ¸
                updateMMTotal(channelId);
                updateContributionBar(channelId);
                
                showAlert(result.message, 'success');
            } else {
                showAlert(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showAlert('íŒ€ì› ì œê±° ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .removeMemberFromChannel(channelId, memberId);
}

// ì±„ë„ ì½”ë©˜íŠ¸ í† ê¸€ í•¨ìˆ˜
function toggleChannelComment(channelId) {
    const commentSection = document.getElementById(`channelComment_${channelId}`);
    const toggleButton = document.getElementById(`commentToggle_${channelId}`);
    
    if (commentSection.style.display === 'none') {
        commentSection.style.display = 'block';
        toggleButton.textContent = 'ğŸ“ ì±„ë„ ì½”ë©˜íŠ¸ ë‹«ê¸°';
    } else {
        commentSection.style.display = 'none';
        toggleButton.textContent = 'ğŸ“ ì±„ë„ ì½”ë©˜íŠ¸';
    }
}

function toggleDetail(id) {
    const detailPanel = document.getElementById(`detail_${id}`);
    detailPanel.classList.toggle('show');
}

function updateMMTotal(channelId) {
    const members = evaluationData.currentChannels[channelId];
    if (!members) return;
    
    let totalMM = 0;
    
    members.forEach(member => {
        const mmInput = document.getElementById(`mm_${channelId}_${member.id}`);
        if (mmInput) {
            const mm = parseFloat(mmInput.value) || 0;
            totalMM += mm;
        }
    });
    
    document.getElementById(`totalMM_${channelId}`).textContent = totalMM.toFixed(1);
}

function updateContributionBar(channelId) {
    const members = evaluationData.currentChannels[channelId];
    if (!members) return;
    
    let totalContribution = 0;
    
    members.forEach(member => {
        const contribInput = document.getElementById(`contrib_${channelId}_${member.id}`);
        if (contribInput) {
            const contrib = parseFloat(contribInput.value) || 0;
            totalContribution += contrib;
        }
    });
    
    const remaining = 100 - totalContribution;
    const used = Math.min(totalContribution, 100);
    
    // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    document.getElementById(`remainingText_${channelId}`).textContent = `${remaining}%`;
    
    // ë°” ì—…ë°ì´íŠ¸
    const bar = document.getElementById(`contributionBar_${channelId}`);
    bar.style.width = `${used}%`;
    bar.textContent = `${used}%`;
    
    // ìƒ‰ìƒ ë³€ê²½
    if (totalContribution === 100) {
        bar.style.background = '#27ae60';
    } else if (totalContribution > 100) {
        bar.style.background = '#e74c3c';
    } else {
        bar.style.background = '#3498db';
    }
}

function addAchievement(memberId) {
    const container = document.getElementById(`achievements_${memberId}`);
    const newItem = document.createElement('div');
    newItem.className = 'achievement-item';
    newItem.innerHTML = `
        <input type="text" placeholder="í•µì‹¬ ì„±ê³¼ ì…ë ¥">
                            <button onclick="removeAchievement(this)" class="btn btn-danger" style="padding: 2px 8px; font-size: 12px;">âŒ ì‚­ì œ</button>
    `;
    container.appendChild(newItem);
}

function removeAchievement(button) {
    const container = button.parentElement.parentElement;
    if (container.children.length > 1) {
        button.parentElement.remove();
    }
}

function submitFirstEvaluation() {
    const evaluations = [];
    const sections = document.querySelectorAll('.channel-evaluation-section');
    
    if (sections.length === 0) {
        showAlert('í‰ê°€í•  ì±„ë„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const evalMonth = document.getElementById('evalMonth').value;
    const teamleadId = document.getElementById('teamleadSelect').value;
    const teamleadName = document.getElementById('teamleadSelect').selectedOptions[0].text.split(' (')[0];
    
    if (!evalMonth || !teamleadId) {
        showAlert('í‰ê°€ì›”ê³¼ íŒ€ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    console.log('ì €ì¥í•  í‰ê°€ì›”:', evalMonth);
    
    let hasError = false;
    
    sections.forEach(section => {
        const channelId = section.dataset.channelId;
        const channel = evaluationData.channels.find(c => c.id === channelId);
        const members = evaluationData.currentChannels[channelId];
        
        // ì±„ë„ ì½”ë©˜íŠ¸ ìˆ˜ì§‘
        const channelComment = document.getElementById(`channelCommentText_${channelId}`)?.value || '';
        
        const channelEvaluation = {
            evalMonth: evalMonth,
            channelId: channelId,
            channelName: channel.name,
            channelComment: channelComment,
            evaluatorId: teamleadId,
            members: []
        };
        
        let totalContribution = 0;
        
        members.forEach(member => {
            const mmInput = document.getElementById(`mm_${channelId}_${member.id}`);
            const contribInput = document.getElementById(`contrib_${channelId}_${member.id}`);
            
            if (!mmInput || !contribInput) return; // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
            
            const mm = parseFloat(mmInput.value) || 0;
            const contribution = parseFloat(contribInput.value) || 0;
            
            // ì„±ê³¼ ìˆ˜ì§‘
            const achievements = [];
            const achievementInputs = document.querySelectorAll(`#achievements_${channelId}_${member.id} input[type="text"]`);
            achievementInputs.forEach(input => {
                if (input.value.trim()) {
                    achievements.push(input.value.trim());
                }
            });
            
            const commentElement = document.getElementById(`comment1_${channelId}_${member.id}`);
            const comment = commentElement ? commentElement.value : '';
            
            totalContribution += contribution;
            
            channelEvaluation.members.push({
                id: member.id,
                name: member.name,
                teamName: member.teamName,
                mm: mm,
                contribution1: contribution,
                achievement: achievements.join('|'),
                comment1: comment
            });
        });
        
        if (Math.abs(totalContribution - 100) > 0.01) {
            showAlert(`${channel.name} ì±„ë„ì˜ ê¸°ì—¬ë„ í•©ê³„ê°€ 100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.`, 'error');
            hasError = true;
        }
        
        evaluations.push(channelEvaluation);
    });
    
    if (hasError) return;
    
    // í‰ê°€ ì •ë³´ ë¨¼ì € ì €ì¥
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('í‰ê°€ì •ë³´ ì €ì¥ ê²°ê³¼:', result);
            
            // ê° ì±„ë„ë³„ë¡œ ì €ì¥
            let savedCount = 0;
            
            evaluations.forEach(evaluation => {
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('ì±„ë„ í‰ê°€ ì €ì¥ ê²°ê³¼:', result);
                        
                        if (result.success) {
                            savedCount++;
                            if (savedCount === evaluations.length) {
                                showAlert('ëª¨ë“  1ì°¨ í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                                
                                // ë°ì´í„° ìƒíƒœ í™•ì¸
                                google.script.run
                                    .withSuccessHandler(function(status) {
                                        console.log('ë°ì´í„° ìƒíƒœ:', status);
                                        showLoading(false);
                                        checkExistingEvaluation();
                                    })
                                    .checkDataStatus();
                            }
                        } else {
                            showAlert(result.message, 'error');
                            showLoading(false);
                        }
                    })
                    .withFailureHandler(function(error) {
                        showAlert('ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
                        showLoading(false);
                    })
                    .saveFirstEvaluation(evaluation);
            });
        })
        .withFailureHandler(function(error) {
            showAlert('í‰ê°€ ì •ë³´ ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .saveEvaluationInfo(evalMonth, teamleadId, teamleadName, '1ì°¨ í‰ê°€ ì™„ë£Œ');
}

// ===== 2ì°¨ í‰ê°€ ê´€ë ¨ í•¨ìˆ˜ =====
function loadSecondEvaluation() {
    const evalMonth = document.getElementById('evalMonth2nd').value;
    if (!evalMonth) {
        showAlert('í‰ê°€ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    console.log('2ì°¨ í‰ê°€ ë¡œë“œ - í‰ê°€ì›”:', evalMonth);
    
    showLoading(true);
    
    // ë¨¼ì € ë””ë²„ê¹… ì •ë³´ í™•ì¸
    google.script.run
        .withSuccessHandler(function(debugInfo) {
            console.log('ë””ë²„ê¹… ì •ë³´:', debugInfo);
            
            // ì‹¤ì œ ë°ì´í„° ë¡œë“œ
            google.script.run
                .withSuccessHandler(function(data) {
                    console.log('1ì°¨ í‰ê°€ ë°ì´í„°:', data);
                    evaluationData.firstEvaluation = data;
                    displaySecondEvaluation();
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('1ì°¨ í‰ê°€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
                    showLoading(false);
                })
                .getFirstEvaluationData(evalMonth);
        })
        .withFailureHandler(function(error) {
            console.error('ë””ë²„ê¹… ì‹¤íŒ¨:', error);
            showLoading(false);
        })
        .debugFirstEvaluation(evalMonth);
}

function displaySecondEvaluation() {
    const area = document.getElementById('secondEvaluationArea');
    let html = '<h3>ğŸ“‹ 1ì°¨ í‰ê°€ ê²°ê³¼ ê²€í†  ë° 2ì°¨ í‰ê°€</h3>';
    
    if (Object.keys(evaluationData.firstEvaluation).length === 0) {
        html += '<p>ì„ íƒí•œ ì›”ì˜ 1ì°¨ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        area.innerHTML = html;
        document.getElementById('submitSecondEvalBtn').style.display = 'none';
        return;
    }
    
    document.getElementById('submitSecondEvalBtn').style.display = 'block';
    
    // ê° ì±„ë„ë³„ë¡œ í‘œì‹œ
    for (const channelId in evaluationData.firstEvaluation) {
        const channelEval = evaluationData.firstEvaluation[channelId];
        
        // MM í•©ê³„ì™€ ê¸°ì—¬ë„ í•©ê³„ ê³„ì‚°
        let totalMM = 0;
        let totalContrib1 = 0;
        channelEval.members.forEach(member => {
            totalMM += parseFloat(member.mm) || 0;
            totalContrib1 += parseFloat(member.contribution1) || 0;
        });
        
        html += `
            <div class="summary-box">
                <h4>${channelEval.channelName}</h4>
                ${channelEval.channelComment ? `<p style="color: #666; margin-bottom: 15px;"><strong>ì±„ë„ ì½”ë©˜íŠ¸:</strong> ${channelEval.channelComment}</p>` : ''}
                
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div class="summary-item">
                        <span class="summary-label">íˆ¬ì… MM í•©ê³„:</span>
                        <span class="summary-value">${totalMM.toFixed(1)}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">1ì°¨ ê¸°ì—¬ë„ í•©ê³„:</span>
                        <span class="summary-value percentage">${totalContrib1}%</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">2ì°¨ ê¸°ì—¬ë„ í•©ê³„:</span>
                        <span class="summary-value percentage" id="totalContrib2_${channelId}">0%</span>
                    </div>
                </div>
                
                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th>íŒ€ì›ëª…</th>
                            <th>ì†Œì†íŒ€</th>
                            <th>íˆ¬ì… MM</th>
                            <th>1ì°¨ ê¸°ì—¬ë„</th>
                            <th>2ì°¨ ê¸°ì—¬ë„(%)</th>
                            <th>ìƒì„¸ì •ë³´</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        channelEval.members.forEach(member => {
            html += `
                <tr>
                    <td>${member.name}</td>
                    <td>${member.teamName}</td>
                    <td>${member.mm}</td>
                    <td class="percentage">${member.contribution1}%</td>
                    <td><input type="number" id="contrib2_${channelId}_${member.id}" step="1" min="0" max="100" value="${member.contribution1}" onchange="updateContrib2Total('${channelId}')"></td>
                    <td><button class="detail-btn" onclick="toggleDetail2('${channelId}_${member.id}')">+</button></td>
                </tr>
                <tr>
                    <td colspan="6">
                        <div id="detail2_${channelId}_${member.id}" class="detail-panel">
                            <strong>ê°œì¸ë³„ í•µì‹¬ ì„±ê³¼:</strong>
                            <p>${member.achievement ? member.achievement.split('|').join(', ') : 'ì—†ìŒ'}</p>
                            <strong>1ì°¨ ì½”ë©˜íŠ¸:</strong>
                            <p>${member.comment1 || 'ì—†ìŒ'}</p>
                            <strong>ğŸ“ 2ì°¨ ì½”ë©˜íŠ¸:</strong>
                            <textarea id="comment2_${channelId}_${member.id}" placeholder="2ì°¨ í‰ê°€ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
    }
    
    area.innerHTML = html;
    
    // ì´ˆê¸° 2ì°¨ ê¸°ì—¬ë„ í•©ê³„ ê³„ì‚°
    for (const channelId in evaluationData.firstEvaluation) {
        updateContrib2Total(channelId);
    }
}

// 2ì°¨ ê¸°ì—¬ë„ í•©ê³„ ì—…ë°ì´íŠ¸
function updateContrib2Total(channelId) {
    const channelEval = evaluationData.firstEvaluation[channelId];
    let total = 0;
    
    channelEval.members.forEach(member => {
        const contrib2Input = document.getElementById(`contrib2_${channelId}_${member.id}`);
        if (contrib2Input) {
            total += parseFloat(contrib2Input.value) || 0;
        }
    });
    
    const totalElement = document.getElementById(`totalContrib2_${channelId}`);
    if (totalElement) {
        totalElement.textContent = `${total}%`;
        totalElement.style.color = (total === 100) ? '#27ae60' : (total > 100) ? '#e74c3c' : '#3498db';
    }
}

function toggleDetail2(id) {
    const detailPanel = document.getElementById(`detail2_${id}`);
    detailPanel.classList.toggle('show');
}

function submitSecondEvaluation() {
    const evalMonth = document.getElementById('evalMonth2nd').value;
    const secondEvalData = {
        evalMonth: evalMonth,
        channels: {}
    };
    
    for (const channelId in evaluationData.firstEvaluation) {
        const channelEval = evaluationData.firstEvaluation[channelId];
        const secondChannelEval = {
            channelId: channelId,
            channelName: channelEval.channelName,
            channelComment: channelEval.channelComment || '', // ì±„ë„ ì½”ë©˜íŠ¸ í¬í•¨
            members: []
        };
        
        channelEval.members.forEach(member => {
            const contrib2Input = document.getElementById(`contrib2_${channelId}_${member.id}`);
            const contribution2 = parseFloat(contrib2Input.value) || member.contribution1;
            const comment2 = document.getElementById(`comment2_${channelId}_${member.id}`).value;
            
            secondChannelEval.members.push({
                ...member,
                contribution2: contribution2,
                comment2: comment2
            });
        });
        
        secondEvalData.channels[channelId] = secondChannelEval;
    }
    
    // êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showAlert(result.message, 'success');
                evaluationData.secondEvaluation = secondEvalData;
            } else {
                showAlert(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showAlert('ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .saveSecondEvaluation(secondEvalData);
}

// ===== ìµœì¢… í‰ê°€ ê´€ë ¨ í•¨ìˆ˜ =====
function loadFinalEvaluation() {
    const evalMonth = document.getElementById('evalMonthFinal').value;
    if (!evalMonth) {
        showAlert('í‰ê°€ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(data) {
            evaluationData.secondEvaluation = data;
            displayFinalEvaluation();
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showAlert('2ì°¨ í‰ê°€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getFinalEvaluationDetailData(evalMonth);
}

function displayFinalEvaluation() {
    const area = document.getElementById('finalEvaluationArea');
    let html = '<h3>ğŸ’° ìµœì¢… ì„±ê³¼ê¸ˆ ì±…ì •</h3>';
    
    if (Object.keys(evaluationData.secondEvaluation).length === 0) {
        html += '<p>ì„ íƒí•œ ì›”ì˜ 2ì°¨ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        area.innerHTML = html;
        document.getElementById('submitFinalEvalBtn').style.display = 'none';
        return;
    }
    
    document.getElementById('submitFinalEvalBtn').style.display = 'block';
    
    // ê° ì±„ë„ë³„ë¡œ í‘œì‹œ
    evaluationData.finalEvaluation.channels = {};
    
    for (const channelId in evaluationData.secondEvaluation) {
        const channelEval = evaluationData.secondEvaluation[channelId];
        
        // MM í•©ê³„ ê³„ì‚°
        let totalMM = 0;
        channelEval.members.forEach(member => {
            totalMM += parseFloat(member.mm) || 0;
        });
        
        evaluationData.finalEvaluation.channels[channelId] = {
            channelName: channelEval.channelName,
            channelComment: channelEval.channelComment || '',
            members: channelEval.members,
            totalAmount: 0,
            leaderPercentage: 0
        };
        
        html += `
            <div class="summary-box" style="margin-bottom: 30px;">
                <h4>${channelEval.channelName}</h4>
                ${channelEval.channelComment ? `
                    <div style="background: #272727; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #3f3f3f;">
                        <button class="btn btn-primary" style="padding: 5px 15px; font-size: 14px; margin-bottom: 10px;" onclick="toggleChannelDetail('${channelId}')">
                            <span id="channelDetailToggle_${channelId}">ğŸ“‹ ì±„ë„ ìƒì„¸ì •ë³´ ë³´ê¸°</span>
                        </button>
                        <div id="channelDetail_${channelId}" class="channel-detail-box" style="display: none;">
                            <p><strong>ì±„ë„ ì½”ë©˜íŠ¸:</strong> ${channelEval.channelComment}</p>
                        </div>
                    </div>
                ` : ''}
                
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label>ğŸ’° 1ì°¨ ì„±ê³¼ê¸ˆ ì´ì•¡ (ë§Œì›):</label>
                        <input type="number" id="total_${channelId}" placeholder="0" onchange="calculateDistribution('${channelId}')" style="width: 150px;">
                    </div>
                    <div>
                        <label>ğŸ‘” íŒ€ì¥ ì„±ê³¼(%):</label>
                        <input type="number" id="leader_${channelId}" placeholder="0" min="0" max="100" onchange="calculateDistribution('${channelId}')" style="width: 100px;">
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">íˆ¬ì… MM í•©ê³„:</span>
                        <span class="summary-value">${totalMM.toFixed(1)}</span>
                    </div>
                </div>
                
                <div class="summary-item" style="align-items: center; margin-bottom: 10px;">
                    <span class="summary-label">2ì°¨ ì„±ê³¼ê¸ˆ(ë°°ë¶„ëŒ€ìƒ):</span>
                    <span class="summary-value amount" id="dist_${channelId}" style="font-size: 24px; margin-left: 15px;">0ë§Œì›</span>
                </div>
                
                <div class="progress-container" style="margin-bottom: 20px;">
                    <label>ğŸ’¸ ì„±ê³¼ê¸ˆ ë¶„ë°° í˜„í™©:</label>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress_${channelId}" style="width: 0%">0%</div>
                    </div>
                    <div id="overDistribution_${channelId}" style="color: #e74c3c; font-weight: bold; margin-top: 5px; display: none;">
                        âš ï¸ ë¶„ë°° ê¸ˆì•¡ì´ ë°°ë¶„ ëŒ€ìƒì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!
                    </div>
                </div>
                
                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th>íŒ€</th>
                            <th>íŒ€ì›ëª…</th>
                            <th>íˆ¬ì… MM</th>
                            <th>1ì°¨ ê¸°ì—¬ë„</th>
                            <th>2ì°¨ ê¸°ì—¬ë„</th>
                            <th>ê¸°ì—¬ë„ ì„±ê³¼ê¸ˆ</th>
                            <th>ì‹¤ì§€ê¸‰ ì„±ê³¼ê¸ˆ</th>
                            <th>ìƒì„¸ì •ë³´</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        channelEval.members.forEach(member => {
            html += `
                <tr>
                    <td>${member.teamName}</td>
                    <td>${member.name}</td>
                    <td>${member.mm}</td>
                    <td class="percentage">${member.contribution1}%</td>
                    <td class="percentage">${member.contribution2}%</td>
                    <td class="amount" id="calc_${channelId}_${member.id}">0ë§Œì›</td>
                    <td><input type="number" id="final_${channelId}_${member.id}" placeholder="0" onchange="updateDistributionBar('${channelId}')" style="width: 100px;"> ë§Œì›</td>
                    <td><button class="detail-btn" onclick="toggleFinalDetail('${channelId}_${member.id}')">+</button></td>
                </tr>
                <tr>
                    <td colspan="8">
                        <div id="finalDetail_${channelId}_${member.id}" class="detail-panel">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <strong>ê°œì¸ë³„ í•µì‹¬ ì„±ê³¼:</strong>
                                    <p style="background: #272727; color: #f1f1f1; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                        ${member.achievement ? member.achievement.split('|').join(', ') : 'ì—†ìŒ'}
                                    </p>
                                </div>
                                <div>
                                    <strong>1ì°¨ ì½”ë©˜íŠ¸:</strong>
                                    <p style="background: #272727; color: #f1f1f1; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                        ${member.comment1 || 'ì—†ìŒ'}
                                    </p>
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <strong>2ì°¨ ì½”ë©˜íŠ¸:</strong>
                                    <p style="background: #272727; color: #f1f1f1; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                        ${member.comment2 || 'ì—†ìŒ'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    area.innerHTML = html;
}

// ì±„ë„ ìƒì„¸ì •ë³´ í† ê¸€
function toggleChannelDetail(channelId) {
    const detailDiv = document.getElementById(`channelDetail_${channelId}`);
    const toggleBtn = document.getElementById(`channelDetailToggle_${channelId}`);
    
    if (detailDiv.style.display === 'none') {
        detailDiv.style.display = 'block';
        toggleBtn.textContent = 'ğŸ“‹ ì±„ë„ ìƒì„¸ì •ë³´ ë‹«ê¸°';
    } else {
        detailDiv.style.display = 'none';
        toggleBtn.textContent = 'ğŸ“‹ ì±„ë„ ìƒì„¸ì •ë³´ ë³´ê¸°';
    }
}

// ìµœì¢… í‰ê°€ ìƒì„¸ì •ë³´ í† ê¸€
function toggleFinalDetail(id) {
    const detailPanel = document.getElementById(`finalDetail_${id}`);
    detailPanel.classList.toggle('show');
}

function calculateDistribution(channelId) {
    const totalAmountInManwon = parseFloat(document.getElementById(`total_${channelId}`).value) || 0;
    const leaderPercentage = parseFloat(document.getElementById(`leader_${channelId}`).value) || 0;
    
    // 2ì°¨ ì„±ê³¼ê¸ˆ ê³„ì‚° (ë§Œì› ë‹¨ìœ„)
    const distributionAmountInManwon = totalAmountInManwon * (100 - leaderPercentage) / 100;
    
    // ì •ìˆ˜ë¡œ í‘œì‹œ (.0 ì œê±°)
    const formattedAmount = distributionAmountInManwon % 1 === 0 
        ? distributionAmountInManwon.toString() 
        : distributionAmountInManwon.toFixed(1);
    
    document.getElementById(`dist_${channelId}`).textContent = `${formattedAmount}ë§Œì›`;
    
    // ê° íŒ€ì›ì˜ ê¸°ì—¬ë„ ì„±ê³¼ê¸ˆ ê³„ì‚° (ë§Œì› ë‹¨ìœ„)
    const channelData = evaluationData.finalEvaluation.channels[channelId];
    channelData.members.forEach(member => {
        const calcAmountInManwon = distributionAmountInManwon * member.contribution2 / 100;
        
        // ì •ìˆ˜ë¡œ í‘œì‹œ (.0 ì œê±°)
        const formattedCalcAmount = calcAmountInManwon % 1 === 0 
            ? calcAmountInManwon.toString() 
            : calcAmountInManwon.toFixed(1);
        
        document.getElementById(`calc_${channelId}_${member.id}`).textContent = `${formattedCalcAmount}ë§Œì›`;
    });
    
    updateDistributionBar(channelId);
}

function updateDistributionBar(channelId) {
    const totalAmountInManwon = parseFloat(document.getElementById(`total_${channelId}`).value) || 0;
    const leaderPercentage = parseFloat(document.getElementById(`leader_${channelId}`).value) || 0;
    const distributionAmountInManwon = totalAmountInManwon * (100 - leaderPercentage) / 100;
    
    if (distributionAmountInManwon === 0) return;
    
    let totalDistributedInManwon = 0;
    const channelData = evaluationData.finalEvaluation.channels[channelId];
    
    channelData.members.forEach(member => {
        const finalAmountInManwon = parseFloat(document.getElementById(`final_${channelId}_${member.id}`).value) || 0;
        totalDistributedInManwon += finalAmountInManwon;
    });
    
    const percentage = (totalDistributedInManwon / distributionAmountInManwon) * 100;
    const progressBar = document.getElementById(`progress_${channelId}`);
    const overDistributionWarning = document.getElementById(`overDistribution_${channelId}`);
    
    progressBar.style.width = `${Math.min(percentage, 100)}%`;
    progressBar.textContent = `${Math.round(percentage)}%`;
    
    // ìƒ‰ìƒ ë³€ê²½ ë° ê²½ê³  ë©”ì‹œì§€
    if (percentage > 100) {
        progressBar.style.background = '#e74c3c';
        overDistributionWarning.style.display = 'block';
        
        // ì •ìˆ˜ë¡œ í‘œì‹œ (.0 ì œê±°)
        const overAmount = totalDistributedInManwon - distributionAmountInManwon;
        const formattedOverAmount = overAmount % 1 === 0 
            ? overAmount.toString() 
            : overAmount.toFixed(1);
        
        overDistributionWarning.textContent = `âš ï¸ ${formattedOverAmount}ë§Œì› ì´ˆê³¼ ë¶„ë°°ë˜ì—ˆìŠµë‹ˆë‹¤!`;
    } else if (percentage === 100) {
        progressBar.style.background = 'linear-gradient(to right, #27ae60, #2ecc71)';
        overDistributionWarning.style.display = 'none';
    } else {
        progressBar.style.background = 'linear-gradient(to right, #3498db, #2980b9)';
        overDistributionWarning.style.display = 'none';
    }
}

function submitFinalEvaluation() {
    const evalMonth = document.getElementById('evalMonthFinal').value;
    const channelData = {
        evalMonth: evalMonth,
        channels: {}
    };
    
    // ìµœì¢… ë°ì´í„° ìˆ˜ì§‘
    for (const channelId in evaluationData.finalEvaluation.channels) {
        const channelInfo = evaluationData.finalEvaluation.channels[channelId];
        // ë§Œì› ë‹¨ìœ„ë¥¼ ì› ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
        channelInfo.totalAmount = (parseFloat(document.getElementById(`total_${channelId}`).value) || 0) * 10000;
        channelInfo.leaderPercentage = parseFloat(document.getElementById(`leader_${channelId}`).value) || 0;
        
        channelInfo.members.forEach(member => {
            // ë§Œì› ë‹¨ìœ„ë¥¼ ì› ë‹¨ìœ„ë¡œ ë³€í™˜
            member.finalAmount = (parseFloat(document.getElementById(`final_${channelId}_${member.id}`).value) || 0) * 10000;
        });
        
        channelData.channels[channelId] = channelInfo;
    }
    
    // êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showAlert(result.message, 'success');
            } else {
                showAlert(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showAlert('ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .saveFinalEvaluation(channelData);
}

// ===== ë””ë²„ê¹… í•¨ìˆ˜ =====
function debugEvaluation() {
    const evalMonth = document.getElementById('evalMonth2nd').value;
    if (!evalMonth) {
        showAlert('í‰ê°€ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(debugInfo) {
            console.log('=== 1ì°¨ í‰ê°€ ë””ë²„ê¹… ì •ë³´ ===');
            console.log('ì „ì²´ í–‰ ìˆ˜:', debugInfo.totalRows);
            console.log('ì°¾ëŠ” ì›”:', debugInfo.targetMonth);
            console.log('ì €ì¥ëœ ëª¨ë“  ì›”:', debugInfo.uniqueMonths);
            console.log('ë§¤ì¹­ëœ ë°ì´í„°:', debugInfo.matchingRows);
            
            if (debugInfo.matchingRows.length === 0) {
                showAlert(`${evalMonth}ì— í•´ë‹¹í•˜ëŠ” 1ì°¨ í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\nì €ì¥ëœ ì›”: ${debugInfo.uniqueMonths.join(', ')}`, 'warning');
            } else {
                showAlert(`${evalMonth}ì— ${debugInfo.matchingRows.length}ê°œì˜ í‰ê°€ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.`, 'success');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showAlert('ë””ë²„ê¹… ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .debugFirstEvaluation(evalMonth);
}

// ===== ì „ì›” ë¹„êµ ê¸°ëŠ¥ =====
function loadComparisonData() {
    const month1 = document.getElementById('compareMonth1').value;
    const month2 = document.getElementById('compareMonth2').value;
    
    if (!month1 || !month2) {
        showAlert('ë¹„êµí•  ë‘ ë‹¬ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    showLoading(true);
    
    // ë‘ ë‹¬ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸°
    Promise.all([
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getComparisonData(month1);
        }),
        new Promise((resolve, reject) => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getComparisonData(month2);
        })
    ]).then(([data1, data2]) => {
        displayComparison(month1, data1, month2, data2);
        showLoading(false);
    }).catch(error => {
        showAlert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
        showLoading(false);
    });
}

function displayComparison(month1, data1, month2, data2) {
    const area = document.getElementById('comparisonArea');
    let html = `
        <h3>ğŸ“Š í‰ê°€ ë°ì´í„° ë¹„êµ ë¶„ì„</h3>
        <div class="comparison-summary">
            <div class="summary-item">
                <span class="summary-label">ë¹„êµ ê¸°ê°„:</span>
                <span class="summary-value">${month1} â†’ ${month2}</span>
            </div>
        </div>
    `;
    
    // ì±„ë„ë³„ ë¹„êµ
    const allChannels = new Set([...Object.keys(data1.evaluations), ...Object.keys(data2.evaluations)]);
    
    allChannels.forEach(channelId => {
        const channel1 = data1.evaluations[channelId];
        const channel2 = data2.evaluations[channelId];
        
        if (!channel1 && !channel2) return;
        
        const channelName = channel1?.channelName || channel2?.channelName || channelId;
        
        html += `
            <div class="channel-comparison-section">
                <h4>${channelName}</h4>
        `;
        
        // ì´ ì„±ê³¼ê¸ˆ ë¹„êµ
        if (data1.finalEval[channelId] && data2.finalEval[channelId]) {
            const total1 = data1.finalEval[channelId].totalAmount / 10000; // ë§Œì› ë‹¨ìœ„
            const total2 = data2.finalEval[channelId].totalAmount / 10000;
            const diff = total2 - total1;
            const diffPercent = total1 ? ((diff / total1) * 100).toFixed(1) : 0;
            
            // ì •ìˆ˜ë¡œ í‘œì‹œ (.0 ì œê±°)
            const formatAmount = (amount) => {
                return amount % 1 === 0 ? amount.toString() : amount.toFixed(1);
            };
            
            html += `
                <div class="comparison-box">
                    <div class="comparison-item">
                        <span>ì´ ì„±ê³¼ê¸ˆ:</span>
                        <span>${month1}: ${formatAmount(total1)}ë§Œì›</span>
                        <span>${month2}: ${formatAmount(total2)}ë§Œì›</span>
                        <span class="${diff >= 0 ? 'positive-change' : 'negative-change'}">
                            ${diff >= 0 ? 'â–²' : 'â–¼'} ${formatAmount(Math.abs(diff))}ë§Œì› (${diffPercent}%)
                        </span>
                    </div>
                </div>
            `;
        }
        
        // íŒ€ì›ë³„ ë¹„êµ í…Œì´ë¸”
        html += `
            <table class="evaluation-table">
                <thead>
                    <tr>
                        <th>íŒ€ì›ëª…</th>
                        <th>íŒ€</th>
                        <th>${month1} MM</th>
                        <th>${month2} MM</th>
                        <th>MM ë³€í™”</th>
                        <th>${month1} ê¸°ì—¬ë„</th>
                        <th>${month2} ê¸°ì—¬ë„</th>
                        <th>ê¸°ì—¬ë„ ë³€í™”</th>
                        <th>${month1} ì„±ê³¼ê¸ˆ</th>
                        <th>${month2} ì„±ê³¼ê¸ˆ</th>
                        <th>ì„±ê³¼ê¸ˆ ë³€í™”</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        // ëª¨ë“  ë©¤ë²„ ìˆ˜ì§‘
        const allMembers = new Map();
        
        if (channel1) {
            channel1.members.forEach(m => {
                allMembers.set(m.id, { 
                    name: m.name, 
                    teamName: m.teamName,
                    month1: m 
                });
            });
        }
        
        if (channel2) {
            channel2.members.forEach(m => {
                if (allMembers.has(m.id)) {
                    allMembers.get(m.id).month2 = m;
                } else {
                    allMembers.set(m.id, { 
                        name: m.name, 
                        teamName: m.teamName,
                        month2: m 
                    });
                }
            });
        }
        
        // í…Œì´ë¸” í–‰ ìƒì„±
        allMembers.forEach((memberData, memberId) => {
            const m1 = memberData.month1 || {};
            const m2 = memberData.month2 || {};
            
            const mm1 = m1.mm || 0;
            const mm2 = m2.mm || 0;
            const mmDiff = mm2 - mm1;
            
            const contrib1 = m1.contribution2 || m1.contribution1 || 0;
            const contrib2 = m2.contribution2 || m2.contribution1 || 0;
            const contribDiff = contrib2 - contrib1;
            
            // ìµœì¢… ì„±ê³¼ê¸ˆ ê°€ì ¸ì˜¤ê¸°
            const final1 = data1.finalEval[channelId]?.members[memberId] || 0;
            const final2 = data2.finalEval[channelId]?.members[memberId] || 0;
            const finalDiff = final2 - final1;
            
            // ì •ìˆ˜ë¡œ í‘œì‹œ (.0 ì œê±°)
            const formatAmount = (amount) => {
                return amount % 1 === 0 ? amount.toString() : amount.toFixed(1);
            };
            
            html += `
                <tr>
                    <td>${memberData.name}</td>
                    <td>${memberData.teamName}</td>
                    <td>${mm1}</td>
                    <td>${mm2}</td>
                    <td class="${mmDiff >= 0 ? 'positive-change' : 'negative-change'}">
                        ${mmDiff >= 0 ? '+' : ''}${mmDiff.toFixed(1)}
                    </td>
                    <td>${contrib1}%</td>
                    <td>${contrib2}%</td>
                    <td class="${contribDiff >= 0 ? 'positive-change' : 'negative-change'}">
                        ${contribDiff >= 0 ? '+' : ''}${contribDiff}%
                    </td>
                    <td>${formatAmount(final1/10000)}ë§Œì›</td>
                    <td>${formatAmount(final2/10000)}ë§Œì›</td>
                    <td class="${finalDiff >= 0 ? 'positive-change' : 'negative-change'}">
                        ${finalDiff >= 0 ? '+' : ''}${formatAmount(finalDiff/10000)}ë§Œì›
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
            </div>
        `;
    });
    
    area.innerHTML = html;
}
</script>
