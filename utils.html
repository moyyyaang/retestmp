<script>
// ===== ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ =====
let evaluationData = {
    teams: {},
    members: [],
    channels: [],
    teamleads: [],
    firstEvaluation: {},
    secondEvaluation: {},
    finalEvaluation: {},
    currentChannels: {},
    currentChannelMembers: [],
    existingEvaluations: {},
    selectedChannels: [],
    evaluationMode: 'new',
    currentEvalMonth: '',
    currentTeamleadId: '',
    currentEvalInfo: null,
    secondEvalTeamFilter: null,
    finalEvalTeamFilter: null
};

// ===== í…Œë§ˆ ì‹œìŠ¤í…œ (ì™„ì „íˆ ìƒˆë¡œ êµ¬í˜„) =====
function applyDarkMode() {
    document.body.classList.remove('light-theme');
    document.body.classList.add('dark-theme');
    
    const elements = document.querySelectorAll('select, input, textarea');
    elements.forEach(el => {
        el.style.backgroundColor = '#0f0f0f';
        el.style.color = '#f1f1f1';
        el.style.border = '1px solid #3f3f3f';
    });
    
    const problemSelects = document.querySelectorAll('[id^="teamSelect_"], [id^="memberSelect_"], #managementTeamFilter, #evaluationTeamSelect');
    problemSelects.forEach(select => {
        select.style.setProperty('background-color', '#0f0f0f', 'important');
        select.style.setProperty('color', '#f1f1f1', 'important');
        select.style.setProperty('border', '1px solid #3f3f3f', 'important');
    });
}

function applyLightMode() {
    document.body.classList.remove('dark-theme');
    document.body.classList.add('light-theme');
    
    const elements = document.querySelectorAll('select, input, textarea');
    elements.forEach(el => {
        el.style.backgroundColor = '#ffffff';
        el.style.color = '#333333';
        el.style.border = '1px solid #cccccc';
    });
    
    const problemSelects = document.querySelectorAll('[id^="teamSelect_"], [id^="memberSelect_"], #managementTeamFilter, #evaluationTeamSelect');
    problemSelects.forEach(select => {
        select.style.setProperty('background-color', '#ffffff', 'important');
        select.style.setProperty('color', '#333333', 'important');
        select.style.setProperty('border', '1px solid #cccccc', 'important');
    });
}

function forceDarkMode() {
    // í˜„ì¬ í…Œë§ˆ ìƒíƒœ í™•ì¸
    const currentTheme = localStorage.getItem('theme') || 'dark';
    if (currentTheme === 'dark') {
        applyDarkMode();
    } else {
        applyLightMode();
    }
}

// DOM ë³€ê²½ ê°ì§€
const observer = new MutationObserver(function(mutations) {
    forceDarkMode();
});

observer.observe(document.body, {
    childList: true,
    subtree: true
});

// ===== ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ìˆ˜ì •ëœ ë²„ì „) =====
function loadInitialData() {
    showLoading(true);
    
    // ìµœì í™”ëœ í•¨ìˆ˜ ì‚¬ìš©
    google.script.run
        .withSuccessHandler(function(data) {
            console.log('ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹  (ìµœì í™”):', data);
            evaluationData.teams = data.teams;
            evaluationData.members = data.members;
            evaluationData.channels = data.channels;
            evaluationData.teamleads = data.teamleads;
            
            updateAllSelectors();
            
            // ë‚ ì§œ ì´ˆê¸°í™” - ì—¬ê¸°ì— ëª¨ë“  ë³€ìˆ˜ ì •ì˜
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // 1-12
            
            // ì „ì›” ê³„ì‚° - prevDate ì •ì˜
            let prevYear = currentYear;
            let prevMonth = currentMonth - 1;
            if (prevMonth === 0) {
                prevMonth = 12;
                prevYear = currentYear - 1;
            }

             const prevMonthStr = String(prevMonth).padStart(2, '0');
            
            // 1ì°¨ í‰ê°€ - ì „ì›”ë¡œ ì„¤ì •
            if (document.getElementById('evalYear')) {
                document.getElementById('evalYear').value = prevYear;
                document.getElementById('evalMonthSelect').value = prevMonthStr;
                document.getElementById('evalMonth').value = `${prevYear}-${prevMonthStr}`;
            }
            
            // 2ì°¨ í‰ê°€ - ì „ì›”ë¡œ ì„¤ì •
            if (document.getElementById('evalYear2nd')) {
                document.getElementById('evalYear2nd').value = prevYear;
                document.getElementById('evalMonthSelect2nd').value = prevMonthStr;
                document.getElementById('evalMonth2nd').value = `${prevYear}-${prevMonthStr}`;
            }
            
            // 3ì°¨ í‰ê°€ - ì „ì›”ë¡œ ì„¤ì •
            if (document.getElementById('evalYearFinal')) {
                document.getElementById('evalYearFinal').value = prevYear;
                document.getElementById('evalMonthSelectFinal').value = prevMonthStr;
                document.getElementById('evalMonthFinal').value = `${prevYear}-${prevMonthStr}`;
            }
            
            // ëŒ€ì‹œë³´ë“œ ë¹„êµ ë‚ ì§œ ì„¤ì •
            if (currentUser.level >= 3) {
                if (document.getElementById('compareYear1')) {
                    // ì „ì „ì›” ê³„ì‚°
                    let prevPrevYear = prevYear;
                    let prevPrevMonth = prevMonth - 1;
                    if (prevPrevMonth === 0) {
                        prevPrevMonth = 12;
                        prevPrevYear = prevYear - 1;
                    }
                    const prevPrevMonthStr = String(prevPrevMonth).padStart(2, '0');
                    
                    document.getElementById('compareYear1').value = prevPrevYear;
                    document.getElementById('compareMonth1Select').value = prevPrevMonthStr;
                    window.compareMonth1 = `${prevPrevYear}-${prevPrevMonthStr}`;
                    
                    document.getElementById('compareYear2').value = prevYear;
                    document.getElementById('compareMonth2Select').value = prevMonthStr;
                    window.compareMonth2 = `${prevYear}-${prevMonthStr}`;
                }
            }
            
            setTimeout(forceDarkMode, 100);
            
            // ë¡œë”© ì¢…ë£Œ
            showLoading(false);
            console.log('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
            
            // íŒ€ì¥ ì„ íƒì´ ìˆìœ¼ë©´ í‰ê°€ í™•ì¸
            if (document.getElementById('teamleadSelect') && document.getElementById('teamleadSelect').value && 
                document.getElementById('evalMonth') && document.getElementById('evalMonth').value) {
                setTimeout(() => {
                    if (typeof checkExistingEvaluation === 'function') {
                        checkExistingEvaluation();
                    }
                }, 100);
            }
        })
        .withFailureHandler(function(error) {
            showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getInitialDataOptimized();
}

// ===== ê°œì„ ëœ ìºì‹œ ì‹œìŠ¤í…œ =====
const advancedCache = {
    data: new Map(),
    maxSize: 50, // ìµœëŒ€ ìºì‹œ ê°œìˆ˜
    maxAge: 10 * 60 * 1000, // 10ë¶„ TTL
    
    set(key, value) {
        // ìºì‹œ í¬ê¸° ì œí•œ
        if (this.data.size >= this.maxSize) {
            const firstKey = this.data.keys().next().value;
            this.data.delete(firstKey);
        }
        
        this.data.set(key, {
            value: value,
            timestamp: Date.now()
        });
    },
    
    get(key) {
        const cached = this.data.get(key);
        if (!cached) return null;
        
        // TTL í™•ì¸
        if (Date.now() - cached.timestamp > this.maxAge) {
            this.data.delete(key);
            return null;
        }
        
        return cached.value;
    },
    
    clear() {
        this.data.clear();
    }
};

// ===== í‰ê°€ ë°ì´í„°ëŠ” í•„ìš”í•  ë•Œë§Œ ë¡œë“œ (ê°œì„ ëœ ë²„ì „) =====
function loadEvaluationDataOnDemand(evalMonth, type) {
    const cacheKey = `${type}_${evalMonth}`;
    
    // ê³ ê¸‰ ìºì‹œ í™•ì¸
    const cached = advancedCache.get(cacheKey);
    if (cached) {
        console.log(`ğŸš€ ìºì‹œì—ì„œ ${type} ë°ì´í„° ë¡œë“œ (${evalMonth})`);
        return Promise.resolve(cached);
    }
    
    // sessionStorage ë°±ì—… í™•ì¸
    const sessionCached = sessionStorage.getItem(cacheKey);
    if (sessionCached) {
        try {
            const data = JSON.parse(sessionCached);
            advancedCache.set(cacheKey, data);
            console.log(`ğŸ’¾ ì„¸ì…˜ì—ì„œ ${type} ë°ì´í„° ë³µì› (${evalMonth})`);
            return Promise.resolve(data);
        } catch (e) {
            sessionStorage.removeItem(cacheKey);
        }
    }
    
    console.log(`ğŸ“¡ ì„œë²„ì—ì„œ ${type} ë°ì´í„° ë¡œë“œ (${evalMonth})`);
    return new Promise((resolve, reject) => {
        const startTime = performance.now();
        
        google.script.run
            .withSuccessHandler(data => {
                const loadTime = performance.now() - startTime;
                console.log(`â±ï¸ ${type} ë¡œë“œ ì‹œê°„: ${loadTime.toFixed(2)}ms`);
                
                // ìºì‹œì— ì €ì¥
                advancedCache.set(cacheKey, data);
                sessionStorage.setItem(cacheKey, JSON.stringify(data));
                
                resolve(data);
            })
            .withFailureHandler(reject)
            [`get${type}EvaluationDataOptimized`](evalMonth);
    });
}

// ===== ì´ˆê¸° ë¡œë“œ ìµœì í™” ë²„ì „ =====
function loadInitialDataOptimized() {
    perfMonitor.start('initialLoad');
    showLoading(true);
    
    // ìºì‹œ í™•ì¸
    const cacheKey = 'initialData';
    const cached = dataCache.get(cacheKey);
    
    if (cached) {
        console.log('ìºì‹œì—ì„œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ');
        processInitialData(cached);
        showLoading(false);
        perfMonitor.end('initialLoad');
        return;
    }
    
    // ê¸°ì¡´ getInitialData ì‚¬ìš© (getCriticalDataê°€ ì—†ìœ¼ë¯€ë¡œ)
    google.script.run
        .withSuccessHandler(function(data) {
            dataCache.set(cacheKey, data);
            processInitialData(data);
            showLoading(false);
            perfMonitor.end('initialLoad');
        })
        .withFailureHandler(function(error) {
            showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
            perfMonitor.end('initialLoad');
        })
        .getInitialData();
}

function processInitialData(data) {
    evaluationData.teams = data.teams;
    evaluationData.members = data.members;
    evaluationData.channels = data.channels;
    evaluationData.teamleads = data.teamleads;
    updateAllSelectors();
    
    // í˜„ì¬ ë‚ ì§œ ì„¤ì • ë“± ì´ˆê¸°í™” ì‘ì—…
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
    const prevDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1);
    
    if (document.getElementById('evalYear')) {
        document.getElementById('evalYear').value = currentYear;
        document.getElementById('evalMonthSelect').value = currentMonth;
    }
}



// ===== updateAllSelectors í•¨ìˆ˜ ìˆ˜ì • =====
function updateAllSelectors() {
    // íŒ€ ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
    const teamSelects = ['newMemberTeam', 'newChannelTeam'];
    teamSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">íŒ€ ì„ íƒ</option>';
            for (const teamId in evaluationData.teams) {
                const option = document.createElement('option');
                option.value = teamId;
                option.textContent = evaluationData.teams[teamId].name;
                
                // ë ˆë²¨ 1 ì‚¬ìš©ìì˜ ê²½ìš° ìì‹ ì˜ íŒ€ë§Œ í™œì„±í™”
                if (currentUser.level === 1 && currentUser.teamId && teamId !== currentUser.teamId) {
                    option.disabled = true;
                }
                
                select.appendChild(option);
            }
        }
    });
    
    // íŒ€ì¥ ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
    const teamleadSelect = document.getElementById('teamleadSelect');
    if (teamleadSelect) {
        teamleadSelect.innerHTML = '<option value="">íŒ€ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        
        evaluationData.teamleads.forEach(teamlead => {
            if (!evaluationData.teams[teamlead.teamId]) {
                console.warn('íŒ€ ì •ë³´ ì—†ìŒ:', teamlead.teamId);
                return;
            }
            
            const option = document.createElement('option');
            option.value = teamlead.id;
            option.textContent = `${teamlead.name} (${evaluationData.teams[teamlead.teamId].name})`;
            option.dataset.email = teamlead.email || '';
            
            // í˜„ì¬ ì‚¬ìš©ìì™€ ì¼ì¹˜í•˜ë©´ ìë™ ì„ íƒ
            if (currentUser.email === teamlead.email) {
                option.selected = true;
            }
            
            // ë ˆë²¨ 1 ì‚¬ìš©ìëŠ” ìì‹ ë§Œ ì„ íƒ ê°€ëŠ¥
            if (currentUser.level === 1 && currentUser.email !== teamlead.email) {
                option.disabled = true;
                option.style.color = '#666';
            }
            
            teamleadSelect.appendChild(option);
        });
        
        // ìë™ ì„ íƒëœ ê²½ìš° í‰ê°€ í™•ì¸
        if (teamleadSelect.value) {
            console.log('íŒ€ì¥ ìë™ ì„ íƒë¨:', teamleadSelect.value);
            setTimeout(() => {
                if (document.getElementById('evalMonth') && document.getElementById('evalMonth').value) {
                    console.log('í‰ê°€ì›”ë„ ì„¤ì •ë¨, checkExistingEvaluation í˜¸ì¶œ');
                    if (typeof checkExistingEvaluation === 'function') {
                        checkExistingEvaluation();
                    }
                }
            }, 100);
        }
    }
    
    updateChannelSelectors();
    
    if (document.getElementById('memberList')) {
        updateMemberList();
    }
    if (document.getElementById('channelList')) {
        updateChannelList();
    }
    
    setTimeout(forceDarkMode, 50);
}

function updateChannelSelectors() {
    const select = document.getElementById('channelForMemberAssignment');
    if (select) {
        select.innerHTML = '<option value="">ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        evaluationData.channels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = `${channel.name} (${evaluationData.teams[channel.teamId].name})`;
            select.appendChild(option);
        });
    }
    
    forceDarkMode();
}

// ===== ê°œì„ ëœ ë¡œë”© ì‹œìŠ¤í…œ (ì¤‘ì²© ë°©ì§€ + ìë™ í•´ì œ) =====
let loadingStack = 0; // ë¡œë”© í˜¸ì¶œ ìŠ¤íƒ ì¶”ì 
let loadingTimeout = null; // ì•ˆì „ì¥ì¹˜ íƒ€ì´ë¨¸

function showLoading(show, message = 'ì²˜ë¦¬ì¤‘...') {
    const loading = document.getElementById('loadingSpinner');
    const overlay = document.getElementById('loadingOverlay');
    const container = document.querySelector('.container');
    
    if (show) {
        loadingStack++;
        console.log(`ğŸ”’ UI ì ê¸ˆ: ë¡œë”© ì¤‘... (ìŠ¤íƒ: ${loadingStack})`);
        
        // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
        loading.classList.add('show');
        overlay.classList.add('show');
        
        // ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        const loadingText = loading.querySelector('p');
        if (loadingText) {
            loadingText.textContent = message;
        }
        
        // ì²« ë²ˆì§¸ ë¡œë”©ì¼ ë•Œë§Œ UI ë¹„í™œì„±í™”
        if (loadingStack === 1) {
            const interactiveElements = document.querySelectorAll('button, input, select, textarea, .btn, .role-btn');
            interactiveElements.forEach(element => {
                element.classList.add('loading-disabled');
                element.setAttribute('data-was-disabled', element.disabled);
                element.disabled = true;
            });
            
            if (container) {
                container.classList.add('loading-disabled');
            }
        }
        
        // ì•ˆì „ì¥ì¹˜: 15ì´ˆ í›„ ê°•ì œ í•´ì œ
        if (loadingTimeout) clearTimeout(loadingTimeout);
        loadingTimeout = setTimeout(() => {
            console.warn('âš ï¸ ë¡œë”© íƒ€ì„ì•„ì›ƒ - ê°•ì œ í•´ì œ');
            forceUnlockUI();
        }, 15000);
        
    } else {
        loadingStack = Math.max(0, loadingStack - 1);
        console.log(`ğŸ”“ UI ì ê¸ˆ í•´ì œ ì‹œë„: (ìŠ¤íƒ: ${loadingStack})`);
        
        // ëª¨ë“  ë¡œë”©ì´ ì™„ë£Œë˜ì—ˆì„ ë•Œë§Œ UI í•´ì œ
        if (loadingStack === 0) {
            loading.classList.remove('show');
            overlay.classList.remove('show');
            
            // íƒ€ì´ë¨¸ í•´ì œ
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            
            // UI í™œì„±í™”
            const interactiveElements = document.querySelectorAll('.loading-disabled');
            interactiveElements.forEach(element => {
                element.classList.remove('loading-disabled');
                
                const wasDisabled = element.getAttribute('data-was-disabled');
                element.disabled = wasDisabled === 'true';
                element.removeAttribute('data-was-disabled');
            });
            
            if (container) {
                container.classList.remove('loading-disabled');
            }
            
            console.log('âœ… UI ì™„ì „ í•´ì œ ì™„ë£Œ');
        }
    }
}

// ê°•ì œ UI í•´ì œ í•¨ìˆ˜ (ì•ˆì „ì¥ì¹˜)
function forceUnlockUI() {
    loadingStack = 0;
    const loading = document.getElementById('loadingSpinner');
    const overlay = document.getElementById('loadingOverlay');
    const container = document.querySelector('.container');
    
    if (loading) loading.classList.remove('show');
    if (overlay) overlay.classList.remove('show');
    
    if (loadingTimeout) {
        clearTimeout(loadingTimeout);
        loadingTimeout = null;
    }
    
    const interactiveElements = document.querySelectorAll('.loading-disabled');
    interactiveElements.forEach(element => {
        element.classList.remove('loading-disabled');
        const wasDisabled = element.getAttribute('data-was-disabled');
        element.disabled = wasDisabled === 'true';
        element.removeAttribute('data-was-disabled');
    });
    
    if (container) {
        container.classList.remove('loading-disabled');
    }
    
    console.log('ğŸš¨ ê°•ì œ UI í•´ì œ ì™„ë£Œ');
}

// ===== ì•Œë¦¼ í‘œì‹œ (ìƒˆë¡œìš´ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‚¬ìš©) =====
function showAlert(message, type) {
    showNotification(message, type);
}

// ===== í‰ê°€ ìƒíƒœ ë¡œë“œ =====
function loadEvaluationStatus() {
    const evalMonth = document.getElementById('evalMonthFinal').value;
    if (!evalMonth) return;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(statusData) {
            displayEvaluationStatus(statusData);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            console.error('í‰ê°€ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', error);
            showLoading(false);
        })
        .getEvaluationStatus(evalMonth);
}

// ===== í‰ê°€ ìƒíƒœ í‘œì‹œ =====
function displayEvaluationStatus(statusData) {
    const grid = document.getElementById('evaluationStatusGrid');
    let html = '';
    
    for (const teamId in statusData) {
        const team = statusData[teamId];
        const statusClass = team.stage === 'ìµœì¢…ì™„ë£Œ' ? 'status-complete' : 
                           team.stage === '2ì°¨ì™„ë£Œ' ? 'status-second' : 
                           team.stage === '1ì°¨ì™„ë£Œ' ? 'status-first' : 'status-pending';
        
        html += `
            <div class="status-card ${statusClass}">
                <h4>${team.name}</h4>
                <div class="status-stage">${team.stage || 'ë¯¸ì§„í–‰'}</div>
                <div class="status-details">
                    <span>ì±„ë„: ${team.channelCount}ê°œ</span>
                    <span>íŒ€ì›: ${team.memberCount}ëª…</span>
                </div>
            </div>
        `;
    }
    
    grid.innerHTML = html;
}

// ===== íŒ€ì› ë¶„ì„ ë¡œë“œ =====
function loadTeamMembersForAnalysis() {
    const teamId = document.getElementById('analysisTeamSelect').value;
    const memberSelect = document.getElementById('analysisMemberSelect');
    
    if (!teamId) {
        memberSelect.innerHTML = '<option value="">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        return;
    }
    
    // íŒ€ì› ëª©ë¡
    const teamMembers = evaluationData.members.filter(m => m.teamId === teamId);
    
    // íŒ€ì¥ ì°¾ê¸°
    const teamleader = evaluationData.teamleads.find(tl => tl.teamId === teamId);
    
    memberSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    
    // íŒ€ì¥ ë¨¼ì € ì¶”ê°€
    if (teamleader) {
        const option = document.createElement('option');
        option.value = `TL_${teamleader.id}`; // íŒ€ì¥ì€ TL_ ì ‘ë‘ì‚¬ ì¶”ê°€
        option.textContent = `ğŸ‘” ${teamleader.name} (íŒ€ì¥)`;
        option.style.fontWeight = 'bold';
        option.style.color = '#1a73e8';
        memberSelect.appendChild(option);
    }
    
    // íŒ€ì›ë“¤ ì¶”ê°€
    teamMembers.forEach(member => {
        const option = document.createElement('option');
        option.value = member.id;
        option.textContent = member.name;
        memberSelect.appendChild(option);
    });
}

// ===== ê°œì¸ë³„ ë¶„ì„ ì‹¤í–‰ =====
function loadIndividualAnalysis() {
    const memberId = document.getElementById('analysisMemberSelect').value;
    if (!memberId) {
        showNotification('ë¶„ì„í•  íŒ€ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(data) {
            displayIndividualAnalysis(data);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ê°œì¸ ë¶„ì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getIndividualYearlyData(memberId);
}

// ===== ê°œì¸ë³„ ë¶„ì„ í‘œì‹œ =====
function displayIndividualAnalysis(yearlyData) {
    const area = document.getElementById('individualAnalysisArea');
    const memberName = document.getElementById('analysisMemberSelect').selectedOptions[0].text;
    
    let html = `<h3>ğŸ“Š ${memberName}ë‹˜ì˜ ì—°ê°„ ì„±ê³¼ ë¶„ì„</h3>`;
    
    let totalAmount = 0;
    let monthCount = 0;
    const monthlyData = [];
    
    for (const month in yearlyData) {
        const data = yearlyData[month];
        if (data.finalAmount) {
            totalAmount += data.finalAmount;
            monthCount++;
        }
        monthlyData.push({
            month: month,
            amount: data.finalAmount || 0,
            mm: data.mm || 0,
            contribution: data.contribution2 || data.contribution1 || 0
        });
    }
    
    html += `
        <div class="summary-box">
            <h4>ì—°ê°„ ìš”ì•½</h4>
            <div class="summary-item">
                <span class="summary-label">ì´ ì„±ê³¼ê¸ˆ:</span>
                <span class="summary-value amount">${(totalAmount/10000).toFixed(1)}ë§Œì›</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">í‰ê·  ì›” ì„±ê³¼ê¸ˆ:</span>
                <span class="summary-value amount">${monthCount > 0 ? (totalAmount/monthCount/10000).toFixed(1) : 0}ë§Œì›</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">í‰ê°€ ì™„ë£Œ ì›”:</span>
                <span class="summary-value">${monthCount}ê°œì›”</span>
            </div>
        </div>
    `;
    
    html += `
        <h4>ì›”ë³„ ìƒì„¸ ë‚´ì—­</h4>
        <table class="evaluation-table">
            <thead>
                <tr>
                    <th>í‰ê°€ì›”</th>
                    <th>ì±„ë„ëª…</th>
                    <th>íˆ¬ì… MM</th>
                    <th>ê¸°ì—¬ë„</th>
                    <th>ì„±ê³¼ê¸ˆ</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    monthlyData.sort((a, b) => a.month.localeCompare(b.month));
    
    monthlyData.forEach(data => {
        const monthData = yearlyData[data.month];
        html += `
            <tr>
                <td>${data.month}</td>
                <td>${monthData.channelName || '-'}</td>
                <td>${data.mm}</td>
                <td>${data.contribution}%</td>
                <td class="amount">${data.amount ? (data.amount/10000).toFixed(1) + 'ë§Œì›' : '-'}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    
    html += `
        <div style="margin-top: 30px;">
            <canvas id="individualChart"></canvas>
        </div>
    `;
    
    area.innerHTML = html;
    
    setTimeout(() => {
        drawIndividualChart(monthlyData);
    }, 100);
}

// ===== ê°œì¸ë³„ ì°¨íŠ¸ ê·¸ë¦¬ê¸° =====
function drawIndividualChart(monthlyData) {
    const ctx = document.getElementById('individualChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthlyData.map(d => d.month),
            datasets: [{
                label: 'ì›”ë³„ ì„±ê³¼ê¸ˆ (ë§Œì›)',
                data: monthlyData.map(d => d.amount / 10000),
                borderColor: '#1a73e8',
                backgroundColor: 'rgba(26, 115, 232, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'ì›”ë³„ ì„±ê³¼ê¸ˆ ì¶”ì´'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'ë§Œì›';
                        }
                    }
                }
            }
        }
    });
}

// ===== íŠ¸ë Œë“œ ì˜µì…˜ ì—…ë°ì´íŠ¸ =====
function updateTrendOptions() {
    const type = document.getElementById('trendType').value;
    const targetSelect = document.getElementById('trendTarget');
    
    targetSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    
    if (type === 'team') {
        for (const teamId in evaluationData.teams) {
            const option = document.createElement('option');
            option.value = teamId;
            option.textContent = evaluationData.teams[teamId].name;
            targetSelect.appendChild(option);
        }
    } else {
        evaluationData.channels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = channel.name;
            targetSelect.appendChild(option);
        });
    }
}

// ===== íŠ¸ë Œë“œ ë¶„ì„ ë¡œë“œ =====
function loadTrendAnalysis() {
    const type = document.getElementById('trendType').value;
    const target = document.getElementById('trendTarget').value;
    const period = document.getElementById('trendPeriod').value;
    
    if (!target) {
        showNotification('ë¶„ì„ ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(data) {
            drawTrendChart(data, type);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('íŠ¸ë Œë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getTrendData(type, target, period);
}

// ===== íŠ¸ë Œë“œ ì°¨íŠ¸ ê·¸ë¦¬ê¸° =====
function drawTrendChart(data, type) {
    const ctx = document.getElementById('trendChart').getContext('2d');
    
    if (window.trendChartInstance) {
        window.trendChartInstance.destroy();
    }
    
    window.trendChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'ì´ ì„±ê³¼ê¸ˆ (ë§Œì›)',
                data: data.amounts.map(a => a / 10000),
                backgroundColor: 'rgba(26, 115, 232, 0.5)',
                borderColor: '#1a73e8',
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'í‰ê·  ê¸°ì—¬ë„ (%)',
                data: data.contributions,
                type: 'line',
                yAxisID: 'y1',
                borderColor: '#27ae60',
                backgroundColor: 'rgba(39, 174, 96, 0.1)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: type === 'team' ? 'íŒ€ë³„ ì„±ê³¼ íŠ¸ë Œë“œ' : 'ì±„ë„ë³„ ì„±ê³¼ íŠ¸ë Œë“œ'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    ticks: {
                        callback: function(value) {
                            return value + 'ë§Œì›';
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// ===== ê¶Œí•œ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
function loadPermissionsList() {
    console.log('=== loadPermissionsList í•¨ìˆ˜ ì‹¤í–‰ ===');
    console.log('í˜„ì¬ ì‚¬ìš©ì:', JSON.stringify(currentUser, null, 2));
    
    // ê¶Œí•œ í™•ì¸
    if (!currentUser) {
        console.error('âŒ currentUser ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
        showNotification('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    if (currentUser.level < 3) {
        console.error('âŒ ê¶Œí•œ ë¶€ì¡±:', currentUser.level);
        showNotification(`ê¶Œí•œ ê´€ë¦¬ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (í˜„ì¬ ë ˆë²¨: ${currentUser.level}, í•„ìš”: 3)`, 'error');
        return;
    }
    
    console.log('âœ… ê¶Œí•œ í™•ì¸ í†µê³¼ (ë ˆë²¨:', currentUser.level, ')');
    
    // DOM ìš”ì†Œ í™•ì¸
    const listDiv = document.getElementById('permissionsList');
    console.log('permissionsList ìš”ì†Œ:', listDiv);
    if (!listDiv) {
        console.error('permissionsList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        showNotification('í˜ì´ì§€ êµ¬ì„± ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    // ì„ì‹œë¡œ ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
    listDiv.innerHTML = '<p style="text-align: center; padding: 20px;">ê¶Œí•œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
    
    console.log('ì„œë²„ í˜¸ì¶œ ì‹œì‘...');
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(permissions) {
            console.log('âœ… ê¶Œí•œ ëª©ë¡ ë°›ìŒ:', JSON.stringify(permissions, null, 2));
            console.log('ë°ì´í„° íƒ€ì…:', typeof permissions);
            console.log('Array ì—¬ë¶€:', Array.isArray(permissions));
            
            if (permissions && Array.isArray(permissions)) {
                console.log('ê¶Œí•œ ëª©ë¡ ê°œìˆ˜:', permissions.length);
                displayPermissionsList(permissions);
                showNotification(`ê¶Œí•œ ëª©ë¡ ë¡œë“œ ì„±ê³µ (${permissions.length}ê°œ)`, 'success');
            } else {
                console.error('âŒ ì˜ëª»ëœ ê¶Œí•œ ë°ì´í„°:', permissions);
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: red;">
                        <h4>âŒ ê¶Œí•œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h4>
                        <p>ë°ì´í„° íƒ€ì…: ${typeof permissions}</p>
                        <p>Array ì—¬ë¶€: ${Array.isArray(permissions)}</p>
                        <p>ë‚´ìš©: ${JSON.stringify(permissions)}</p>
                        <button onclick="loadPermissionsList()" style="margin-top: 10px; padding: 5px 10px;">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
                showNotification('ê¶Œí•œ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            console.error('âŒ ê¶Œí•œ ëª©ë¡ ë¡œë“œ ì—ëŸ¬:', error);
            console.error('ì—ëŸ¬ íƒ€ì…:', typeof error);
            console.error('ì—ëŸ¬ ë‚´ìš©:', JSON.stringify(error, null, 2));
            
            listDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: red;">
                    <h4>âŒ ì„œë²„ í˜¸ì¶œ ì‹¤íŒ¨</h4>
                    <p><strong>ì—ëŸ¬ ë©”ì‹œì§€:</strong> ${error}</p>
                    <p><strong>ì—ëŸ¬ íƒ€ì…:</strong> ${typeof error}</p>
                    <details style="margin-top: 10px;">
                        <summary>ìƒì„¸ ì •ë³´</summary>
                        <pre style="text-align: left; font-size: 12px;">${JSON.stringify(error, null, 2)}</pre>
                    </details>
                    <button onclick="loadPermissionsList()" style="margin-top: 10px; padding: 5px 10px; cursor: pointer;">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>
                </div>
            `;
            showNotification('ê¶Œí•œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getPermissionsList();
}

function displayPermissionsList(permissions) {
    console.log('=== displayPermissionsList í•¨ìˆ˜ ì‹¤í–‰ ===');
    console.log('ë°›ì€ ê¶Œí•œ ë°ì´í„°:', permissions);
    console.log('ê¶Œí•œ ë°ì´í„° ê°œìˆ˜:', permissions.length);
    
    const listDiv = document.getElementById('permissionsList');
    console.log('permissionsList DOM ìš”ì†Œ:', listDiv);
    if (!listDiv) {
        console.error('âŒ permissionsList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    let html = `
        <table class="evaluation-table">
            <thead>
                <tr>
                    <th>ì´ë©”ì¼</th>
                    <th>ì´ë¦„</th>
                    <th>ë¶€ì„œ</th>
                    <th>ê¶Œí•œë ˆë²¨</th>
                    <th>ìƒíƒœ</th>
                    <th>ë“±ë¡ì¼ì‹œ</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    permissions.forEach(user => {
        const levelText = user.level === 1 ? '1ì°¨ í‰ê°€' : user.level === 2 ? '1-2ì°¨ í‰ê°€' : 'ì „ì²´ ê¶Œí•œ';
        const statusClass = user.active === 'Y' ? 'positive-change' : 'negative-change';
        const statusText = user.active === 'Y' ? 'í™œì„±' : 'ë¹„í™œì„±';
        
        html += `
            <tr>
                <td>${user.email}</td>
                <td>${user.name}</td>
                <td>${user.department}</td>
                <td>
                    <select onchange="updateUserLevel('${user.email}', this.value)" ${user.email === currentUser.email ? 'disabled' : ''}>
                        <option value="1" ${user.level === 1 ? 'selected' : ''}>1 - 1ì°¨ í‰ê°€ë§Œ</option>
                        <option value="2" ${user.level === 2 ? 'selected' : ''}>2 - 1ì°¨/2ì°¨ í‰ê°€</option>
                        <option value="3" ${user.level === 3 ? 'selected' : ''}>3 - ì „ì²´ ê¶Œí•œ</option>
                    </select>
                </td>
                <td class="${statusClass}">${statusText}</td>
                <td>${user.registeredDate}</td>
                <td>
                    <button class="btn ${user.active === 'Y' ? 'btn-danger' : 'btn-success'}" 
                            style="padding: 5px 10px; font-size: 12px;"
                            onclick="toggleUserStatus('${user.email}')"
                            ${user.email === currentUser.email ? 'disabled' : ''}>
                        ${user.active === 'Y' ? 'ğŸ”’ ë¹„í™œì„±í™”' : 'ğŸ”“ í™œì„±í™”'}
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    
    console.log('ìƒì„±ëœ HTML ê¸¸ì´:', html.length);
    console.log('HTML ë¯¸ë¦¬ë³´ê¸°:', html.substring(0, 200) + '...');
    
    // DOMì— HTML ì ìš©
    listDiv.innerHTML = html;
    
    // ê°•ì œë¡œ ê°€ì‹œì„± ë³´ì¥
    listDiv.style.display = 'block';
    listDiv.style.visibility = 'visible';
    listDiv.style.opacity = '1';
    listDiv.style.width = '100%';
    
    // í…Œì´ë¸” ìš”ì†Œë„ ê°•ì œ ê°€ì‹œì„± ë³´ì¥
    const table = listDiv.querySelector('.evaluation-table');
    if (table) {
        table.style.display = 'table';
        table.style.width = '100%';
        table.style.visibility = 'visible';
        table.style.opacity = '1';
        console.log('âœ… í…Œì´ë¸” ê°€ì‹œì„± ê°•ì œ ì ìš©');
    }
    
    console.log('âœ… HTMLì´ DOMì— ì ìš©ë¨');
    console.log('listDiv.innerHTML ê¸¸ì´:', listDiv.innerHTML.length);
    console.log('listDiv ìŠ¤íƒ€ì¼ í™•ì¸:', {
        display: listDiv.style.display,
        visibility: listDiv.style.visibility,
        opacity: listDiv.style.opacity,
        width: listDiv.style.width
    });
}

function addNewUser() {
    const email = document.getElementById('newUserEmail').value.trim();
    const name = document.getElementById('newUserName').value.trim();
    const department = document.getElementById('newUserDept').value.trim();
    const level = document.getElementById('newUserLevel').value;
    
    if (!email || !name || !department) {
        showNotification('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    if (!email.endsWith('@awesomeent.kr')) {
        showNotification('íšŒì‚¬ ì´ë©”ì¼(@awesomeent.kr)ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification(result.message, 'success');
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserDept').value = '';
                document.getElementById('newUserLevel').value = '1';
                loadPermissionsList();
            } else {
                showNotification(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .addUserPermission({
            email: email,
            name: name,
            department: department,
            level: parseInt(level)
        });
}

function updateUserLevel(email, newLevel) {
    if (!confirm(`${email}ì˜ ê¶Œí•œì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        loadPermissionsList();
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            showNotification(result.message, result.success ? 'success' : 'error');
            loadPermissionsList();
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ê¶Œí•œ ìˆ˜ì • ì‹¤íŒ¨: ' + error, 'error');
            loadPermissionsList();
            showLoading(false);
        })
        .updateUserPermission(email, parseInt(newLevel));
}

function toggleUserStatus(email) {
    const action = confirm(`${email}ì˜ ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    if (!action) return;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            showNotification(result.message, result.success ? 'success' : 'error');
            loadPermissionsList();
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .toggleUserActive(email);
}

function loadActionLogs() {
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(logs) {
            displayActionLogs(logs);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì•¡ì…˜ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getActionLogs(50);
}

function displayActionLogs(logs) {
    const logsDiv = document.getElementById('actionLogsList');
    
    if (!logsDiv) {
        console.error('actionLogsList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    if (logs.length === 0) {
        logsDiv.innerHTML = '<p style="text-align: center; color: #aaa;">ì•¡ì…˜ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    let html = `
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="evaluation-table">
                <thead>
                    <tr>
                        <th>ì¼ì‹œ</th>
                        <th>ì‚¬ìš©ì</th>
                        <th>ì•¡ì…˜</th>
                        <th>ìƒì„¸ë‚´ìš©</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    logs.forEach(log => {
        html += `
            <tr>
                <td>${log.timestamp}</td>
                <td>${log.user}</td>
                <td>${log.action}</td>
                <td>${log.details}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    logsDiv.innerHTML = html;
}

// ===== ì—­í•  ì „í™˜ í•¨ìˆ˜ =====
function switchRole(role) {
    console.log('ğŸ¯ switchRole í•¨ìˆ˜ í˜¸ì¶œë¨, role:', role);
    console.log('currentUser:', currentUser);
    
    document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.role-content').forEach(content => content.classList.remove('active'));
    
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    if (role === 'management') {
        document.getElementById('managementContent').classList.add('active');
    } else if (role === 'teamlead') {
        if (currentUser.level < 1) {
            showNotification('1ì°¨ í‰ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        document.getElementById('teamleadContent').classList.add('active');
    } else if (role === 'manager') {
        if (currentUser.level < 2) {
            showNotification('2ì°¨ í‰ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        document.getElementById('managerContent').classList.add('active');
    } else if (role === 'executive') {
        if (currentUser.level < 3) {
            showNotification('ìµœì¢… í‰ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        document.getElementById('executiveContent').classList.add('active');
    } else if (role === 'dashboard') {
        if (currentUser.level < 3) {
            showNotification('ëŒ€ì‹œë³´ë“œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        document.getElementById('dashboardContent').classList.add('active');
    } else if (role === 'permission') {
        if (currentUser.level < 3) {
            showNotification('ê¶Œí•œ ê´€ë¦¬ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        const permissionContent = document.getElementById('permissionContent');
        console.log('=== ê¶Œí•œê´€ë¦¬ í˜ì´ì§€ í™œì„±í™” ì‹œë„ ===');
        console.log('permissionContent ìš”ì†Œ:', permissionContent);
        console.log('permissionContent ì¡´ì¬:', !!permissionContent);
        console.log('currentUser.level:', currentUser.level);
        
        if (permissionContent) {
            console.log('permissionContentì˜ í˜„ì¬ display:', getComputedStyle(permissionContent).display);
            console.log('permissionContentì˜ í˜„ì¬ í´ë˜ìŠ¤:', permissionContent.className);
        }
        
        if (permissionContent) {
            // ë‹¤ë¥¸ ëª¨ë“  í˜ì´ì§€ ë¹„í™œì„±í™” ë¨¼ì €
            document.querySelectorAll('.role-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ê¶Œí•œê´€ë¦¬ í˜ì´ì§€ í™œì„±í™”
            permissionContent.classList.add('active');
            permissionContent.style.setProperty('display', 'block', 'important');
            permissionContent.style.setProperty('visibility', 'visible', 'important');
            permissionContent.style.setProperty('opacity', '1', 'important');
            permissionContent.style.setProperty('position', 'relative', 'important');
            permissionContent.style.setProperty('z-index', '999', 'important');
            
            console.log('âœ… ê¶Œí•œ ê´€ë¦¬ í˜ì´ì§€ í™œì„±í™”ë¨');
            console.log('permissionContent.classList:', permissionContent.classList.toString());
            console.log('permissionContentì˜ í™œì„±í™” í›„ display:', getComputedStyle(permissionContent).display);
            console.log('permissionContentì˜ í™œì„±í™” í›„ visibility:', getComputedStyle(permissionContent).visibility);
            console.log('permissionContentì˜ í™œì„±í™” í›„ opacity:', getComputedStyle(permissionContent).opacity);
            
            // ê°•ì œ ìŠ¤íƒ€ì¼ ì¬ì ìš© (ìµœì¢… ì•ˆì „ì¥ì¹˜)
            setTimeout(() => {
                if (getComputedStyle(permissionContent).display === 'none') {
                    console.warn('âš ï¸ CSS ê°•ì œ ì¬ì ìš© í•„ìš”');
                    permissionContent.setAttribute('style', 
                        'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 999 !important;'
                    );
                    console.log('ğŸ”§ CSS ê°•ì œ ì¬ì ìš© ì™„ë£Œ');
                }
            }, 50);
            
            // ê¶Œí•œ ëª©ë¡ ë¡œë“œ
            setTimeout(() => {
                console.log('ğŸ”„ loadPermissionsList í˜¸ì¶œ ì‹œë„');
                loadPermissionsList();
            }, 100);
        } else {
            console.error('âŒ permissionContent ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            showNotification('ê¶Œí•œ ê´€ë¦¬ í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    setTimeout(forceDarkMode, 20);
}

// ===== ë””ë²„ê¹… í•¨ìˆ˜ =====
function checkDataStatus() {
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(status) {
            console.log('=== ë°ì´í„° ìƒíƒœ ===');
            for (const sheet in status) {
                console.log(`${sheet}: ${status[sheet].rows}í–‰`);
                console.log('ìƒ˜í”Œ ë°ì´í„°:', status[sheet].sample);
            }
            showLoading(false);
            showNotification('ì½˜ì†”ì—ì„œ ë°ì´í„° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'success');
        })
        .withFailureHandler(function(error) {
            showNotification('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .checkDataStatus();
}

// ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” =====
document.addEventListener('DOMContentLoaded', function() {
    forceDarkMode();
});

window.addEventListener('load', function() {
    forceDarkMode();
});

// ===== window.onload í•¨ìˆ˜ =====
window.onload = function() {
    console.log('í˜ì´ì§€ ë¡œë“œ ì‹œì‘ - currentUser:', currentUser);
    
    loadInitialData();
    
    setTimeout(() => {
        if (currentUser.level >= 1) {
            console.log('1ì°¨ í‰ê°€ í™”ë©´ìœ¼ë¡œ ì „í™˜');
            switchRole('teamlead');
            
            if (currentUser.level === 1 && currentUser.teamId) {
                setTimeout(() => {
                    const teamSelect = document.getElementById('evaluationTeamSelect');
                    if (teamSelect) {
                        for (let option of teamSelect.options) {
                            if (option.value && option.value !== currentUser.teamId) {
                                option.disabled = true;
                                option.style.color = '#666';
                            }
                        }
                        teamSelect.value = currentUser.teamId;
                        if (typeof loadTeamChannels === 'function') {
                            loadTeamChannels();
                        }
                    }
                }, 50);
            }
        } else {
            document.querySelector('.role-btn').click();
        }
    }, 50);
};

// ë‹¨ì¶•í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.addEventListener('keydown', function(e) {
    // Ctrl+S: í˜„ì¬ í‰ê°€ ì €ì¥
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        
        // í˜„ì¬ í™œì„±í™”ëœ í‰ê°€ í™”ë©´ í™•ì¸
        if (document.getElementById('teamleadContent').classList.contains('active')) {
            const submitBtn = document.getElementById('submitFirstEvalBtn');
            if (submitBtn && submitBtn.style.display !== 'none') {
                submitFirstEvaluation();
            }
        } else if (document.getElementById('managerContent').classList.contains('active')) {
            const submitBtn = document.getElementById('submitSecondEvalBtn');
            if (submitBtn && submitBtn.style.display !== 'none') {
                submitSecondEvaluation();
            }
        } else if (document.getElementById('executiveContent').classList.contains('active')) {
            const submitBtn = document.getElementById('submitFinalEvalBtn');
            if (submitBtn && submitBtn.style.display !== 'none') {
                submitFinalEvaluation();
            }
        }
    }
    
    // Esc: íŒì—… ë‹«ê¸°
    if (e.key === 'Escape') {
        // ì•Œë¦¼ íŒì—… ë‹«ê¸°
        const notification = document.getElementById('notificationPopup');
        if (notification && notification.classList.contains('show')) {
            closeNotification();
        }
        
        // ìƒì„¸ì •ë³´ íŒ¨ë„ ë‹«ê¸°
        const detailPanels = document.querySelectorAll('.detail-panel.show');
        detailPanels.forEach(panel => {
            panel.classList.remove('show');
        });
    }
});

// ===== í…Œë§ˆ í† ê¸€ ì‹œìŠ¤í…œ (ìˆ˜ì •ëœ ë²„ì „) =====
function toggleTheme() {
    const currentTheme = localStorage.getItem('theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    // í…Œë§ˆ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
        themeIcon.textContent = newTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
    }
    
    // í…Œë§ˆ ì €ì¥
    localStorage.setItem('theme', newTheme);
    
    // í…Œë§ˆ ì ìš©
    if (newTheme === 'dark') {
        applyDarkMode();
    } else {
        applyLightMode();
    }
    
    // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
    const themeBtn = document.getElementById('themeToggleBtn');
    if (themeBtn) {
        themeBtn.style.transform = 'rotate(360deg)';
        themeBtn.style.transition = 'transform 0.3s ease';
        setTimeout(() => {
            themeBtn.style.transform = '';
        }, 300);
    }
    
    showNotification(`${newTheme === 'dark' ? 'ğŸŒ™ ë‹¤í¬' : 'â˜€ï¸ ë¼ì´íŠ¸'} ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success', 2000);
}

// ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í…Œë§ˆ ì ìš© =====
function initializeTheme() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    
    // í…Œë§ˆ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
        themeIcon.textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
    }
    
    // í…Œë§ˆ ì ìš©
    if (savedTheme === 'dark') {
        applyDarkMode();
    } else {
        applyLightMode();
    }
}

// Tab í‚¤ëŠ” ê¸°ë³¸ ë™ì‘ ìœ ì§€ (ë‹¤ìŒ ì…ë ¥ í•„ë“œë¡œ ì´ë™)

// ===== ì´ì „ ë‹¬ ë°ì´í„° ë³µì‚¬ ê¸°ëŠ¥ =====
function copyFromPreviousMonth() {
    const currentMonth = document.getElementById('evalMonth').value;
    if (!currentMonth) {
        showNotification('í˜„ì¬ í‰ê°€ì›”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    // ì´ì „ ë‹¬ ê³„ì‚°
    const [year, month] = currentMonth.split('-');
    const previousDate = new Date(parseInt(year), parseInt(month) - 2, 1);
    const previousMonth = previousDate.toISOString().slice(0, 7);
    
    if (!confirm(`${previousMonth}ì˜ í‰ê°€ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    showLoading(true);
    
    // ì´ì „ ë‹¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.evaluations && Object.keys(result.evaluations).length > 0) {
                // í˜„ì¬ ì„ íƒëœ ì±„ë„ë“¤ì— ëŒ€í•´ ì´ì „ ë‹¬ ë°ì´í„° ì ìš©
                for (const channelId in result.evaluations) {
                    if (evaluationData.currentChannels[channelId]) {
                        const prevData = result.evaluations[channelId];
                        prevData.members.forEach(prevMember => {
                            // MM ê°’ ë³µì‚¬
                            const mmInput = document.getElementById(`mm_${channelId}_${prevMember.id}`);
                            if (mmInput) {
                                mmInput.value = prevMember.mm || '';
                            }
                            
                            // ê¸°ì—¬ë„ ë³µì‚¬
                            const contribInput = document.getElementById(`contrib_${channelId}_${prevMember.id}`);
                            if (contribInput) {
                                contribInput.value = prevMember.contribution1 || '';
                            }
                            
                            // ì„±ê³¼ ë³µì‚¬
                            const achievementContainer = document.getElementById(`achievements_${channelId}_${prevMember.id}`);
                            if (achievementContainer && prevMember.achievement) {
                                const achievements = prevMember.achievement.split('|');
                                achievementContainer.innerHTML = '';
                                achievements.forEach(achievement => {
                                    if (achievement.trim()) {
                                        const newItem = document.createElement('div');
                                        newItem.className = 'achievement-item';
                                        newItem.innerHTML = `
                                            <input type="text" placeholder="í•µì‹¬ ì„±ê³¼ ì…ë ¥" value="${achievement}">
                                            <button onclick="removeAchievement(this)" class="btn btn-danger" style="padding: 2px 8px; font-size: 12px;">âŒ</button>
                                        `;
                                        achievementContainer.appendChild(newItem);
                                    }
                                });
                            }
                        });
                        
                        // ì±„ë„ ì½”ë©˜íŠ¸ ë³µì‚¬
                        const channelCommentInput = document.getElementById(`channelCommentText_${channelId}`);
                        if (channelCommentInput && prevData.channelComment) {
                            channelCommentInput.value = prevData.channelComment;
                        }
                        
                        // í•©ê³„ ì—…ë°ì´íŠ¸
                        updateMMTotal(channelId);
                        updateContributionBar(channelId);
                    }
                }
                
                showNotification(`${previousMonth}ì˜ ë°ì´í„°ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.`, 'success');
            } else {
                showNotification(`${previousMonth}ì˜ í‰ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì´ì „ ë‹¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getFirstEvaluationByTeamlead(previousMonth, evaluationData.currentTeamleadId);
}

// ===== ì„±ëŠ¥ ìµœì í™”: ë°ì´í„° ìºì‹± =====
const dataCache = {
    channelMembers: {},
    evaluationData: {},
    cacheTimeout: 5 * 60 * 1000, // 5ë¶„
    
    set(key, data) {
        this[key] = {
            data: data,
            timestamp: Date.now()
        };
    },
    
    get(key) {
        const cached = this[key];
        if (cached && (Date.now() - cached.timestamp < this.cacheTimeout)) {
            return cached.data;
        }
        return null;
    },
    
    clear() {
        this.channelMembers = {};
        this.evaluationData = {};
    }
};

// ìºì‹±ì„ í™œìš©í•œ ì±„ë„ ë©¤ë²„ ë¡œë“œ
function loadChannelMembersWithCache(channelId) {
    const cached = dataCache.get(`channelMembers_${channelId}`);
    if (cached) {
        displayChannelMembers(channelId, cached);
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(members) {
            dataCache.set(`channelMembers_${channelId}`, members);
            displayChannelMembers(channelId, members);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì±„ë„ ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getChannelMembersData(channelId);
}

// ===== í˜ì´ì§• ì²˜ë¦¬ =====
const pagination = {
    pageSize: 20,
    currentPage: 1,
    
    paginate(data, page = 1) {
        const start = (page - 1) * this.pageSize;
        const end = start + this.pageSize;
        return {
            data: data.slice(start, end),
            totalPages: Math.ceil(data.length / this.pageSize),
            currentPage: page
        };
    }
};

// ===== ë¹„ë™ê¸° ì¼ê´„ ì²˜ë¦¬ =====
async function batchProcessChannels(channelIds, processor) {
    const batchSize = 5;
    const results = [];
    
    for (let i = 0; i < channelIds.length; i += batchSize) {
        const batch = channelIds.slice(i, i + batchSize);
        const batchPromises = batch.map(channelId => processor(channelId));
        const batchResults = await Promise.all(batchPromises);
        results.push(...batchResults);
        
        // ì§„í–‰ë¥  í‘œì‹œ
        const progress = Math.round((i + batch.length) / channelIds.length * 100);
        updateProgressBar(progress);
    }
    
    return results;
}

// ì§„í–‰ë¥  í‘œì‹œ í•¨ìˆ˜
function updateProgressBar(percentage) {
    let progressBar = document.getElementById('batchProgressBar');
    if (!progressBar) {
        progressBar = document.createElement('div');
        progressBar.id = 'batchProgressBar';
        progressBar.style.cssText = `
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 30px;
            background: #272727;
            border-radius: 15px;
            overflow: hidden;
            z-index: 9999;
        `;
        progressBar.innerHTML = `
            <div style="width: ${percentage}%; height: 100%; background: #1a73e8; transition: width 0.3s;">
                <span style="color: white; line-height: 30px; padding-left: 10px;">${percentage}%</span>
            </div>
        `;
        document.body.appendChild(progressBar);
    } else {
        const fill = progressBar.querySelector('div');
        fill.style.width = `${percentage}%`;
        fill.querySelector('span').textContent = `${percentage}%`;
    }
    
    if (percentage >= 100) {
        setTimeout(() => progressBar.remove(), 1000);
    }
}

// ===== ìë™ ì €ì¥ ê¸°ëŠ¥ =====
let autoSaveTimer = null;
let hasUnsavedChanges = false;

function markAsUnsaved() {
    hasUnsavedChanges = true;
    
    // ìë™ ì €ì¥ íƒ€ì´ë¨¸ ë¦¬ì…‹
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }
    
    // 5ë¶„ í›„ ìë™ ì €ì¥
    autoSaveTimer = setTimeout(() => {
        if (hasUnsavedChanges) {
            autoSave();
        }
    }, 5 * 60 * 1000);
}

function autoSave() {
    if (!hasUnsavedChanges) return;
    
    showNotification('ìë™ ì €ì¥ ì¤‘...', 'info');
    
    // í˜„ì¬ í™œì„±í™”ëœ í‰ê°€ í™”ë©´ì— ë”°ë¼ ì €ì¥
    if (document.getElementById('teamleadContent').classList.contains('active')) {
        const submitBtn = document.getElementById('submitFirstEvalBtn');
        if (submitBtn && submitBtn.style.display !== 'none') {
            submitFirstEvaluation();
        }
    } else if (document.getElementById('managerContent').classList.contains('active')) {
        submitSecondEvaluationSelective();
    } else if (document.getElementById('executiveContent').classList.contains('active')) {
        submitFinalEvaluationSelective();
    }
    
    hasUnsavedChanges = false;
}

// ì‹¤ì‹œê°„ ë™ê¸°í™” ì²´í¬
function checkForUpdates() {
    const evalMonth = document.getElementById('evalMonth')?.value || 
                     document.getElementById('evalMonth2nd')?.value || 
                     document.getElementById('evalMonthFinal')?.value;
                     
    if (!evalMonth) return;
    
    google.script.run
        .withSuccessHandler(function(conflict) {
            if (conflict.hasConflict) {
                showNotification(
                    `âš ï¸ ${conflict.lastUser}ë‹˜ì´ ${conflict.lastModified}ì— ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`,
                    'warning'
                );
            }
        })
        .withFailureHandler(function(error) {
            console.error('ì—…ë°ì´íŠ¸ í™•ì¸ ì‹¤íŒ¨:', error);
        })
        .checkForConflicts(evalMonth, null);
}

// 10ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸ í™•ì¸
setInterval(checkForUpdates, 10 * 60 * 1000);

// í˜ì´ì§€ ë‚˜ê°€ê¸° ì „ ê²½ê³ 
window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
    }
});

// ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€
document.addEventListener('input', function(e) {
    if (e.target.matches('input[type="number"], textarea')) {
        markAsUnsaved();
    }
});

// ===== ì±„ë„ MM í•©ê³„ ê³„ì‚° í•¨ìˆ˜ =====
function calculateChannelMMTotal(channelId) {
    let totalMM = 0;
    
    // 1ì°¨ í‰ê°€ í™”ë©´
    if (evaluationData.currentChannels[channelId]) {
        evaluationData.currentChannels[channelId].forEach(member => {
            const mmInput = document.getElementById(`mm_${channelId}_${member.id}`);
            if (mmInput) {
                totalMM += parseFloat(mmInput.value) || 0;
            }
        });
    }
    // 2ì°¨ í‰ê°€ í™”ë©´
    else if (evaluationData.firstEvaluation[channelId]) {
        evaluationData.firstEvaluation[channelId].members.forEach(member => {
            totalMM += parseFloat(member.mm) || 0;
        });
    }
    // 3ì°¨ í‰ê°€ í™”ë©´
    else if (evaluationData.secondEvaluation[channelId]) {
        evaluationData.secondEvaluation[channelId].members.forEach(member => {
            totalMM += parseFloat(member.mm) || 0;
        });
    }
    
    return totalMM;
}

// ===== ì±„ë„ ì •ë ¬ í•¨ìˆ˜ =====
function sortChannelsByMM() {
    let container = null;
    let channels = [];
    
    // í˜„ì¬ í™œì„±í™”ëœ í‰ê°€ í™”ë©´ í™•ì¸
    if (document.getElementById('teamleadContent').classList.contains('active')) {
        // 1ì°¨ í‰ê°€
        container = document.getElementById('channelEvaluationsArea');
        if (container) {
            channels = Array.from(container.querySelectorAll('.channel-evaluation-section'));
        }
    } else if (document.getElementById('managerContent').classList.contains('active')) {
        // 2ì°¨ í‰ê°€
        container = document.getElementById('secondEvaluationArea');
        if (container) {
            // íŒ€ ê·¸ë£¹ ì„¹ì…˜ë“¤ì„ ì°¾ì•„ì„œ ê°ê° ì •ë ¬
            const teamGroups = container.querySelectorAll('.team-group-section');
            teamGroups.forEach(teamGroup => {
                const teamChannels = Array.from(teamGroup.querySelectorAll('.summary-box'));
                
                const channelData = teamChannels.map(element => {
                    // ì±„ë„ ID ì°¾ê¸°
                    let channelId = null;
                    const totalMMElement = element.querySelector('[id^="totalMM_"]');
                    if (totalMMElement) {
                        channelId = totalMMElement.id.replace('totalMM_', '');
                    } else {
                        // 2ì°¨ í‰ê°€ì—ì„œëŠ” í…Œì´ë¸”ì„ í†µí•´ MM í•©ê³„ ê³„ì‚°
                        const table = element.querySelector('table');
                        if (table) {
                            const rows = table.querySelectorAll('tbody tr');
                            let totalMM = 0;
                            rows.forEach(row => {
                                const mmCell = row.cells[2]; // MM ì»¬ëŸ¼
                                if (mmCell) {
                                    totalMM += parseFloat(mmCell.textContent) || 0;
                                }
                            });
                            return {
                                element: element,
                                totalMM: totalMM
                            };
                        }
                    }
                    
                    return {
                        element: element,
                        channelId: channelId,
                        totalMM: channelId ? calculateChannelMMTotal(channelId) : 0
                    };
                });
                
                // MM í•©ê³„ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                channelData.sort((a, b) => b.totalMM - a.totalMM);
                
                // DOM ì¬ë°°ì¹˜
                channelData.forEach(data => {
                    teamGroup.appendChild(data.element);
                });
            });
            
            showNotification('ì±„ë„ì´ MM í•©ê³„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            return;
        }
    } else if (document.getElementById('executiveContent').classList.contains('active')) {
        // 3ì°¨ í‰ê°€
        container = document.getElementById('finalEvaluationArea');
        if (container) {
            // íŒ€ ê·¸ë£¹ ì„¹ì…˜ë“¤ì„ ì°¾ì•„ì„œ ê°ê° ì •ë ¬
            const teamGroups = container.querySelectorAll('.team-group-section');
            teamGroups.forEach(teamGroup => {
                const teamChannels = Array.from(teamGroup.querySelectorAll('.summary-box'));
                
                const channelData = teamChannels.map(element => {
                    // MM í•©ê³„ ì°¾ê¸°
                    const summaryItems = element.querySelectorAll('.summary-item');
                    let totalMM = 0;
                    
                    summaryItems.forEach(item => {
                        const label = item.querySelector('.summary-label');
                        if (label && label.textContent.includes('íˆ¬ì… MM í•©ê³„')) {
                            const value = item.querySelector('.summary-value');
                            if (value) {
                                totalMM = parseFloat(value.textContent) || 0;
                            }
                        }
                    });
                    
                    return {
                        element: element,
                        totalMM: totalMM
                    };
                });
                
                // MM í•©ê³„ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                channelData.sort((a, b) => b.totalMM - a.totalMM);
                
                // DOM ì¬ë°°ì¹˜
                channelData.forEach(data => {
                    teamGroup.appendChild(data.element);
                });
            });
            
            showNotification('ì±„ë„ì´ MM í•©ê³„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            return;
        }
    }
    
    // 1ì°¨ í‰ê°€ì˜ ê²½ìš° ì²˜ë¦¬
    if (channels.length > 0) {
        const channelData = channels.map(element => {
            const channelId = element.dataset.channelId;
            return {
                element: element,
                channelId: channelId,
                totalMM: calculateChannelMMTotal(channelId)
            };
        });
        
        // MM í•©ê³„ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        channelData.sort((a, b) => b.totalMM - a.totalMM);
        
        // DOM ì¬ë°°ì¹˜
        channelData.forEach(data => {
            container.appendChild(data.element);
        });
        
        showNotification('ì±„ë„ì´ MM í•©ê³„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }
}

// ===== ì›”ë³„ ì„±ê³¼ê¸ˆ ì¡°íšŒ í•¨ìˆ˜ =====
function loadMonthlyPayment() {
    const year = document.getElementById('paymentYear').value;
    const month = document.getElementById('paymentMonth').value;
    const teamId = document.getElementById('paymentTeam').value;
    
    if (!teamId) {
        showNotification('íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const evalMonth = `${year}-${month}`;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(data) {
            displayMonthlyPayment(data, evalMonth, teamId);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getTeamMonthlyPayment(evalMonth, teamId);
}

function displayMonthlyPayment(data, evalMonth, teamId) {
    const area = document.getElementById('monthlyPaymentArea');
    const teamName = evaluationData.teams[teamId].name;
    
    // íŒ€ì¥ ì„±ê³¼ê¸ˆ ì¡°íšŒ
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(teamLeaderData) {
            // íŒ€ì¥ ì°¾ê¸°
            let teamLeaderPayment = null;
            for (const leaderId in teamLeaderData) {
                if (teamLeaderData[leaderId].teamId === teamId) {
                    teamLeaderPayment = teamLeaderData[leaderId];
                    break;
                }
            }
            
            // ê¸°ì¡´ íŒ€ì› ë°ì´í„°ì— íŒ€ì¥ ì¶”ê°€
            const allMembers = {...data.members};
            if (teamLeaderPayment) {
                allMembers[teamLeaderPayment.name] = {
                    channels: teamLeaderPayment.channels,
                    total: teamLeaderPayment.total,
                    isTeamLeader: true
                };
            }
            
            // ë°°ì—´ë¡œ ë³€í™˜
            const membersArray = [];
            for (const memberName in allMembers) {
                membersArray.push({
                    name: memberName,
                    channels: allMembers[memberName].channels,
                    total: allMembers[memberName].total,
                    isTeamLeader: allMembers[memberName].isTeamLeader || false
                });
            }
            
            // ì •ë ¬
            if (!window.paymentSortOrder) {
                window.paymentSortOrder = 'desc';
            }
            
            membersArray.sort((a, b) => {
                return window.paymentSortOrder === 'desc' ? b.total - a.total : a.total - b.total;
            });
            
            // HTML ìƒì„± ì‹œì‘
            let html = `
                <h3>ğŸ’° ${evalMonth} ${teamName} ì„±ê³¼ê¸ˆ ì§€ê¸‰ ë‚´ì—­</h3>
                <div class="summary-box">
                    <h4>íŒ€ ì´ê³„</h4>
                    <div class="summary-item">
                        <span class="summary-label">íŒ€ì› ì„±ê³¼ê¸ˆ:</span>
                        <span class="summary-value amount">${(data.totalAmount/10000).toFixed(1)}ë§Œì›</span>
                    </div>
                    ${teamLeaderPayment ? `
                    <div class="summary-item">
                        <span class="summary-label">íŒ€ì¥ ì„±ê³¼ê¸ˆ:</span>
                        <span class="summary-value amount">${(teamLeaderPayment.total/10000).toFixed(1)}ë§Œì›</span>
                    </div>
                    <div class="summary-item" style="border-top: 1px solid #3f3f3f; padding-top: 10px;">
                        <span class="summary-label">ì „ì²´ ì´ê³„:</span>
                        <span class="summary-value amount" style="font-size: 20px; color: #1a73e8;">
                            ${((data.totalAmount + teamLeaderPayment.total)/10000).toFixed(1)}ë§Œì›
                        </span>
                    </div>
                    ` : ''}
                    <div class="summary-item">
                        <span class="summary-label">ì§€ê¸‰ ì¸ì›:</span>
                        <span class="summary-value">${membersArray.length}ëª…</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="sortMonthlyPayment('${evalMonth}', '${teamId}')">
                            ğŸ”„ ê¸ˆì•¡ìˆœ ì •ë ¬ (${window.paymentSortOrder === 'desc' ? 'â†“ ë†’ì€ìˆœ' : 'â†‘ ë‚®ì€ìˆœ'})
                        </button>
                    </div>
                </div>
                
                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>êµ¬ë¶„</th>
                            <th>ì´ë¦„</th>
                            <th>ì±„ë„ë³„ ì„±ê³¼ê¸ˆ</th>
                            <th>ì´ ì„±ê³¼ê¸ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // â­ï¸ ì—¬ê¸°ê°€ í…Œì´ë¸” í–‰ì„ ë§Œë“œëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤ - ìˆœìœ„ ìŠ¤íƒ€ì¼ ì ìš©
            membersArray.forEach((member, index) => {
                const channelDetails = member.channels.map(ch => 
                    `${ch.channelName}: ${(ch.amount/10000).toFixed(1)}ë§Œì›`
                ).join('<br>');
                
                // ìˆœìœ„ë³„ ìŠ¤íƒ€ì¼ ì ìš©
                let rankStyle = '';
                if (window.paymentSortOrder === 'desc') {
                    if (index === 0) rankStyle = 'color: #FFD700; font-weight: bold;'; // ê¸ˆìƒ‰
                    else if (index === 1) rankStyle = 'color: #C0C0C0; font-weight: bold;'; // ì€ìƒ‰
                    else if (index === 2) rankStyle = 'color: #CD7F32; font-weight: bold;'; // ë™ìƒ‰
                }
                
                html += `
                    <tr>
                        <td style="${rankStyle}">${index + 1}ìœ„</td>
                        <td>${member.isTeamLeader ? '<span style="color: #1a73e8; font-weight: bold;">ğŸ‘” íŒ€ì¥</span>' : 'íŒ€ì›'}</td>
                        <td>${member.name}</td>
                        <td>${channelDetails}</td>
                        <td class="amount" style="font-weight: bold;">${(member.total/10000).toFixed(1)}ë§Œì›</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            // â­ï¸ ì—¬ê¸°ê°€ TOP 3 ìš”ì•½ì„ ì¶”ê°€í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤
            // ìƒìœ„ 3ëª… ìš”ì•½ (ë‚´ë¦¼ì°¨ìˆœì¼ ë•Œë§Œ)
            if (window.paymentSortOrder === 'desc' && membersArray.length >= 3) {
                html += `
                    <div class="summary-box" style="margin-top: 20px;">
                        <h4>ğŸ† TOP 3</h4>
                        <div style="display: flex; gap: 20px; justify-content: center; margin-top: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px;">ğŸ¥‡</div>
                                <div style="font-weight: bold;">${membersArray[0].name}</div>
                                <div class="amount">${(membersArray[0].total/10000).toFixed(1)}ë§Œì›</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px;">ğŸ¥ˆ</div>
                                <div style="font-weight: bold;">${membersArray[1].name}</div>
                                <div class="amount">${(membersArray[1].total/10000).toFixed(1)}ë§Œì›</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px;">ğŸ¥‰</div>
                                <div style="font-weight: bold;">${membersArray[2].name}</div>
                                <div class="amount">${(membersArray[2].total/10000).toFixed(1)}ë§Œì›</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            area.innerHTML = html;
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            console.error('íŒ€ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            showLoading(false);
        })
        .getTeamLeaderPayments(evalMonth);
}

// ===== ì •ë ¬ í•¨ìˆ˜ =====
function sortMonthlyPayment(evalMonth, teamId) {
    // ì •ë ¬ ìˆœì„œ í† ê¸€
    window.paymentSortOrder = window.paymentSortOrder === 'desc' ? 'asc' : 'desc';
    
    // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(data) {
            displayMonthlyPayment(data, evalMonth, teamId);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getTeamMonthlyPayment(evalMonth, teamId);
}


// ===== ì¦‰ì‹œ íš¨ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆëŠ” Quick Fixes =====

// 1. ë¡œë”© í‘œì‹œ ê°œì„  - ì‚¬ìš©ìê°€ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ì§„í–‰ ìƒí™© í‘œì‹œ
function showLoadingWithProgress(message) {
    const loading = document.getElementById('loadingSpinner');
    loading.innerHTML = `
        <div class="spinner"></div>
        <p style="margin-top: 15px; text-align: center;">${message || 'ì²˜ë¦¬ì¤‘...'}</p>
        <div class="loading-progress" style="margin-top: 10px;">
            <div class="loading-progress-bar"></div>
        </div>
    `;
    loading.classList.add('show');
}

// 2. ë””ë°”ìš´ì‹± ê°•í™” - debounce í•¨ìˆ˜ê°€ ì •ì˜ëœ í›„ì— ì‹¤í–‰
let debouncedCheckExistingEvaluation;
if (typeof debounce === 'function') {
    debouncedCheckExistingEvaluation = debounce(checkExistingEvaluation, 500);
}

// 3. ì„ íƒì  ë¡œë“œ - ë³´ì´ëŠ” ê²ƒë§Œ ë¨¼ì €
function lazyLoadEvaluations() {
    const visibleChannels = document.querySelectorAll('.channel-evaluation-section:not([data-loaded])');
    visibleChannels.forEach(channel => {
        if (isElementInViewport(channel)) {
            loadChannelDetails(channel.dataset.channelId);
            channel.dataset.loaded = 'true';
        }
    });
}

// ë·°í¬íŠ¸ì— ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
function isElementInViewport(el) {
    const rect = el.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

// í‰ê°€ ë°ì´í„°ëŠ” í•„ìš”í•  ë•Œë§Œ ë¡œë“œ
function loadEvaluationDataOnDemand(evalMonth, type) {
    const cacheKey = `${type}_${evalMonth}`;
    const cached = sessionStorage.getItem(cacheKey);
    
    if (cached) {
        return Promise.resolve(JSON.parse(cached));
    }
    
    return new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(data => {
                sessionStorage.setItem(cacheKey, JSON.stringify(data));
                resolve(data);
            })
            .withFailureHandler(reject)
            [`get${type}EvaluationDataOptimized`](evalMonth, 1000); // ìµœê·¼ 1000ê°œë§Œ
    });
}

// utils.jsì— ì¶”ê°€
let activityHistory = [];

function addActivity(action, details) {
    const activity = {
        action: action,
        details: details,
        timestamp: new Date().toLocaleString('ko-KR'),
        id: Date.now()
    };
    
    activityHistory.unshift(activity);
    if (activityHistory.length > 50) {
        activityHistory.pop();
    }
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    localStorage.setItem('activityHistory', JSON.stringify(activityHistory));
    
    // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
    updateActivitySidebar();
}

function updateActivitySidebar() {
    const container = document.getElementById('recentActivities');
    let html = '';
    
    activityHistory.slice(0, 10).forEach(activity => {
        html += `
            <div class="activity-item">
                <div><strong>${activity.action}</strong></div>
                <div>${activity.details}</div>
                <div class="activity-time">${activity.timestamp}</div>
            </div>
        `;
    });
    
    container.innerHTML = html || '<p style="text-align: center; color: #666;">ì‘ì—… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
}

function toggleAllTeams(button) {
    const checkboxes = button.parentElement.parentElement.querySelectorAll('.team-checkbox-area input[type="checkbox"]');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
    });
    
    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
    button.textContent = allChecked ? 'âœ… ì „ì²´ ì„ íƒ' : 'âŒ ì „ì²´ í•´ì œ';
}

function toggleActivitySidebar() {
    const sidebar = document.getElementById('activitySidebar');
    sidebar.classList.toggle('show');
    
    // ì²˜ìŒ ì—´ ë•Œ ë‚´ì—­ ë¡œë“œ
    if (sidebar.classList.contains('show')) {
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
        const saved = localStorage.getItem('activityHistory');
        if (saved) {
            activityHistory = JSON.parse(saved);
        }
        updateActivitySidebar();
    }
}

// í‰ê°€ ì €ì¥ ì‹œ ìë™ìœ¼ë¡œ í™œë™ ê¸°ë¡
function recordActivity(action, details) {
    addActivity(action, details);
    
    // ì‚¬ì´ë“œë°”ê°€ ì—´ë ¤ìˆìœ¼ë©´ ìë™ ì—…ë°ì´íŠ¸
    const sidebar = document.getElementById('activitySidebar');
    if (sidebar.classList.contains('show')) {
        updateActivitySidebar();
    }
}

function filterByTeam(data, teamId) {
    const filteredData = {
        evaluations: {},
        finalEval: {}
    };
    
    // ì„ íƒëœ íŒ€ì˜ ì±„ë„ë§Œ í•„í„°ë§
    for (const channelId in data.evaluations) {
        const channel = evaluationData.channels.find(c => c.id === channelId);
        if (channel && channel.teamId === teamId) {
            filteredData.evaluations[channelId] = data.evaluations[channelId];
        }
    }
    
    for (const channelId in data.finalEval) {
        const channel = evaluationData.channels.find(c => c.id === channelId);
        if (channel && channel.teamId === teamId) {
            filteredData.finalEval[channelId] = data.finalEval[channelId];
        }
    }
    
    return filteredData;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì‚¬ì´ë“œë°” í‘œì‹œ
window.addEventListener('load', function() {
    setTimeout(() => {
        const sidebar = document.getElementById('activitySidebar');
        if (sidebar) {
            sidebar.classList.add('show');
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            const saved = localStorage.getItem('activityHistory');
            if (saved) {
                activityHistory = JSON.parse(saved);
                updateActivitySidebar();
            }
        }
    }, 1000);
});

// í‰ê°€ ì €ì¥ í•¨ìˆ˜ë“¤ì— í™œë™ ê¸°ë¡ ì¶”ê°€
// evaluation.jsì˜ ê° submit í•¨ìˆ˜ì— ì¶”ê°€
function submitFirstEvaluation() {
    // ... ê¸°ì¡´ ì½”ë“œ ...
    // ì„±ê³µ ì‹œ
    recordActivity('1ì°¨ í‰ê°€ ì €ì¥', `${evalMonth} - ${channelNames.join(', ')}`);
}

function submitSecondEvaluationSelective() {
    // ... ê¸°ì¡´ ì½”ë“œ ...
    // ì„±ê³µ ì‹œ
    recordActivity('2ì°¨ í‰ê°€ ì €ì¥', `${evalMonth} - ${channelCount}ê°œ ì±„ë„`);
}

function submitFinalEvaluationSelective() {
    // ... ê¸°ì¡´ ì½”ë“œ ...
    // ì„±ê³µ ì‹œ
    recordActivity('ìµœì¢… í‰ê°€ í™•ì •', `${evalMonth} - ${Object.keys(channelData.channels).length}ê°œ ì±„ë„`);
}

function loadMoreActivities() {
    // ë” ë§ì€ í™œë™ ê¸°ë¡ í‘œì‹œ
    updateActivitySidebar();
}

</script>
