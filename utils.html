<script>
// ===== ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ =====
let evaluationData = {
    teams: {},
    members: [],
    channels: [],
    teamleads: [],
    firstEvaluation: {},
    secondEvaluation: {},
    finalEvaluation: {},
    currentChannels: {},
    currentChannelMembers: [],
    existingEvaluations: {},
    selectedChannels: [],
    evaluationMode: 'new',
    currentEvalMonth: '',
    currentTeamleadId: '',
    currentEvalInfo: null,
    secondEvalTeamFilter: null,
    finalEvalTeamFilter: null
};

// ===== ë‹¤í¬ëª¨ë“œ ê°•ì œ ì ìš© í•¨ìˆ˜ =====
function forceDarkMode() {
    const elements = document.querySelectorAll('select, input, textarea');
    elements.forEach(el => {
        el.style.backgroundColor = '#0f0f0f';
        el.style.color = '#f1f1f1';
        el.style.border = '1px solid #3f3f3f';
    });
    
    const problemSelects = document.querySelectorAll('[id^="teamSelect_"], [id^="memberSelect_"], #managementTeamFilter, #evaluationTeamSelect');
    problemSelects.forEach(select => {
        select.style.backgroundColor = '#0f0f0f !important';
        select.style.color = '#f1f1f1 !important';
        select.style.border = '1px solid #3f3f3f !important';
        select.style.setProperty('background-color', '#0f0f0f', 'important');
        select.style.setProperty('color', '#f1f1f1', 'important');
        select.style.setProperty('border', '1px solid #3f3f3f', 'important');
    });
}

// DOM ë³€ê²½ ê°ì§€
const observer = new MutationObserver(function(mutations) {
    forceDarkMode();
});

observer.observe(document.body, {
    childList: true,
    subtree: true
});

// ===== ì´ˆê¸° ë°ì´í„° ë¡œë“œ =====
function loadInitialData() {
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(data) {
            console.log('ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
            evaluationData.teams = data.teams;
            evaluationData.members = data.members;
            evaluationData.channels = data.channels;
            evaluationData.teamleads = data.teamleads;
            
            updateAllSelectors();
            
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            const currentMonthValue = currentDate.toISOString().slice(0, 7);
            
            const prevDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1);
            const prevMonth = prevDate.toISOString().slice(0, 7);
            
            // ê° í‰ê°€ ë…„/ì›” ì„¤ì •
            if (document.getElementById('evalYear')) {
                document.getElementById('evalYear').value = currentYear;
                document.getElementById('evalMonthSelect').value = currentMonth;
                document.getElementById('evalMonth').value = currentMonthValue;
            }
            
            if (document.getElementById('evalYear2nd')) {
                document.getElementById('evalYear2nd').value = currentYear;
                document.getElementById('evalMonthSelect2nd').value = currentMonth;
                document.getElementById('evalMonth2nd').value = currentMonthValue;
            }
            
            if (document.getElementById('evalYearFinal')) {
                document.getElementById('evalYearFinal').value = currentYear;
                document.getElementById('evalMonthSelectFinal').value = currentMonth;
                document.getElementById('evalMonthFinal').value = currentMonthValue;
            }
            
            if (currentUser.level >= 3) {
                if (document.getElementById('compareYear1')) {
                    const prevYear = prevDate.getFullYear();
                    const prevMonthStr = String(prevDate.getMonth() + 1).padStart(2, '0');
                    document.getElementById('compareYear1').value = prevYear;
                    document.getElementById('compareMonth1Select').value = prevMonthStr;
                    window.compareMonth1 = prevMonth;
                    
                    document.getElementById('compareYear2').value = currentYear;
                    document.getElementById('compareMonth2Select').value = currentMonth;
                    window.compareMonth2 = currentMonthValue;
                }
            }
            
            if (document.getElementById('teamleadSelect') && document.getElementById('teamleadSelect').value && 
                document.getElementById('evalMonth') && document.getElementById('evalMonth').value) {
                setTimeout(() => {
                    checkExistingEvaluation();
                }, 50);
            }
            
            setTimeout(forceDarkMode, 100);
            
            showLoading(false);
            console.log('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
        })
        .withFailureHandler(function(error) {
            showNotification('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getInitialData();
}

// ===== ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸ =====
function updateAllSelectors() {
    // íŒ€ ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
    const teamSelects = ['newMemberTeam', 'newChannelTeam'];
    teamSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">íŒ€ ì„ íƒ</option>';
            for (const teamId in evaluationData.teams) {
                const option = document.createElement('option');
                option.value = teamId;
                option.textContent = evaluationData.teams[teamId].name;
                select.appendChild(option);
            }
        }
    });
    
    // íŒ€ì¥ ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
    const teamleadSelect = document.getElementById('teamleadSelect');
    if (teamleadSelect) {
        teamleadSelect.innerHTML = '<option value="">íŒ€ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        evaluationData.teamleads.forEach(teamlead => {
            const option = document.createElement('option');
            option.value = teamlead.id;
            option.textContent = `${teamlead.name} (${evaluationData.teams[teamlead.teamId].name})`;
            option.dataset.email = teamlead.email;
            
            if (currentUser.email === teamlead.email) {
                option.selected = true;
            }
            
            if (currentUser.level === 1 && currentUser.email !== teamlead.email) {
                option.disabled = true;
            }
            
            teamleadSelect.appendChild(option);
        });
        
        if (teamleadSelect.value) {
            console.log('íŒ€ì¥ ìë™ ì„ íƒë¨:', teamleadSelect.value);
            setTimeout(() => {
                if (document.getElementById('evalMonth') && document.getElementById('evalMonth').value) {
                    console.log('í‰ê°€ì›”ë„ ì„¤ì •ë¨, checkExistingEvaluation í˜¸ì¶œ');
                    if (typeof checkExistingEvaluation === 'function') {
                        checkExistingEvaluation();
                    }
                }
            }, 50);
        }
    }
    
    updateChannelSelectors();
    
    if (document.getElementById('memberList')) {
        updateMemberList();
    }
    if (document.getElementById('channelList')) {
        updateChannelList();
    }
    
    setTimeout(forceDarkMode, 50);
}

function updateChannelSelectors() {
    const select = document.getElementById('channelForMemberAssignment');
    if (select) {
        select.innerHTML = '<option value="">ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        evaluationData.channels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = `${channel.name} (${evaluationData.teams[channel.teamId].name})`;
            select.appendChild(option);
        });
    }
    
    forceDarkMode();
}

// ===== ë¡œë”© í‘œì‹œ =====
function showLoading(show) {
    const loading = document.getElementById('loadingSpinner');
    if (show) {
        loading.classList.add('show');
    } else {
        loading.classList.remove('show');
    }
}

// ===== ì•Œë¦¼ í‘œì‹œ (ìƒˆë¡œìš´ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‚¬ìš©) =====
function showAlert(message, type) {
    showNotification(message, type);
}

// ===== í‰ê°€ ìƒíƒœ ë¡œë“œ =====
function loadEvaluationStatus() {
    const evalMonth = document.getElementById('evalMonthFinal').value;
    if (!evalMonth) return;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(statusData) {
            displayEvaluationStatus(statusData);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            console.error('í‰ê°€ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', error);
            showLoading(false);
        })
        .getEvaluationStatus(evalMonth);
}

// ===== í‰ê°€ ìƒíƒœ í‘œì‹œ =====
function displayEvaluationStatus(statusData) {
    const grid = document.getElementById('evaluationStatusGrid');
    let html = '';
    
    for (const teamId in statusData) {
        const team = statusData[teamId];
        const statusClass = team.stage === 'ìµœì¢…ì™„ë£Œ' ? 'status-complete' : 
                           team.stage === '2ì°¨ì™„ë£Œ' ? 'status-second' : 
                           team.stage === '1ì°¨ì™„ë£Œ' ? 'status-first' : 'status-pending';
        
        html += `
            <div class="status-card ${statusClass}">
                <h4>${team.name}</h4>
                <div class="status-stage">${team.stage || 'ë¯¸ì§„í–‰'}</div>
                <div class="status-details">
                    <span>ì±„ë„: ${team.channelCount}ê°œ</span>
                    <span>íŒ€ì›: ${team.memberCount}ëª…</span>
                </div>
            </div>
        `;
    }
    
    grid.innerHTML = html;
}

// ===== íŒ€ì› ë¶„ì„ ë¡œë“œ =====
function loadTeamMembersForAnalysis() {
    const teamId = document.getElementById('analysisTeamSelect').value;
    const memberSelect = document.getElementById('analysisMemberSelect');
    
    if (!teamId) {
        memberSelect.innerHTML = '<option value="">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        return;
    }
    
    const teamMembers = evaluationData.members.filter(m => m.teamId === teamId);
    memberSelect.innerHTML = '<option value="">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    
    teamMembers.forEach(member => {
        const option = document.createElement('option');
        option.value = member.id;
        option.textContent = member.name;
        memberSelect.appendChild(option);
    });
}

// ===== ê°œì¸ë³„ ë¶„ì„ ì‹¤í–‰ =====
function loadIndividualAnalysis() {
    const memberId = document.getElementById('analysisMemberSelect').value;
    if (!memberId) {
        showNotification('ë¶„ì„í•  íŒ€ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(data) {
            displayIndividualAnalysis(data);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ê°œì¸ ë¶„ì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getIndividualYearlyData(memberId);
}

// ===== ê°œì¸ë³„ ë¶„ì„ í‘œì‹œ =====
function displayIndividualAnalysis(yearlyData) {
    const area = document.getElementById('individualAnalysisArea');
    const memberName = document.getElementById('analysisMemberSelect').selectedOptions[0].text;
    
    let html = `<h3>ğŸ“Š ${memberName}ë‹˜ì˜ ì—°ê°„ ì„±ê³¼ ë¶„ì„</h3>`;
    
    let totalAmount = 0;
    let monthCount = 0;
    const monthlyData = [];
    
    for (const month in yearlyData) {
        const data = yearlyData[month];
        if (data.finalAmount) {
            totalAmount += data.finalAmount;
            monthCount++;
        }
        monthlyData.push({
            month: month,
            amount: data.finalAmount || 0,
            mm: data.mm || 0,
            contribution: data.contribution2 || data.contribution1 || 0
        });
    }
    
    html += `
        <div class="summary-box">
            <h4>ì—°ê°„ ìš”ì•½</h4>
            <div class="summary-item">
                <span class="summary-label">ì´ ì„±ê³¼ê¸ˆ:</span>
                <span class="summary-value amount">${(totalAmount/10000).toFixed(1)}ë§Œì›</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">í‰ê·  ì›” ì„±ê³¼ê¸ˆ:</span>
                <span class="summary-value amount">${monthCount > 0 ? (totalAmount/monthCount/10000).toFixed(1) : 0}ë§Œì›</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">í‰ê°€ ì™„ë£Œ ì›”:</span>
                <span class="summary-value">${monthCount}ê°œì›”</span>
            </div>
        </div>
    `;
    
    html += `
        <h4>ì›”ë³„ ìƒì„¸ ë‚´ì—­</h4>
        <table class="evaluation-table">
            <thead>
                <tr>
                    <th>í‰ê°€ì›”</th>
                    <th>ì±„ë„ëª…</th>
                    <th>íˆ¬ì… MM</th>
                    <th>ê¸°ì—¬ë„</th>
                    <th>ì„±ê³¼ê¸ˆ</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    monthlyData.sort((a, b) => a.month.localeCompare(b.month));
    
    monthlyData.forEach(data => {
        const monthData = yearlyData[data.month];
        html += `
            <tr>
                <td>${data.month}</td>
                <td>${monthData.channelName || '-'}</td>
                <td>${data.mm}</td>
                <td>${data.contribution}%</td>
                <td class="amount">${data.amount ? (data.amount/10000).toFixed(1) + 'ë§Œì›' : '-'}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    
    html += `
        <div style="margin-top: 30px;">
            <canvas id="individualChart"></canvas>
        </div>
    `;
    
    area.innerHTML = html;
    
    setTimeout(() => {
        drawIndividualChart(monthlyData);
    }, 100);
}

// ===== ê°œì¸ë³„ ì°¨íŠ¸ ê·¸ë¦¬ê¸° =====
function drawIndividualChart(monthlyData) {
    const ctx = document.getElementById('individualChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthlyData.map(d => d.month),
            datasets: [{
                label: 'ì›”ë³„ ì„±ê³¼ê¸ˆ (ë§Œì›)',
                data: monthlyData.map(d => d.amount / 10000),
                borderColor: '#1a73e8',
                backgroundColor: 'rgba(26, 115, 232, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'ì›”ë³„ ì„±ê³¼ê¸ˆ ì¶”ì´'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'ë§Œì›';
                        }
                    }
                }
            }
        }
    });
}

// ===== íŠ¸ë Œë“œ ì˜µì…˜ ì—…ë°ì´íŠ¸ =====
function updateTrendOptions() {
    const type = document.getElementById('trendType').value;
    const targetSelect = document.getElementById('trendTarget');
    
    targetSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    
    if (type === 'team') {
        for (const teamId in evaluationData.teams) {
            const option = document.createElement('option');
            option.value = teamId;
            option.textContent = evaluationData.teams[teamId].name;
            targetSelect.appendChild(option);
        }
    } else {
        evaluationData.channels.forEach(channel => {
            const option = document.createElement('option');
            option.value = channel.id;
            option.textContent = channel.name;
            targetSelect.appendChild(option);
        });
    }
}

// ===== íŠ¸ë Œë“œ ë¶„ì„ ë¡œë“œ =====
function loadTrendAnalysis() {
    const type = document.getElementById('trendType').value;
    const target = document.getElementById('trendTarget').value;
    const period = document.getElementById('trendPeriod').value;
    
    if (!target) {
        showNotification('ë¶„ì„ ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(data) {
            drawTrendChart(data, type);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('íŠ¸ë Œë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getTrendData(type, target, period);
}

// ===== íŠ¸ë Œë“œ ì°¨íŠ¸ ê·¸ë¦¬ê¸° =====
function drawTrendChart(data, type) {
    const ctx = document.getElementById('trendChart').getContext('2d');
    
    if (window.trendChartInstance) {
        window.trendChartInstance.destroy();
    }
    
    window.trendChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'ì´ ì„±ê³¼ê¸ˆ (ë§Œì›)',
                data: data.amounts.map(a => a / 10000),
                backgroundColor: 'rgba(26, 115, 232, 0.5)',
                borderColor: '#1a73e8',
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'í‰ê·  ê¸°ì—¬ë„ (%)',
                data: data.contributions,
                type: 'line',
                yAxisID: 'y1',
                borderColor: '#27ae60',
                backgroundColor: 'rgba(39, 174, 96, 0.1)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: type === 'team' ? 'íŒ€ë³„ ì„±ê³¼ íŠ¸ë Œë“œ' : 'ì±„ë„ë³„ ì„±ê³¼ íŠ¸ë Œë“œ'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    ticks: {
                        callback: function(value) {
                            return value + 'ë§Œì›';
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// ===== ê¶Œí•œ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
function loadPermissionsList() {
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(permissions) {
            displayPermissionsList(permissions);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ê¶Œí•œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getPermissionsList();
}

function displayPermissionsList(permissions) {
    const listDiv = document.getElementById('permissionsList');
    let html = `
        <table class="evaluation-table">
            <thead>
                <tr>
                    <th>ì´ë©”ì¼</th>
                    <th>ì´ë¦„</th>
                    <th>ë¶€ì„œ</th>
                    <th>ê¶Œí•œë ˆë²¨</th>
                    <th>ìƒíƒœ</th>
                    <th>ë“±ë¡ì¼ì‹œ</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    permissions.forEach(user => {
        const levelText = user.level === 1 ? '1ì°¨ í‰ê°€' : user.level === 2 ? '1-2ì°¨ í‰ê°€' : 'ì „ì²´ ê¶Œí•œ';
        const statusClass = user.active === 'Y' ? 'positive-change' : 'negative-change';
        const statusText = user.active === 'Y' ? 'í™œì„±' : 'ë¹„í™œì„±';
        
        html += `
            <tr>
                <td>${user.email}</td>
                <td>${user.name}</td>
                <td>${user.department}</td>
                <td>
                    <select onchange="updateUserLevel('${user.email}', this.value)" ${user.email === currentUser.email ? 'disabled' : ''}>
                        <option value="1" ${user.level === 1 ? 'selected' : ''}>1 - 1ì°¨ í‰ê°€ë§Œ</option>
                        <option value="2" ${user.level === 2 ? 'selected' : ''}>2 - 1ì°¨/2ì°¨ í‰ê°€</option>
                        <option value="3" ${user.level === 3 ? 'selected' : ''}>3 - ì „ì²´ ê¶Œí•œ</option>
                    </select>
                </td>
                <td class="${statusClass}">${statusText}</td>
                <td>${user.registeredDate}</td>
                <td>
                    <button class="btn ${user.active === 'Y' ? 'btn-danger' : 'btn-success'}" 
                            style="padding: 5px 10px; font-size: 12px;"
                            onclick="toggleUserStatus('${user.email}')"
                            ${user.email === currentUser.email ? 'disabled' : ''}>
                        ${user.active === 'Y' ? 'ğŸ”’ ë¹„í™œì„±í™”' : 'ğŸ”“ í™œì„±í™”'}
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    listDiv.innerHTML = html;
}

function addNewUser() {
    const email = document.getElementById('newUserEmail').value.trim();
    const name = document.getElementById('newUserName').value.trim();
    const department = document.getElementById('newUserDept').value.trim();
    const level = document.getElementById('newUserLevel').value;
    
    if (!email || !name || !department) {
        showNotification('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    if (!email.endsWith('@awesomeent.kr')) {showNotification('íšŒì‚¬ ì´ë©”ì¼(@awesomeent.kr)ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification(result.message, 'success');
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserDept').value = '';
                document.getElementById('newUserLevel').value = '1';
                loadPermissionsList();
            } else {
                showNotification(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .addUserPermission({
            email: email,
            name: name,
            department: department,
            level: parseInt(level)
        });
}

function updateUserLevel(email, newLevel) {
    if (!confirm(`${email}ì˜ ê¶Œí•œì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        loadPermissionsList();
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            showNotification(result.message, result.success ? 'success' : 'error');
            loadPermissionsList();
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ê¶Œí•œ ìˆ˜ì • ì‹¤íŒ¨: ' + error, 'error');
            loadPermissionsList();
            showLoading(false);
        })
        .updateUserPermission(email, parseInt(newLevel));
}

function toggleUserStatus(email) {
    const action = confirm(`${email}ì˜ ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
    if (!action) return;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            showNotification(result.message, result.success ? 'success' : 'error');
            loadPermissionsList();
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .toggleUserActive(email);
}

function loadActionLogs() {
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(logs) {
            displayActionLogs(logs);
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì•¡ì…˜ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getActionLogs(50);
}

function displayActionLogs(logs) {
    const logsDiv = document.getElementById('actionLogsList');
    
    if (logs.length === 0) {
        logsDiv.innerHTML = '<p style="text-align: center; color: #aaa;">ì•¡ì…˜ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    let html = `
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="evaluation-table">
                <thead>
                    <tr>
                        <th>ì¼ì‹œ</th>
                        <th>ì‚¬ìš©ì</th>
                        <th>ì•¡ì…˜</th>
                        <th>ìƒì„¸ë‚´ìš©</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    logs.forEach(log => {
        html += `
            <tr>
                <td>${log.timestamp}</td>
                <td>${log.user}</td>
                <td>${log.action}</td>
                <td>${log.details}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    logsDiv.innerHTML = html;
}

// ===== ì—­í•  ì „í™˜ í•¨ìˆ˜ =====
function switchRole(role) {
    document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.role-content').forEach(content => content.classList.remove('active'));
    
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    if (role === 'management') {
        document.getElementById('managementContent').classList.add('active');
    } else if (role === 'teamlead') {
        if (currentUser.level < 1) {
            showNotification('1ì°¨ í‰ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        document.getElementById('teamleadContent').classList.add('active');
    } else if (role === 'manager') {
        if (currentUser.level < 2) {
            showNotification('2ì°¨ í‰ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        document.getElementById('managerContent').classList.add('active');
    } else if (role === 'executive') {
        if (currentUser.level < 3) {
            showNotification('ìµœì¢… í‰ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        document.getElementById('executiveContent').classList.add('active');
    } else if (role === 'dashboard') {
        if (currentUser.level < 3) {
            showNotification('ëŒ€ì‹œë³´ë“œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        document.getElementById('dashboardContent').classList.add('active');
    } else if (role === 'permission') {
        if (currentUser.level < 3) {
            showNotification('ê¶Œí•œ ê´€ë¦¬ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        const permissionContent = document.getElementById('permissionContent');
        if (permissionContent) {
            permissionContent.classList.add('active');
            loadPermissionsList();
        }
    }
    
    setTimeout(forceDarkMode, 20);
}

// ===== ë””ë²„ê¹… í•¨ìˆ˜ =====
function checkDataStatus() {
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(status) {
            console.log('=== ë°ì´í„° ìƒíƒœ ===');
            for (const sheet in status) {
                console.log(`${sheet}: ${status[sheet].rows}í–‰`);
                console.log('ìƒ˜í”Œ ë°ì´í„°:', status[sheet].sample);
            }
            showLoading(false);
            showNotification('ì½˜ì†”ì—ì„œ ë°ì´í„° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'success');
        })
        .withFailureHandler(function(error) {
            showNotification('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .checkDataStatus();
}

// ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” =====
document.addEventListener('DOMContentLoaded', function() {
    forceDarkMode();
});

window.addEventListener('load', function() {
    forceDarkMode();
});

// ===== window.onload í•¨ìˆ˜ =====
window.onload = function() {
    console.log('í˜ì´ì§€ ë¡œë“œ ì‹œì‘ - currentUser:', currentUser);
    
    loadInitialData();
    
    setTimeout(() => {
        if (currentUser.level >= 1) {
            console.log('1ì°¨ í‰ê°€ í™”ë©´ìœ¼ë¡œ ì „í™˜');
            switchRole('teamlead');
            
            if (currentUser.level === 1 && currentUser.teamId) {
                setTimeout(() => {
                    const teamSelect = document.getElementById('evaluationTeamSelect');
                    if (teamSelect) {
                        for (let option of teamSelect.options) {
                            if (option.value && option.value !== currentUser.teamId) {
                                option.disabled = true;
                                option.style.color = '#666';
                            }
                        }
                        teamSelect.value = currentUser.teamId;
                        if (typeof loadTeamChannels === 'function') {
                            loadTeamChannels();
                        }
                    }
                }, 50);
            }
        } else {
            document.querySelector('.role-btn').click();
        }
    }, 50);
};
</script>
