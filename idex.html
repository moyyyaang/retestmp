<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œ</title>
    <?!= include('styles'); ?>
</head>
<body>
    <div class="container">
        <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
        <div class="loading" id="loadingSpinner">
            <div class="spinner"></div>
            <p style="margin-top: 15px; text-align: center;">ì²˜ë¦¬ì¤‘...</p>
        </div>
        
        <!-- ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì˜ì—­ -->
        <div class="user-info-bar">
            <div class="user-info-content">
                <div class="user-details">
                    <span class="user-icon">ğŸ‘¤</span>
                    <div>
                        <div class="user-name"><?= userInfo.name ?></div>
                        <div class="user-email"><?= userEmail ?></div>
                    </div>
                </div>
                <div class="user-permission">
                    <span class="permission-badge level-<?= userInfo.level ?>">
                        <?= userInfo.level === 3 ? 'ìµœê³  ê´€ë¦¬ì' : userInfo.level === 2 ? 'ì¤‘ê°„ ê´€ë¦¬ì' : 'í‰ê°€ì' ?>
                    </span>
                    <span class="department"><?= userInfo.department ?></span>
                </div>
            </div>
        </div>
        
        <!-- í—¤ë” ì˜ì—­ -->
        <div class="header">
            <h1>ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œ</h1>
            <p>ìŠ¤íŠœë””ì˜¤ë³„ ì±„ë„ ì„±ê³¼ë¥¼ ì²´ê³„ì ìœ¼ë¡œ í‰ê°€í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </div>
        
        <!-- ì—­í•  ì„ íƒ ë²„íŠ¼ -->
        <div class="role-selector">
            <? if (userInfo.level >= 2) { ?>
            <button class="role-btn" onclick="switchRole('management')">âš™ï¸ íŒ€ì›/ì±„ë„ ê´€ë¦¬</button>
            <? } ?>
            <button class="role-btn" onclick="switchRole('teamlead')">ğŸ“ 1ì°¨ í‰ê°€ (íŒ€ì¥)</button>
            <? if (userInfo.level >= 2) { ?>
            <button class="role-btn" onclick="switchRole('manager')">ğŸ”„ 2ì°¨ í‰ê°€ (ê´€ë¦¬ì)</button>
            <? } ?>
            <? if (userInfo.level >= 3) { ?>
            <button class="role-btn" onclick="switchRole('executive')">âœ… ìµœì¢… í‰ê°€ (ìµœì¢…ê´€ë¦¬ì)</button>
            <? } ?>
            <button class="role-btn" onclick="switchRole('comparison')">ğŸ“ˆ ì „ì›” ë¹„êµ</button>
            <? if (userInfo.level >= 3) { ?>
            <button class="role-btn" onclick="switchRole('permission')">âš™ï¸ ê¶Œí•œ ê´€ë¦¬</button>
            <? } ?>
        </div>
        
        <!-- ì•Œë¦¼ ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="alertBox" class="alert"></div>
        
        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <div class="content-area">
            <!-- ê´€ë¦¬ í™”ë©´ -->
            <? if (userInfo.level >= 2) { ?>
            <div id="managementContent" class="role-content">
                <h2>âš™ï¸ íŒ€ì› ë° ì±„ë„ ê´€ë¦¬</h2>
                
                <!-- íŒ€ í•„í„° -->
                <div class="team-filter-section">
                    <label>íŒ€ í•„í„°:</label>
                    <select id="managementTeamFilter" onchange="filterManagementByTeam()">
                        <option value="">ì „ì²´ íŒ€</option>
                        <option value="team1">ìŠ¤íŠœë””ì˜¤ 1íŒ€</option>
                        <option value="team2">ìŠ¤íŠœë””ì˜¤ 2íŒ€</option>
                        <option value="team3">ìŠ¤íŠœë””ì˜¤ 3íŒ€</option>
                        <option value="team4">ìŠ¤íŠœë””ì˜¤ 4íŒ€</option>
                        <option value="team5">ìŠ¤íŠœë””ì˜¤ 5íŒ€</option>
                    </select>
                </div>
                
                <div class="management-grid">
                    <!-- íŒ€ì› ê´€ë¦¬ ì¹´ë“œ -->
                    <div class="management-card">
                        <h4>ğŸ‘¥ íŒ€ì› ê´€ë¦¬</h4>
                        
                        <!-- íŒ€ì› ì¶”ê°€ -->
                        <div class="form-group">
                            <label>ìƒˆ íŒ€ì› ì¶”ê°€</label>
                            <input type="text" id="newMemberName" placeholder="íŒ€ì› ì´ë¦„">
                        </div>
                        <div class="form-group">
                            <select id="newMemberTeam">
                                <option value="">íŒ€ ì„ íƒ</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addNewMember()">â• íŒ€ì› ì¶”ê°€</button>
                        
                        <!-- íŒ€ì› ëª©ë¡ -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label>íŒ€ì› ëª©ë¡</label>
                            <div id="memberList" class="item-list"></div>
                        </div>
                    </div>
                    
                    <!-- ì±„ë„ ê´€ë¦¬ ì¹´ë“œ -->
                    <div class="management-card">
                        <h4>ğŸ“º ì±„ë„ ê´€ë¦¬</h4>
                        
                        <!-- ì±„ë„ ì¶”ê°€ -->
                        <div class="form-group">
                            <label>ìƒˆ ì±„ë„ ì¶”ê°€</label>
                            <input type="text" id="newChannelName" placeholder="ì±„ë„ëª…">
                        </div>
                        <div class="form-group">
                            <select id="newChannelTeam">
                                <option value="">íŒ€ ì„ íƒ</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addNewChannel()">â• ì±„ë„ ì¶”ê°€</button>
                        
                        <!-- ì±„ë„ ëª©ë¡ -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label>ì±„ë„ ëª©ë¡</label>
                            <div id="channelList" class="item-list"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ì±„ë„ë³„ íŒ€ì› í• ë‹¹ -->
                <div class="management-section" style="margin-top: 30px;">
                    <h3>ğŸ”— ì±„ë„ë³„ íŒ€ì› í• ë‹¹</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        ğŸ’¡ íŒ: 1ì°¨ í‰ê°€ í˜ì´ì§€ì—ì„œë„ ê° ì±„ë„ë³„ë¡œ íŒ€ì›ì„ ì§ì ‘ ì¶”ê°€/ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                    
                    <div class="selector-group">
                        <div class="selector-item">
                            <label>ì±„ë„ ì„ íƒ:</label>
                            <select id="channelForMemberAssignment" onchange="loadChannelMembersForAssignment()">
                                <option value="">ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="channelMemberAssignmentArea" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <label>íŒ€ í•„í„°:</label>
                            <select id="memberAssignmentTeamFilter" onchange="filterAssignmentMembers()">
                                <option value="">ì „ì²´ íŒ€ì›</option>
                                <option value="team1">ìŠ¤íŠœë””ì˜¤ 1íŒ€</option>
                                <option value="team2">ìŠ¤íŠœë””ì˜¤ 2íŒ€</option>
                                <option value="team3">ìŠ¤íŠœë””ì˜¤ 3íŒ€</option>
                                <option value="team4">ìŠ¤íŠœë””ì˜¤ 4íŒ€</option>
                                <option value="team5">ìŠ¤íŠœë””ì˜¤ 5íŒ€</option>
                            </select>
                        </div>
                        <h4>âœ… íŒ€ì› ì„ íƒ</h4>
                        <div id="memberCheckboxList" class="member-checkbox-list"></div>
                        <button class="btn btn-success" style="margin-top: 15px;" onclick="saveChannelMembers()">ğŸ’¾ ì„ íƒí•œ íŒ€ì› ì €ì¥</button>
                    </div>
                </div>
            </div>
            <? } ?>
            
            <!-- 1ì°¨ í‰ê°€ (íŒ€ì¥) í™”ë©´ -->
            <div id="teamleadContent" class="role-content">
                <h2>ğŸ“ 1ì°¨ í‰ê°€ - ì±„ë„ë³„ ì„±ê³¼ ì…ë ¥</h2>
                
                <div class="selector-group">
                    <div class="selector-item">
                        <label>í‰ê°€ì›”:</label>
                        <input type="month" id="evalMonth" onchange="checkExistingEvaluation()">
                    </div>
                    <div class="selector-item">
                        <label>í‰ê°€ì (íŒ€ì¥):</label>
                        <select id="teamleadSelect" onchange="checkExistingEvaluation()">
                            <option value="">íŒ€ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
                
                <div id="evaluationModeArea" style="display: none;">
                    <!-- ê¸°ì¡´ í‰ê°€ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
                    <div id="existingEvalInfo" class="eval-info-box" style="display: none;">
                        <h3>ğŸ“‹ ê¸°ì¡´ í‰ê°€ ì •ë³´</h3>
                        <div class="eval-info-item">
                            <span class="eval-info-label">ìµœì¢… ìˆ˜ì •:</span>
                            <span class="eval-info-value" id="lastModified"></span>
                        </div>
                        <div class="eval-info-item">
                            <span class="eval-info-label">í‰ê°€ ì±„ë„:</span>
                            <span class="eval-info-value" id="evaluatedChannelsList"></span>
                        </div>
                        <button class="btn btn-warning" onclick="enableEditMode()">âœï¸ í‰ê°€ ìˆ˜ì •í•˜ê¸°</button>
                    </div>
                    
                    <!-- ì‹ ê·œ/ìˆ˜ì • í‰ê°€ ì˜ì—­ -->
                    <div id="evaluationEditArea" style="display: none;">
                        <? if (userInfo.level >= 2) { ?>
                        <div class="selector-group">
                            <div class="selector-item">
                                <label>íŒ€ ì„ íƒ:</label>
                                <select id="evaluationTeamSelect" onchange="loadTeamChannels()">
                                    <option value="">íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="team1">ìŠ¤íŠœë””ì˜¤ 1íŒ€</option>
                                    <option value="team2">ìŠ¤íŠœë””ì˜¤ 2íŒ€</option>
                                    <option value="team3">ìŠ¤íŠœë””ì˜¤ 3íŒ€</option>
                                    <option value="team4">ìŠ¤íŠœë””ì˜¤ 4íŒ€</option>
                                    <option value="team5">ìŠ¤íŠœë””ì˜¤ 5íŒ€</option>
                                </select>
                            </div>
                        </div>
                        <? } ?>
                        
                        <div id="teamChannelsArea" style="display: none;">
                            <h3>ğŸ“º í‰ê°€í•  ì±„ë„ ì„ íƒ</h3>
                            <div id="channelCheckboxArea" class="channel-checkbox-area"></div>
                            <button class="btn btn-primary" style="margin: 20px 0;" onclick="loadSelectedChannels()">ğŸ¯ ì„ íƒí•œ ì±„ë„ í‰ê°€í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
                
                <div id="channelEvaluationsArea"></div>
                
                <button class="submit-btn" id="submitFirstEvalBtn" style="display: none;" onclick="submitFirstEvaluation()">âœ¨ 1ì°¨ í‰ê°€ ìµœì¢… ì œì¶œ</button>
            </div>
            
            <!-- 2ì°¨ í‰ê°€ (ê´€ë¦¬ì) í™”ë©´ -->
            <? if (userInfo.level >= 2) { ?>
            <div id="managerContent" class="role-content">
                <h2>ğŸ”„ 2ì°¨ í‰ê°€ - í‰ê°€ ì¡°ì •</h2>
                
                <div class="selector-group">
                    <div class="selector-item">
                        <label>í‰ê°€ì›”:</label>
                        <input type="month" id="evalMonth2nd">
                    </div>
                    <button class="btn btn-primary" onclick="loadSecondEvaluation()">ğŸ“¥ í‰ê°€ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
                
                <div id="secondEvaluationArea"></div>
                <button class="submit-btn" id="submitSecondEvalBtn" style="display: none;" onclick="submitSecondEvaluation()">âœ¨ 2ì°¨ í‰ê°€ ì €ì¥</button>
            </div>
            <? } ?>
            
            <!-- ìµœì¢… í‰ê°€ (ìµœì¢…ê´€ë¦¬ì) í™”ë©´ -->
            <? if (userInfo.level >= 3) { ?>
            <div id="executiveContent" class="role-content">
                <h2>âœ… ìµœì¢… í‰ê°€ - ì„±ê³¼ê¸ˆ ì±…ì •</h2>
                
                <div class="selector-group">
                    <div class="selector-item">
                        <label>í‰ê°€ì›”:</label>
                        <input type="month" id="evalMonthFinal">
                    </div>
                    <button class="btn btn-primary" onclick="loadFinalEvaluation()">ğŸ“¥ í‰ê°€ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
                
                <div id="finalEvaluationArea"></div>
                <button class="submit-btn" id="submitFinalEvalBtn" style="display: none;" onclick="submitFinalEvaluation()">ğŸ‰ ì´ë‹¬ì˜ í‰ê°€ ìµœì¢… í™•ì •</button>
            </div>
            <? } ?>
            
            <!-- ì „ì›” ë¹„êµ í™”ë©´ -->
            <div id="comparisonContent" class="role-content">
                <h2>ğŸ“ˆ ì „ì›” ë¹„êµ ë¶„ì„</h2>
                
                <? if (userInfo.level === 1) { ?>
                <div class="comparison-tabs">
                    <button class="comparison-tab active" data-type="team" onclick="switchComparisonTab('team')">ğŸ“Š ë‚´ íŒ€ ë¹„êµ</button>
                </div>
                <? } else { ?>
                <div class="comparison-tabs">
                    <button class="comparison-tab active" data-type="all" onclick="switchComparisonTab('all')">ğŸ“Š ì „ì²´ ë¹„êµ</button>
                    <? if (userInfo.teamId) { ?>
                    <button class="comparison-tab" data-type="team" onclick="switchComparisonTab('team')">ğŸ“Š ë‚´ íŒ€ ë¹„êµ</button>
                    <? } ?>
                </div>
                <? } ?>
                
                <div class="selector-group">
                    <div class="selector-item">
                        <label>ë¹„êµ ê¸°ì¤€ì›”:</label>
                        <input type="month" id="compareMonth1">
                    </div>
                    <div class="selector-item">
                        <label>ë¹„êµ ëŒ€ìƒì›”:</label>
                        <input type="month" id="compareMonth2">
                    </div>
                    <button class="btn btn-primary" onclick="loadComparisonData()">ğŸ” ë¹„êµ ë¶„ì„ ì‹¤í–‰</button>
                </div>
                
                <div id="comparisonArea"></div>
            </div>
            
            <!-- ê¶Œí•œ ê´€ë¦¬ í™”ë©´ -->
            <? if (userInfo.level >= 3) { ?>
            <div id="permissionContent" class="role-content">
                <h2>âš™ï¸ ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬</h2>
                
                <div class="management-section">
                    <h3>â• ìƒˆ ì‚¬ìš©ì ì¶”ê°€</h3>
                    <div class="management-grid" style="grid-template-columns: 1fr;">
                        <div class="management-card">
                            <div class="form-group">
                                <label>ì´ë©”ì¼ (@awesomeent.kr)</label>
                                <input type="email" id="newUserEmail" placeholder="user@awesomeent.kr">
                            </div>
                            <div class="form-group">
                                <label>ì´ë¦„</label>
                                <input type="text" id="newUserName" placeholder="í™ê¸¸ë™">
                            </div>
                            <div class="form-group">
                                <label>ë¶€ì„œ</label>
                                <input type="text" id="newUserDept" placeholder="ìŠ¤íŠœë””ì˜¤ 1íŒ€">
                            </div>
                            <div class="form-group">
                                <label>ê¶Œí•œ ë ˆë²¨</label>
                                <select id="newUserLevel">
                                    <option value="1">1 - 1ì°¨ í‰ê°€ë§Œ</option>
                                    <option value="2">2 - 1ì°¨/2ì°¨ í‰ê°€</option>
                                    <option value="3">3 - ì „ì²´ ê¶Œí•œ</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="addNewUser()">â• ì‚¬ìš©ì ì¶”ê°€</button>
                        </div>
                    </div>
                </div>
                
                <div class="management-section">
                    <h3>ğŸ‘¥ ì‚¬ìš©ì ê¶Œí•œ ëª©ë¡</h3>
                    <div id="permissionsList" class="permissions-list"></div>
                </div>
                
                <div class="management-section">
                    <h3>ğŸ“‹ ì•¡ì…˜ ë¡œê·¸</h3>
                    <button class="btn btn-primary" onclick="loadActionLogs()" style="margin-bottom: 15px;">ğŸ”„ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨</button>
                    <div id="actionLogsList" class="action-logs-list"></div>
                </div>
            </div>
            <? } ?>
        </div>
    </div>
    
    <!-- JavaScript í¬í•¨ -->
    <?!= include('utils'); ?>
    <?!= include('management'); ?>
    <?!= include('evaluation'); ?>
    
    <script>
        // ===== ì‚¬ìš©ì ì •ë³´ ì „ì—­ ë³€ìˆ˜ =====
        const currentUser = {
            email: '<?= userEmail ?>',
            name: '<?= userInfo.name ?>',
            department: '<?= userInfo.department ?>',
            level: <?= userInfo.level ?>,
            teamId: '<?= userInfo.teamId || '' ?>',
            teamleadId: '<?= userInfo.teamleadId || '' ?>'
        };
        
        // ===== ì „ì›” ë¹„êµ íƒ­ ì „í™˜ =====
        function switchComparisonTab(type) {
            document.querySelectorAll('.comparison-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // ===== ì´ˆê¸°í™” =====
        window.onload = function() {
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadInitialData();
            
            // ê¶Œí•œì— ë”°ë¥¸ ì²« í™”ë©´ ì„¤ì •
            setTimeout(() => {
                if (currentUser.level >= 1) {
                    // 1ì°¨ í‰ê°€ ê¶Œí•œì´ ìˆìœ¼ë©´ 1ì°¨ í‰ê°€ í™”ë©´ìœ¼ë¡œ
                    switchRole('teamlead');
                } else {
                    // ê¶Œí•œì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ê°€ëŠ¥í•œ í™”ë©´ìœ¼ë¡œ
                    document.querySelector('.role-btn').click();
                }
            }, 100);
        };
        
        // ===== ê¶Œí•œ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
        function loadPermissionsList() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(permissions) {
                    displayPermissionsList(permissions);
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('ê¶Œí•œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
                    showLoading(false);
                })
                .getPermissionsList();
        }
        
        function displayPermissionsList(permissions) {
            const listDiv = document.getElementById('permissionsList');
            let html = `
                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th>ì´ë©”ì¼</th>
                            <th>ì´ë¦„</th>
                            <th>ë¶€ì„œ</th>
                            <th>ê¶Œí•œë ˆë²¨</th>
                            <th>ìƒíƒœ</th>
                            <th>ë“±ë¡ì¼ì‹œ</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            permissions.forEach(user => {
                const levelText = user.level === 1 ? '1ì°¨ í‰ê°€' : user.level === 2 ? '1-2ì°¨ í‰ê°€' : 'ì „ì²´ ê¶Œí•œ';
                const statusClass = user.active === 'Y' ? 'positive-change' : 'negative-change';
                const statusText = user.active === 'Y' ? 'í™œì„±' : 'ë¹„í™œì„±';
                
                html += `
                    <tr>
                        <td>${user.email}</td>
                        <td>${user.name}</td>
                        <td>${user.department}</td>
                        <td>
                            <select onchange="updateUserLevel('${user.email}', this.value)" ${user.email === currentUser.email ? 'disabled' : ''}>
                                <option value="1" ${user.level === 1 ? 'selected' : ''}>1 - 1ì°¨ í‰ê°€ë§Œ</option>
                                <option value="2" ${user.level === 2 ? 'selected' : ''}>2 - 1ì°¨/2ì°¨ í‰ê°€</option>
                                <option value="3" ${user.level === 3 ? 'selected' : ''}>3 - ì „ì²´ ê¶Œí•œ</option>
                            </select>
                        </td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>${user.registeredDate}</td>
                        <td>
                            <button class="btn ${user.active === 'Y' ? 'btn-danger' : 'btn-success'}" 
                                    style="padding: 5px 10px; font-size: 12px;"
                                    onclick="toggleUserStatus('${user.email}')"
                                    ${user.email === currentUser.email ? 'disabled' : ''}>
                                ${user.active === 'Y' ? 'ğŸ”’ ë¹„í™œì„±í™”' : 'ğŸ”“ í™œì„±í™”'}
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            listDiv.innerHTML = html;
        }
        
        function addNewUser() {
            const email = document.getElementById('newUserEmail').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const department = document.getElementById('newUserDept').value.trim();
            const level = document.getElementById('newUserLevel').value;
            
            if (!email || !name || !department) {
                showAlert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (!email.endsWith('@awesomeent.kr')) {
                showAlert('íšŒì‚¬ ì´ë©”ì¼(@awesomeent.kr)ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        showAlert(result.message, 'success');
                        document.getElementById('newUserEmail').value = '';
                        document.getElementById('newUserName').value = '';
                        document.getElementById('newUserDept').value = '';
                        document.getElementById('newUserLevel').value = '1';
                        loadPermissionsList();
                    } else {
                        showAlert(result.message, 'error');
                    }
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨: ' + error, 'error');
                    showLoading(false);
                })
                .addUserPermission({
                    email: email,
                    name: name,
                    department: department,
                    level: parseInt(level)
                });
        }
        
        function updateUserLevel(email, newLevel) {
            if (!confirm(`${email}ì˜ ê¶Œí•œì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                loadPermissionsList();
                return;
            }
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(result) {
                    showAlert(result.message, result.success ? 'success' : 'error');
                    loadPermissionsList();
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('ê¶Œí•œ ìˆ˜ì • ì‹¤íŒ¨: ' + error, 'error');
                    loadPermissionsList();
                    showLoading(false);
                })
                .updateUserPermission(email, parseInt(newLevel));
        }
        
        function toggleUserStatus(email) {
            const action = confirm(`${email}ì˜ ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!action) return;
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(result) {
                    showAlert(result.message, result.success ? 'success' : 'error');
                    loadPermissionsList();
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + error, 'error');
                    showLoading(false);
                })
                .toggleUserActive(email);
        }
        
        function loadActionLogs() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(logs) {
                    displayActionLogs(logs);
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('ì•¡ì…˜ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
                    showLoading(false);
                })
                .getActionLogs(50);
        }
        
        function displayActionLogs(logs) {
            const logsDiv = document.getElementById('actionLogsList');
            
            if (logs.length === 0) {
                logsDiv.innerHTML = '<p style="text-align: center; color: #aaa;">ì•¡ì…˜ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let html = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="evaluation-table">
                        <thead>
                            <tr>
                                <th>ì¼ì‹œ</th>
                                <th>ì‚¬ìš©ì</th>
                                <th>ì•¡ì…˜</th>
                                <th>ìƒì„¸ë‚´ìš©</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            logs.forEach(log => {
                html += `
                    <tr>
                        <td>${log.timestamp}</td>
                        <td>${log.user}</td>
                        <td>${log.action}</td>
                        <td>${log.details}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            logsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
