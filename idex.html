<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>성과 평가 시스템</title>
    <?!= include('styles'); ?>
</head>
<body>
    <div class="container">
        <!-- 로딩 스피너 -->
        <div class="loading" id="loadingSpinner">
            <div class="spinner"></div>
            <p style="margin-top: 15px; text-align: center;">처리중...</p>
        </div>
        
        <!-- 헤더 영역 -->
        <div class="header">
            <h1>성과 평가 시스템</h1>
            <p>스튜디오별 채널 성과를 체계적으로 평가하고 관리합니다</p>
        </div>
        
        <!-- 역할 선택 버튼 -->
        <div class="role-selector">
            <button class="role-btn" onclick="switchRole('management')">팀원/채널 관리</button>
            <button class="role-btn" onclick="switchRole('teamlead')">1차 평가 (팀장)</button>
            <button class="role-btn" onclick="switchRole('manager')">2차 평가 (관리자)</button>
            <button class="role-btn" onclick="switchRole('executive')">최종 평가 (최종관리자)</button>
        </div>
        
        <!-- 알림 메시지 영역 -->
        <div id="alertBox" class="alert"></div>
        
        <!-- 메인 콘텐츠 영역 -->
        <div class="content-area">
            <!-- 관리 화면 -->
            <div id="managementContent" class="role-content">
                <h2>팀원 및 채널 관리</h2>
                
                <!-- 팀 필터 -->
                <div class="team-filter-section">
                    <label>팀 필터:</label>
                    <select id="managementTeamFilter" onchange="filterManagementByTeam()">
                        <option value="">전체 팀</option>
                        <option value="team1">스튜디오 1팀</option>
                        <option value="team2">스튜디오 2팀</option>
                        <option value="team3">스튜디오 3팀</option>
                        <option value="team4">스튜디오 4팀</option>
                        <option value="team5">스튜디오 5팀</option>
                    </select>
                </div>
                
                <div class="management-grid">
                    <!-- 팀원 관리 카드 -->
                    <div class="management-card">
                        <h4>팀원 관리</h4>
                        
                        <!-- 팀원 추가 -->
                        <div class="form-group">
                            <label>새 팀원 추가</label>
                            <input type="text" id="newMemberName" placeholder="팀원 이름">
                        </div>
                        <div class="form-group">
                            <select id="newMemberTeam">
                                <option value="">팀 선택</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addNewMember()">팀원 추가</button>
                        
                        <!-- 팀원 목록 -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label>팀원 목록</label>
                            <div id="memberList" class="item-list"></div>
                        </div>
                    </div>
                    
                    <!-- 채널 관리 카드 -->
                    <div class="management-card">
                        <h4>채널 관리</h4>
                        
                        <!-- 채널 추가 -->
                        <div class="form-group">
                            <label>새 채널 추가</label>
                            <input type="text" id="newChannelName" placeholder="채널명">
                        </div>
                        <div class="form-group">
                            <select id="newChannelTeam">
                                <option value="">팀 선택</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addNewChannel()">채널 추가</button>
                        
                        <!-- 채널 목록 -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label>채널 목록</label>
                            <div id="channelList" class="item-list"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 채널별 팀원 할당 -->
                <div class="management-section" style="margin-top: 30px;">
                    <h3>채널별 팀원 할당</h3>
                    
                    <div class="selector-group">
                        <div class="selector-item">
                            <label>채널 선택:</label>
                            <select id="channelForMemberAssignment" onchange="loadChannelMembersForAssignment()">
                                <option value="">채널을 선택하세요</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="channelMemberAssignmentArea" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <label>팀 필터:</label>
                            <select id="memberAssignmentTeamFilter" onchange="filterAssignmentMembers()">
                                <option value="">전체 팀원</option>
                                <option value="team1">스튜디오 1팀</option>
                                <option value="team2">스튜디오 2팀</option>
                                <option value="team3">스튜디오 3팀</option>
                                <option value="team4">스튜디오 4팀</option>
                                <option value="team5">스튜디오 5팀</option>
                            </select>
                        </div>
                        <h4>팀원 선택</h4>
                        <div id="memberCheckboxList" class="member-checkbox-list"></div>
                        <button class="btn btn-success" style="margin-top: 15px;" onclick="saveChannelMembers()">선택한 팀원 저장</button>
                    </div>
                </div>
                
                <!-- 디버깅 버튼 -->
                <button class="btn btn-warning" style="margin-top: 20px;" onclick="checkDataStatus()">데이터 상태 확인</button>
            </div>
            
            <!-- 1차 평가 (팀장) 화면 -->
            <div id="teamleadContent" class="role-content">
                <h2>1차 평가 - 채널별 성과 입력</h2>
                
                <div class="selector-group">
                    <div class="selector-item">
                        <label>평가월:</label>
                        <input type="month" id="evalMonth" onchange="checkExistingEvaluation()">
                    </div>
                    <div class="selector-item">
                        <label>평가자 (팀장):</label>
                        <select id="teamleadSelect" onchange="checkExistingEvaluation()">
                            <option value="">팀장을 선택하세요</option>
                        </select>
                    </div>
                </div>
                
                <div id="evaluationModeArea" style="display: none;">
                    <!-- 기존 평가 정보 표시 영역 -->
                    <div id="existingEvalInfo" class="eval-info-box" style="display: none;">
                        <h3>기존 평가 정보</h3>
                        <div class="eval-info-item">
                            <span class="eval-info-label">최종 수정:</span>
                            <span class="eval-info-value" id="lastModified"></span>
                        </div>
                        <div class="eval-info-item">
                            <span class="eval-info-label">평가 채널:</span>
                            <span class="eval-info-value" id="evaluatedChannelsList"></span>
                        </div>
                        <button class="btn btn-warning" onclick="enableEditMode()">평가 수정하기</button>
                    </div>
                    
                    <!-- 신규/수정 평가 영역 -->
                    <div id="evaluationEditArea" style="display: none;">
                        <div class="selector-group">
                            <div class="selector-item">
                                <label>팀 선택:</label>
                                <select id="evaluationTeamSelect" onchange="loadTeamChannels()">
                                    <option value="">팀을 선택하세요</option>
                                    <option value="team1">스튜디오 1팀</option>
                                    <option value="team2">스튜디오 2팀</option>
                                    <option value="team3">스튜디오 3팀</option>
                                    <option value="team4">스튜디오 4팀</option>
                                    <option value="team5">스튜디오 5팀</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="teamChannelsArea" style="display: none;">
                            <h3>평가할 채널 선택</h3>
                            <div id="channelCheckboxArea" class="channel-checkbox-area"></div>
                            <button class="btn btn-primary" style="margin: 20px 0;" onclick="loadSelectedChannels()">선택한 채널 평가하기</button>
                        </div>
                    </div>
                </div>
                
                <div id="channelEvaluationsArea"></div>
                
                <button class="submit-btn" id="submitFirstEvalBtn" style="display: none;" onclick="submitFirstEvaluation()">1차 평가 최종 제출</button>
            </div>
            
            <!-- 2차 평가 (관리자) 화면 -->
            <div id="managerContent" class="role-content">
                <h2>2차 평가 - 평가 조정</h2>
                
                <div class="selector-group">
                    <div class="selector-item">
                        <label>평가월:</label>
                        <input type="month" id="evalMonth2nd">
                    </div>
                    <button class="btn btn-primary" onclick="loadSecondEvaluation()">평가 데이터 불러오기</button>
                    <button class="btn btn-warning" onclick="debugEvaluation()">데이터 확인 (디버깅)</button>
                </div>
                
                <div id="secondEvaluationArea"></div>
                <button class="submit-btn" id="submitSecondEvalBtn" style="display: none;" onclick="submitSecondEvaluation()">2차 평가 저장</button>
            </div>
            
            <!-- 최종 평가 (최종관리자) 화면 -->
            <div id="executiveContent" class="role-content">
                <h2>최종 평가 - 성과금 책정</h2>
                
                <div class="selector-group">
                    <div class="selector-item">
                        <label>평가월:</label>
                        <input type="month" id="evalMonthFinal">
                    </div>
                    <button class="btn btn-primary" onclick="loadFinalEvaluation()">평가 데이터 불러오기</button>
                </div>
                
                <div id="finalEvaluationArea"></div>
                <button class="submit-btn" id="submitFinalEvalBtn" style="display: none;" onclick="submitFinalEvaluation()">이달의 평가 최종 확정</button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript 포함 -->
    <?!= include('utils'); ?>
    <?!= include('management'); ?>
    <?!= include('evaluation'); ?>
    
    <script>
        // ===== 초기화 =====
        window.onload = function() {
            // 초기 데이터 로드
            loadInitialData();
            
            // 기본적으로 관리 화면 표시
            setTimeout(() => {
                document.querySelector('.role-btn').click();
            }, 100);
        };
    </script>
</body>
</html>
