<!DOCTYPE html>
<html>
<head>
    <!-- Chart.js CDN ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œ</title>
    <?!= include('styles'); ?>
</head>
<body>
    <div class="container">
        <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
        <div class="loading" id="loadingSpinner">
            <div class="spinner"></div>
            <p style="margin-top: 15px; text-align: center;">ì²˜ë¦¬ì¤‘...</p>
        </div>
        
        <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ (UI ì°¨ë‹¨ìš©) -->
        <div class="loading-overlay" id="loadingOverlay"></div>

        <!-- 5. ì§„í–‰ë¥  í‘œì‹œ ì˜ì—­ (ë¡œë”© ìŠ¤í”¼ë„ˆ ì•„ë˜) -->
        <div id="progressContainer" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9998;">
            <div style="background: #272727; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                 <p style="margin-bottom: 10px; color: #f1f1f1;">ì²˜ë¦¬ ì¤‘...</p>
                 <div style="width: 300px; height: 20px; background: #0f0f0f; border-radius: 10px; overflow: hidden;">
                      <div id="progressBar" style="width: 0%; height: 100%; background: #1a73e8; transition: width 0.3s;"></div>
                 </div>
            </div>
        </div>
        <!-- ì‹¤ì‹œê°„ ì•Œë¦¼ íŒì—… -->
        <div id="notificationPopup" class="notification-popup">
            <div class="notification-header">
                <span>ğŸ”” ì•Œë¦¼</span>
                <button onclick="closeNotification()" class="close-btn">Ã—</button>
            </div>
            <div id="notificationContent" class="notification-content"></div>
        </div>
        
        <!-- ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì˜ì—­ -->
        <div class="user-info-bar">
            <div class="user-info-content">
                <div class="user-details">
                    <span class="user-icon">ğŸ‘¤</span>
                    <div>
                        <div class="user-name"><?= userInfo.name ?></div>
                        <div class="user-email"><?= userEmail ?></div>
                    </div>
                </div>
                <div class="user-controls">
                    <!-- í…Œë§ˆ ì „í™˜ ë²„íŠ¼ -->
                    <button id="themeToggleBtn" class="theme-toggle-btn" onclick="toggleTheme()" title="ë‹¤í¬/ë¼ì´íŠ¸ëª¨ë“œ ì „í™˜">
                        <span id="themeIcon">ğŸŒ™</span>
                    </button>
                    
                    <!-- UI ì ê¹€ í•´ì œ ë²„íŠ¼ (ë””ë²„ê¹…ìš©) -->
                    <button class="theme-toggle-btn" onclick="forceUnlockUI()" title="UI ì ê¹€ ê°•ì œ í•´ì œ" style="margin-left: 5px;">
                        ğŸ”“
                    </button>
                    
                    <!-- ì‹œíŠ¸ êµ¬ì¡° ë””ë²„ê¹… ë²„íŠ¼ -->
                    <button class="theme-toggle-btn" onclick="debugSheets()" title="ì‹œíŠ¸ êµ¬ì¡° ë””ë²„ê¹…" style="margin-left: 5px;">
                        ğŸ”
                    </button>
                    
                    <div class="user-permission">
                        <span class="permission-badge level-<?= userInfo.level ?>">
                            <?= userInfo.level === 3 ? 'ìµœê³  ê´€ë¦¬ì' : userInfo.level === 2 ? 'ì¤‘ê°„ ê´€ë¦¬ì' : 'í‰ê°€ì' ?>
                        </span>
                        <span class="department"><?= userInfo.department ?></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- í—¤ë” ì˜ì—­ -->
        <div class="header">
            <h1>ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œ Ver.1 </h1>
            <p>ìŠ¤íŠœë””ì˜¤ë³„ ì±„ë„ ì„±ê³¼ë¥¼ ì²´ê³„ì ìœ¼ë¡œ í‰ê°€í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤
              ì‚¬ìš©ë¬¸ì˜: ëª¨ì–‘íƒœ ë³¸ë¶€ì¥ã…£ì˜ ì•ˆë˜ë©´ ìƒˆë¡œê³ ì¹¨ í•´ë³´ì„¸ìš” (ì´ˆê¸°í™”)
            </p>
        </div>
        <div class="shortcut-info" style="background: #212121; padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center; color: #aaa;">
         ğŸŸ¨ í‰ê°€ì›” ì„ íƒ >  í‰ê°€ìì„ íƒ > íŒ€ì„ íƒ > ì±„ë„ì„ íƒ í•˜ê³  ì±„ë„í‰ê°€í•˜ê¸° ë²„íŠ¼ ëˆ„ë¥´ê¸° âœ…ì±„ë„ì— íŒ€ì›ì¶”ê°€ í•œë²ˆì— í•˜ë ¤ë©´ íŒ€ì›/ì±„ë„ê´€ë¦¬ íƒ­ì—ì„œ ê´€ë¦¬  ğŸ’¡ ë‹¨ì¶•í‚¤: <strong>Ctrl+S</strong> ì €ì¥
         <span id="autoSaveStatus">ìë™ ì €ì¥: 5ë¶„ë§ˆë‹¤</span>
        </div>
        <!-- ì—­í•  ì„ íƒ ë²„íŠ¼ -->
        <div class="role-selector">
            <button class="role-btn" onclick="switchRole('management')">âš™ï¸ íŒ€ì›/ì±„ë„ ê´€ë¦¬</button>
            <button class="role-btn" onclick="switchRole('teamlead')">ğŸ“ 1ì°¨ í‰ê°€ (íŒ€ì¥)</button>
            <? if (parseInt(userInfo.level) >= 2 || userInfo.level >= 2 || userInfo.level === "2" || userInfo.level === "3") { ?>
            <button class="role-btn" onclick="switchRole('manager')">ğŸ”„ 2ì°¨ í‰ê°€ (ê´€ë¦¬ì)</button>
            <? } ?>
            <? if (parseInt(userInfo.level) >= 3 || userInfo.level >= 3 || userInfo.level === "3") { ?>
            <button class="role-btn" onclick="switchRole('executive')">âœ… ìµœì¢… í‰ê°€ (ìµœì¢…ê´€ë¦¬ì)</button>
            <button class="role-btn" onclick="switchRole('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
            <button class="role-btn" onclick="switchRole('permission')">âš™ï¸ ê¶Œí•œ ê´€ë¦¬</button>
            <? } ?>
        </div>
        
        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <div class="content-area">
            <!-- ê´€ë¦¬ í™”ë©´ -->
            <div id="managementContent" class="role-content">
                <h2>âš™ï¸ íŒ€ì› ë° ì±„ë„ ê´€ë¦¬</h2>
                
                <!-- íŒ€ í•„í„° -->
                <? if (userInfo.level >= 2) { ?>
                <div class="team-filter-section">
                    <label>íŒ€ í•„í„°:</label>
                    <select id="managementTeamFilter" onchange="filterManagementByTeam()">
                        <option value="">ì „ì²´ íŒ€</option>
                        <option value="team1">ìŠ¤íŠœë””ì˜¤ 1íŒ€</option>
                        <option value="team2">ìŠ¤íŠœë””ì˜¤ 2íŒ€</option>
                        <option value="team3">ìŠ¤íŠœë””ì˜¤ 3íŒ€</option>
                        <option value="team4">ìŠ¤íŠœë””ì˜¤ 4íŒ€</option>
                        <option value="team5">ìŠ¤íŠœë””ì˜¤ 5íŒ€</option>
                        <option value="team6">ì´¬ì˜íŒ€</option>
                    </select>
                </div>
                <? } else { ?>
                <div class="team-filter-section">
                    <p style="color: #aaa;">ğŸ‘¥ <?= userInfo.department ?> ê´€ë¦¬</p>
                </div>
                <? } ?>
                
                <div class="management-grid">
                    <!-- íŒ€ì› ê´€ë¦¬ ì¹´ë“œ -->
                    <div class="management-card">
                        <h4>ğŸ‘¥ íŒ€ì› ê´€ë¦¬</h4>
                        
                        <!-- íŒ€ì› ì¶”ê°€ -->
                        <div class="form-group">
                            <label>ìƒˆ íŒ€ì› ì¶”ê°€</label>
                            <input type="text" id="newMemberName" placeholder="íŒ€ì› ì´ë¦„">
                        </div>
                        <div class="form-group">
                            <select id="newMemberTeam">
                                <option value="">íŒ€ ì„ íƒ</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addNewMember()">â• íŒ€ì› ì¶”ê°€</button>
                        
                        <!-- íŒ€ì› ëª©ë¡ -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label>íŒ€ì› ëª©ë¡</label>
                            <div id="memberList" class="item-list"></div>
                        </div>
                    </div>
                    
                    <!-- ì±„ë„ ê´€ë¦¬ ì¹´ë“œ -->
                    <div class="management-card">
                        <h4>ğŸ“º ì±„ë„ ê´€ë¦¬</h4>
                        
                        <!-- ì±„ë„ ì¶”ê°€ -->
                        <div class="form-group">
                            <label>ìƒˆ ì±„ë„ ì¶”ê°€</label>
                            <input type="text" id="newChannelName" placeholder="ì±„ë„ëª…">
                        </div>
                        <div class="form-group">
                            <select id="newChannelTeam">
                                <option value="">íŒ€ ì„ íƒ</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addNewChannel()">â• ì±„ë„ ì¶”ê°€</button>
                        
                        <!-- ì±„ë„ ëª©ë¡ -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label>ì±„ë„ ëª©ë¡</label>
                            <div id="channelList" class="item-list"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ì±„ë„ë³„ íŒ€ì› í• ë‹¹ -->
                <div class="management-section" style="margin-top: 30px;">
                    <h3>ğŸ”— ì±„ë„ë³„ íŒ€ì› í• ë‹¹</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        ğŸ’¡ íŒ: 1ì°¨ í‰ê°€ í˜ì´ì§€ì—ì„œë„ ê° ì±„ë„ë³„ë¡œ íŒ€ì›ì„ ì§ì ‘ ì¶”ê°€/ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                    
                    <div class="selector-group">
                        <div class="selector-item">
                            <label>ì±„ë„ ì„ íƒ:</label>
                            <select id="channelForMemberAssignment" onchange="loadChannelMembersForAssignment()">
                                <option value="">ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="channelMemberAssignmentArea" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <label>íŒ€ í•„í„°:</label>
                            <select id="memberAssignmentTeamFilter" onchange="filterAssignmentMembers()">
                                <option value="">ì „ì²´ íŒ€ì›</option>
                                <option value="team1">ìŠ¤íŠœë””ì˜¤ 1íŒ€</option>
                                <option value="team2">ìŠ¤íŠœë””ì˜¤ 2íŒ€</option>
                                <option value="team3">ìŠ¤íŠœë””ì˜¤ 3íŒ€</option>
                                <option value="team4">ìŠ¤íŠœë””ì˜¤ 4íŒ€</option>
                                <option value="team5">ìŠ¤íŠœë””ì˜¤ 5íŒ€</option>
                                <option value="team6">ì´¬ì˜íŒ€</option>
                            </select>
                        </div>
                        <h4>âœ… íŒ€ì› ì„ íƒ</h4>
                        <div id="memberCheckboxList" class="member-checkbox-list"></div>
                        <button class="btn btn-success" style="margin-top: 15px;" onclick="saveChannelMembers()">ğŸ’¾ ì„ íƒí•œ íŒ€ì› ì €ì¥</button>
                    </div>
                </div>
            </div>
            
            <!-- 1ì°¨ í‰ê°€ (íŒ€ì¥) í™”ë©´ -->
            <div id="teamleadContent" class="role-content">
                <h2>ğŸ“ 1ì°¨ í‰ê°€ - ì±„ë„ë³„ ì„±ê³¼ ì…ë ¥</h2>
                
                <div class="selector-group">
                    <div class="selector-item">
                        <label>í‰ê°€ì›”:</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="evalYear" onchange="updateEvalMonth()">
                                <option value="2024">2024ë…„</option>
                                <option value="2025">2025ë…„</option>
                                <option value="2026">2026ë…„</option>
                                <option value="2027">2027ë…„</option>
                            </select>
                            <select id="evalMonthSelect" onchange="updateEvalMonth()">
                                <option value="01">1ì›”</option>
                                <option value="02">2ì›”</option>
                                <option value="03">3ì›”</option>
                                <option value="04">4ì›”</option>
                                <option value="05">5ì›”</option>
                                <option value="06">6ì›”</option>
                                <option value="07">7ì›”</option>
                                <option value="08">8ì›”</option>
                                <option value="09">9ì›”</option>
                                <option value="10">10ì›”</option>
                                <option value="11">11ì›”</option>
                                <option value="12">12ì›”</option>
                            </select>
                        </div>
                        <input type="hidden" id="evalMonth">
                    </div>
                    <div class="selector-item">
                        <label>í‰ê°€ì (íŒ€ì¥):</label>
                        <select id="teamleadSelect" onchange="checkExistingEvaluation()">
                            <option value="">íŒ€ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
                
                <div id="evaluationModeArea" style="display: none;">
                    <!-- ê¸°ì¡´ í‰ê°€ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
                    <div id="existingEvalInfo" class="eval-info-box" style="display: none;">
                        <h3>ğŸ“‹ ê¸°ì¡´ í‰ê°€ ì •ë³´</h3>
                        <div class="eval-info-item">
                            <span class="eval-info-label">ìµœì¢… ìˆ˜ì •:</span>
                            <span class="eval-info-value" id="lastModified"></span>
                        </div>
                        <div class="eval-info-item">
                            <span class="eval-info-label">í‰ê°€ ì±„ë„:</span>
                            <span class="eval-info-value" id="evaluatedChannelsList"></span>
                        </div>
                        <button class="btn btn-warning" onclick="enableEditMode()">âœï¸ í‰ê°€ ìˆ˜ì •í•˜ê¸°</button>
                    </div>
                    
                    <!-- ì‹ ê·œ/ìˆ˜ì • í‰ê°€ ì˜ì—­ -->
                    <div id="evaluationEditArea" style="display: none;">
                        <div class="selector-group">
                            <div class="selector-item">
                                <label>íŒ€ ì„ íƒ:</label>
                                <select id="evaluationTeamSelect" onchange="loadTeamChannels()">
                                    <option value="">íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="team1">ìŠ¤íŠœë””ì˜¤ 1íŒ€</option>
                                    <option value="team2">ìŠ¤íŠœë””ì˜¤ 2íŒ€</option>
                                    <option value="team3">ìŠ¤íŠœë””ì˜¤ 3íŒ€</option>
                                    <option value="team4">ìŠ¤íŠœë””ì˜¤ 4íŒ€</option>
                                    <option value="team5">ìŠ¤íŠœë””ì˜¤ 5íŒ€</option>
                                    <option value="team6">ì´¬ì˜íŒ€</option>
                                </select>
                            </div>
                        </div>
                       <!-- ì´ì „ ë‹¬ ë³µì‚¬ ë²„íŠ¼ì„ ë³„ë„ ì„¹ì…˜ìœ¼ë¡œ ë¶„ë¦¬ -->
                          <div style="margin: 20px 0; padding: 15px; background: #212121; border-radius: 8px; border: 1px solid #3f3f3f;">
                              <button class="btn btn-warning" onclick="copyFromPreviousMonth()" style="display: flex; align-items: center; gap: 10px;">
                                  <span style="font-size: 20px;">ğŸ“‹</span>
                                  <span>ì´ì „ ë‹¬ ë°ì´í„° ë³µì‚¬</span>
                              </button>
                              <p style="color: #aaa; font-size: 12px; margin-top: 10px; margin-bottom: 0;">
                                  ğŸ’¡ ì´ì „ ë‹¬ì˜ MM, ê¸°ì—¬ë„, ì„±ê³¼, ì½”ë©˜íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.
                              </p>
                          </div>
                          
                          <div id="teamChannelsArea" style="display: none;">
                              <h3>ğŸ“º í‰ê°€í•  ì±„ë„ ì„ íƒ</h3>
                              <div id="channelCheckboxArea" class="channel-checkbox-area"></div>
                              <button class="btn btn-primary" style="margin: 20px 0;" onclick="loadSelectedChannels()">ğŸ¯ ì„ íƒí•œ ì±„ë„ í‰ê°€í•˜ê¸°</button>
                          </div>
                      </div>
                    <button class="btn btn-primary" onclick="sortChannelsByMM()" style="margin-bottom: 20px;">ğŸ“Š ì±„ë„ MM í•©ê³„ìˆœ ì •ë ¬</button>
                </div>
                
                <div id="channelEvaluationsArea"></div>
                
                <button class="submit-btn" id="submitFirstEvalBtn" style="display: none;" onclick="submitFirstEvaluation()">âœ¨ 1ì°¨ í‰ê°€ ìµœì¢… ì œì¶œ</button>
            </div>
            
                        <!-- 2ì°¨ í‰ê°€ (ê´€ë¦¬ì) í™”ë©´ -->
            <? if (userInfo.level >= 2) { ?>
            <div id="managerContent" class="role-content">
                <h2>ğŸ”„ 2ì°¨ í‰ê°€ - í‰ê°€ ì¡°ì •</h2>
                
                <div class="selector-group">
                    <div class="selector-item">
                        <label>í‰ê°€ì›”:</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="evalYear2nd" onchange="updateEvalMonth2nd()">
                                <option value="2024">2024ë…„</option>
                                <option value="2025">2025ë…„</option>
                                <option value="2026">2026ë…„</option>
                                <option value="2027">2027ë…„</option>
                            </select>
                            <select id="evalMonthSelect2nd" onchange="updateEvalMonth2nd()">
                                <option value="01">1ì›”</option>
                                <option value="02">2ì›”</option>
                                <option value="03">3ì›”</option>
                                <option value="04">4ì›”</option>
                                <option value="05">5ì›”</option>
                                <option value="06">6ì›”</option>
                                <option value="07">7ì›”</option>
                                <option value="08">8ì›”</option>
                                <option value="09">9ì›”</option>
                                <option value="10">10ì›”</option>
                                <option value="11">11ì›”</option>
                                <option value="12">12ì›”</option>
                            </select>
                        </div>
                        <input type="hidden" id="evalMonth2nd">
                    </div>
                </div>
                
                <!-- íŒ€ í•„í„°ë¥¼ ë¨¼ì € í‘œì‹œ -->
               <div class="team-filter-section" style="margin: 20px 0; background: #212121; padding: 20px; border-radius: 8px;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                          <h4>ğŸ” í‰ê°€í•  íŒ€ ì„ íƒ</h4>
                          <button class="btn btn-primary btn-sm" onclick="toggleAllTeams(this)">
                              âœ… ì „ì²´ ì„ íƒ
                          </button>
                      </div>
                      <div class="team-checkbox-area">
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team1"> ìŠ¤íŠœë””ì˜¤ 1íŒ€
                        </label>
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team2"> ìŠ¤íŠœë””ì˜¤ 2íŒ€
                        </label>
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team3"> ìŠ¤íŠœë””ì˜¤ 3íŒ€
                        </label>
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team4"> ìŠ¤íŠœë””ì˜¤ 4íŒ€
                        </label>
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team5"> ìŠ¤íŠœë””ì˜¤ 5íŒ€
                        </label>
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team6"> ì´¬ì˜íŒ€
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="loadSecondEvaluation()" style="margin-top: 15px;">ğŸ“¥ ì„ íƒí•œ íŒ€ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
                
                <button class="btn btn-primary" onclick="sortChannelsByMM()" style="margin-bottom: 20px; display: none;" id="sortChannelsBtn2nd">ğŸ“Š ì±„ë„ MM í•©ê³„ìˆœ ì •ë ¬</button>
                
                <div id="secondEvaluationArea"></div>
                <button class="submit-btn" id="submitSecondEvalBtn" style="display: none;" onclick="submitSecondEvaluationSelective()">âœ¨ í‘œì‹œëœ íŒ€ë§Œ 2ì°¨ í‰ê°€ ì €ì¥</button>
            </div>
            <? } ?>
            
                        <!-- ìµœì¢… í‰ê°€ (ìµœì¢…ê´€ë¦¬ì) í™”ë©´ -->
            <? if (userInfo.level >= 3) { ?>
            <div id="executiveContent" class="role-content">
                <h2>âœ… ìµœì¢… í‰ê°€ - ì„±ê³¼ê¸ˆ ì±…ì •</h2>
                
                <!-- í‰ê°€ ì§„í–‰ ìƒíƒœ í‘œì‹œ -->
                <div id="evaluationStatusSection" class="evaluation-status-section">
                    <h3>ğŸ“Š í˜„ì¬ í‰ê°€ ì§„í–‰ ìƒíƒœ</h3>
                    <div id="evaluationStatusGrid" class="evaluation-status-grid"></div>
                </div>
                
                <div class="selector-group">
                    <div class="selector-item">
                        <label>í‰ê°€ì›”:</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="evalYearFinal" onchange="updateEvalMonthFinal()">
                                <option value="2024">2024ë…„</option>
                                <option value="2025">2025ë…„</option>
                                <option value="2026">2026ë…„</option>
                                <option value="2027">2027ë…„</option>
                            </select>
                            <select id="evalMonthSelectFinal" onchange="updateEvalMonthFinal()">
                                <option value="01">1ì›”</option>
                                <option value="02">2ì›”</option>
                                <option value="03">3ì›”</option>
                                <option value="04">4ì›”</option>
                                <option value="05">5ì›”</option>
                                <option value="06">6ì›”</option>
                                <option value="07">7ì›”</option>
                                <option value="08">8ì›”</option>
                                <option value="09">9ì›”</option>
                                <option value="10">10ì›”</option>
                                <option value="11">11ì›”</option>
                                <option value="12">12ì›”</option>
                            </select>
                        </div>
                        <input type="hidden" id="evalMonthFinal">
                    </div>
                </div>
                
                <!-- íŒ€ í•„í„°ë¥¼ ë¨¼ì € í‘œì‹œ -->
                <div class="team-filter-section" style="margin: 20px 0; background: #212121; padding: 20px; border-radius: 8px;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                          <h4>ğŸ” í‰ê°€í•  íŒ€ ì„ íƒ</h4>
                          <button class="btn btn-primary btn-sm" onclick="toggleAllTeams(this)">
                              âœ… ì „ì²´ ì„ íƒ
                          </button>
                      </div>
                      <div class="team-checkbox-area">
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team1"> ìŠ¤íŠœë””ì˜¤ 1íŒ€
                        </label>
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team2"> ìŠ¤íŠœë””ì˜¤ 2íŒ€
                        </label>
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team3"> ìŠ¤íŠœë””ì˜¤ 3íŒ€
                        </label>
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team4"> ìŠ¤íŠœë””ì˜¤ 4íŒ€
                        </label>
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team5"> ìŠ¤íŠœë””ì˜¤ 5íŒ€
                        </label>
                        <label class="team-checkbox-item">
                            <input type="checkbox" value="team6"> ì´¬ì˜íŒ€
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="loadFinalEvaluation()" style="margin-top: 15px;">ğŸ“¥ ì„ íƒí•œ íŒ€ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
                
                <button class="btn btn-primary" onclick="sortChannelsByMM()" style="margin-bottom: 20px; display: none;" id="sortChannelsBtnFinal">ğŸ“Š ì±„ë„ MM í•©ê³„ìˆœ ì •ë ¬</button>
                
                <div id="finalEvaluationArea"></div>
                <button class="submit-btn" id="submitFinalEvalBtn" style="display: none;" onclick="submitFinalEvaluationSelective()">ğŸ‰ í‘œì‹œëœ íŒ€ë§Œ í‰ê°€ ìµœì¢… í™•ì •</button>
            </div>
            <? } ?>
            
            <!-- ëŒ€ì‹œë³´ë“œ í™”ë©´ (ì´ì „ ì „ì›” ë¹„êµ) -->
            <? if (userInfo.level >= 3) { ?>
            <div id="dashboardContent" class="role-content">
                <h2>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
                
                <div class="comparison-tabs">
                    <button class="comparison-tab active" data-type="comparison" onclick="switchDashboardTab('comparison')">ğŸ“ˆ ì „ì›” ë¹„êµ</button>
                    <button class="comparison-tab" data-type="individual" onclick="switchDashboardTab('individual')">ğŸ‘¤ ì¸ì›ë³„ ë¶„ì„</button>
                    <button class="comparison-tab" data-type="trend" onclick="switchDashboardTab('trend')">ğŸ“Š íŠ¸ë Œë“œ ë¶„ì„</button>
                    <button class="comparison-tab" data-type="monthly" onclick="switchDashboardTab('monthly')">ğŸ’° ì›”ë³„ ì„±ê³¼ê¸ˆ</button>
                </div>
                
                <!-- ì „ì›” ë¹„êµ ì„¹ì…˜ -->
                <div id="comparisonSection" class="dashboard-section active">
                    <div class="selector-group">
                        <div class="selector-item">
                            <label>ë¹„êµ ê¸°ì¤€ì›”:</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="compareYear1" onchange="updateCompareMonth1()">
                                    <option value="2024">2024ë…„</option>
                                    <option value="2025">2025ë…„</option>
                                    <option value="2026">2026ë…„</option>
                                </select>
                                <select id="compareMonth1Select" onchange="updateCompareMonth1()">
                                    <option value="01">1ì›”</option>
                                    <option value="02">2ì›”</option>
                                    <option value="03">3ì›”</option>
                                    <option value="04">4ì›”</option>
                                    <option value="05">5ì›”</option>
                                    <option value="06">6ì›”</option>
                                    <option value="07">7ì›”</option>
                                    <option value="08">8ì›”</option>
                                    <option value="09">9ì›”</option>
                                    <option value="10">10ì›”</option>
                                    <option value="11">11ì›”</option>
                                    <option value="12">12ì›”</option>
                                </select>
                            </div>
                        </div>
                        <div class="selector-item">
                            <label>ë¹„êµ ëŒ€ìƒì›”:</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="compareYear2" onchange="updateCompareMonth2()">
                                    <option value="2024">2024ë…„</option>
                                    <option value="2025">2025ë…„</option>
                                    <option value="2026">2026ë…„</option>
                                </select>
                                <select id="compareMonth2Select" onchange="updateCompareMonth2()">
                                    <option value="01">1ì›”</option>
                                    <option value="02">2ì›”</option>
                                    <option value="03">3ì›”</option>
                                    <option value="04">4ì›”</option>
                                    <option value="05">5ì›”</option>
                                    <option value="06">6ì›”</option>
                                    <option value="07">7ì›”</option>
                                    <option value="08">8ì›”</option>
                                    <option value="09">9ì›”</option>
                                    <option value="10">10ì›”</option>
                                    <option value="11">11ì›”</option>
                                    <option value="12">12ì›”</option>
                                </select>
                            </div>
                        </div>
                                            <!-- íŒ€ ì„ íƒ ì¶”ê°€ -->
                            <div class="selector-item">
                                <label>íŒ€ ì„ íƒ:</label>
                                <select id="compareTeamSelect">
                                    <option value="">ì „ì²´ íŒ€</option>
                                    <option value="team1">ìŠ¤íŠœë””ì˜¤ 1íŒ€</option>
                                    <option value="team2">ìŠ¤íŠœë””ì˜¤ 2íŒ€</option>
                                    <option value="team3">ìŠ¤íŠœë””ì˜¤ 3íŒ€</option>
                                    <option value="team4">ìŠ¤íŠœë””ì˜¤ 4íŒ€</option>
                                    <option value="team5">ìŠ¤íŠœë””ì˜¤ 5íŒ€</option>
                                    <option value="team6">ì´¬ì˜íŒ€</option>
                                </select>
                            </div>

                        <button class="btn btn-primary" onclick="loadComparisonData()">ğŸ” ë¹„êµ ë¶„ì„ ì‹¤í–‰</button>
                    </div>
                    <div id="comparisonArea"></div>
                </div>
                
                <!-- ì¸ì›ë³„ ë¶„ì„ ì„¹ì…˜ -->
                <div id="individualAnalysisSection" class="dashboard-section">
                    <div class="selector-group">
                        <div class="selector-item">
                            <label>íŒ€ ì„ íƒ:</label>
                            <select id="analysisTeamSelect" onchange="loadTeamMembersForAnalysis()">
                                <option value="">íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="team1">ìŠ¤íŠœë””ì˜¤ 1íŒ€</option>
                                <option value="team2">ìŠ¤íŠœë””ì˜¤ 2íŒ€</option>
                                <option value="team3">ìŠ¤íŠœë””ì˜¤ 3íŒ€</option>
                                <option value="team4">ìŠ¤íŠœë””ì˜¤ 4íŒ€</option>
                                <option value="team5">ìŠ¤íŠœë””ì˜¤ 5íŒ€</option>
                                <option value="team6">ì´¬ì˜íŒ€</option>
                            </select>
                        </div>
                        <div class="selector-item">
                            <label>íŒ€ì› ì„ íƒ:</label>
                            <select id="analysisMemberSelect">
                                <option value="">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="loadIndividualAnalysis()">ğŸ“ˆ ë¶„ì„ ì‹¤í–‰</button>
                    </div>
                    <div id="individualAnalysisArea"></div>
                </div>
                
                <!-- íŠ¸ë Œë“œ ë¶„ì„ ì„¹ì…˜ -->
                <div id="trendAnalysisSection" class="dashboard-section">
                    <div class="selector-group">
                        <div class="selector-item">
                            <label>ë¶„ì„ ìœ í˜•:</label>
                            <select id="trendType" onchange="updateTrendOptions()">
                                <option value="team">íŒ€ë³„ íŠ¸ë Œë“œ</option>
                                <option value="channel">ì±„ë„ë³„ íŠ¸ë Œë“œ</option>
                            </select>
                        </div>
                        <div class="selector-item">
                            <label>ë¶„ì„ ëŒ€ìƒ:</label>
                            <select id="trendTarget">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                        <div class="selector-item">
                            <label>ë¶„ì„ ê¸°ê°„:</label>
                            <select id="trendPeriod">
                                <option value="3">ìµœê·¼ 3ê°œì›”</option>
                                <option value="6">ìµœê·¼ 6ê°œì›”</option>
                                <option value="12">ìµœê·¼ 1ë…„</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="loadTrendAnalysis()">ğŸ“Š íŠ¸ë Œë“œ ë¶„ì„</button>
                    </div>
                    <div id="trendChartArea">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                   <!-- ì›”ë³„ ì„±ê³¼ê¸ˆ ì„¹ì…˜ ì¶”ê°€ -->
                      <div id="monthlyPaymentSection" class="dashboard-section">
                          <div class="selector-group">
                              <div class="selector-item">
                                  <label>ì—°ë„:</label>
                                  <select id="paymentYear">
                                      <option value="2025">2025ë…„</option>
                                      <option value="2026">2026ë…„</option>
                                  </select>
                              </div>
                              <div class="selector-item">
                                  <label>ì›”:</label>
                                  <select id="paymentMonth">
                                      <option value="01">1ì›”</option>
                                      <option value="02">2ì›”</option>
                                      <option value="03">3ì›”</option>
                                      <option value="04">4ì›”</option>
                                      <option value="05">5ì›”</option>
                                      <option value="06">6ì›”</option>
                                      <option value="07">7ì›”</option>
                                      <option value="08">8ì›”</option>
                                      <option value="09">9ì›”</option>
                                      <option value="10">10ì›”</option>
                                      <option value="11">11ì›”</option>
                                      <option value="12">12ì›”</option>
                                  </select>
                              </div>
                              <div class="selector-item">
                                  <label>íŒ€ ì„ íƒ:</label>
                                  <select id="paymentTeam">
                                      <option value="">íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                      <option value="team1">ìŠ¤íŠœë””ì˜¤ 1íŒ€</option>
                                      <option value="team2">ìŠ¤íŠœë””ì˜¤ 2íŒ€</option>
                                      <option value="team3">ìŠ¤íŠœë””ì˜¤ 3íŒ€</option>
                                      <option value="team4">ìŠ¤íŠœë””ì˜¤ 4íŒ€</option>
                                      <option value="team5">ìŠ¤íŠœë””ì˜¤ 5íŒ€</option>
                                      <option value="team6">ì´¬ì˜íŒ€</option>
                                  </select>
                              </div>
                              <button class="btn btn-primary" onclick="loadMonthlyPayment()">ğŸ’° ì¡°íšŒ</button>
                          </div>
                          <div id="monthlyPaymentArea"></div>
                  </div>
            <? } ?>
            
            <!-- ê¶Œí•œ ê´€ë¦¬ í™”ë©´ -->
            <? if (parseInt(userInfo.level) >= 3 || userInfo.level == 3 || userInfo.level === "3") { ?>
            <div id="permissionContent" class="role-content">
                <h2>âš™ï¸ ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬</h2>
                
                <div class="management-section">
                    <h3>â• ìƒˆ ì‚¬ìš©ì ì¶”ê°€</h3>
                    <div class="management-grid" style="grid-template-columns: 1fr;">
                        <div class="management-card">
                            <div class="form-group">
                                <label>ì´ë©”ì¼ (@awesomeent.kr)</label>
                                <input type="email" id="newUserEmail" placeholder="user@awesomeent.kr">
                            </div>
                            <div class="form-group">
                                <label>ì´ë¦„</label>
                                <input type="text" id="newUserName" placeholder="í™ê¸¸ë™">
                            </div>
                            <div class="form-group">
                                <label>ë¶€ì„œ</label>
                                <input type="text" id="newUserDept" placeholder="ìŠ¤íŠœë””ì˜¤ 1íŒ€">
                            </div>
                            <div class="form-group">
                                <label>ê¶Œí•œ ë ˆë²¨</label>
                                <select id="newUserLevel">
                                    <option value="1">1 - 1ì°¨ í‰ê°€ë§Œ</option>
                                    <option value="2">2 - 1ì°¨/2ì°¨ í‰ê°€</option>
                                    <option value="3">3 - ì „ì²´ ê¶Œí•œ</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="addNewUser()">â• ì‚¬ìš©ì ì¶”ê°€</button>
                        </div>
                    </div>
                </div>
                
                <div class="management-section">
                    <h3>ğŸ‘¥ ì‚¬ìš©ì ê¶Œí•œ ëª©ë¡</h3>
                    <div id="permissionsList" class="permissions-list"></div>
                </div>
                
                <div class="management-section">
                    <h3>ğŸ“‹ ì•¡ì…˜ ë¡œê·¸</h3>
                    <button class="btn btn-primary" onclick="loadActionLogs()" style="margin-bottom: 15px;">ğŸ”„ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨</button>
                    <div id="actionLogsList" class="action-logs-list"></div>
                </div>
            </div>
            <? } ?>
        </div>
    </div>
    
    <!-- JavaScript í¬í•¨ -->
    <?!= include('utils'); ?>
    <?!= include('management'); ?>
    <?!= include('evaluation'); ?>
    
    <script>
        // ===== ì‚¬ìš©ì ì •ë³´ ì „ì—­ ë³€ìˆ˜ =====
        const currentUser = {
            email: '<?= userEmail ?>',
            name: '<?= userInfo.name ?>',
            department: '<?= userInfo.department ?>',
            level: <?= userInfo.level ?>,
            teamId: '<?= userInfo.teamId || '' ?>',
            teamleadId: '<?= userInfo.teamleadId || '' ?>'
        };
        
        // ===== ê°œì„ ëœ ì•Œë¦¼ ì‹œìŠ¤í…œ (ì ‘ê·¼ì„± + ì‚¬ìš©ì ì¹œí™”ì ) =====
        function showNotification(message, type = 'info', duration = 5000) {
            const popup = document.getElementById('notificationPopup');
            const content = document.getElementById('notificationContent');
            
            // ê¸°ì¡´ íƒ€ì´ë¨¸ ì œê±°
            if (window.notificationTimer) {
                clearTimeout(window.notificationTimer);
            }
            
            // ì ‘ê·¼ì„± ì†ì„± ì¶”ê°€
            popup.setAttribute('role', 'alert');
            popup.setAttribute('aria-live', 'polite');
            
            // ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ êµ¬ì„±
            let iconAndTitle;
            switch (type) {
                case 'success':
                    iconAndTitle = '<strong style="color: #27ae60;">âœ… ì„±ê³µ!</strong>';
                    duration = 3000; // ì„±ê³µ ë©”ì‹œì§€ëŠ” ì§§ê²Œ
                    break;
                case 'error':
                    iconAndTitle = '<strong style="color: #e74c3c;">âŒ ì˜¤ë¥˜ ë°œìƒ</strong>';
                    duration = 8000; // ì˜¤ë¥˜ëŠ” ê¸¸ê²Œ í‘œì‹œ
                    break;
                case 'warning':
                    iconAndTitle = '<strong style="color: #f39c12;">âš ï¸ ì£¼ì˜</strong>';
                    duration = 6000;
                    break;
                default:
                    iconAndTitle = '<strong style="color: #3498db;">â„¹ï¸ ì•Œë¦¼</strong>';
                    duration = 5000;
            }
            
            content.innerHTML = `
                <div style="margin-bottom: 8px;">${iconAndTitle}</div>
                <div style="font-size: 14px; line-height: 1.4; opacity: 0.9;">${message}</div>
                ${type === 'error' ? '<small style="opacity: 0.7; margin-top: 8px; display: block;">í´ë¦­í•˜ì—¬ ë‹«ê¸°</small>' : ''}
            `;
            
            popup.className = `notification-popup show ${type}`;
            
            // ì—ëŸ¬ëŠ” í´ë¦­ìœ¼ë¡œë„ ë‹«ì„ ìˆ˜ ìˆê²Œ
            if (type === 'error') {
                popup.style.cursor = 'pointer';
                popup.onclick = closeNotification;
            } else {
                popup.style.cursor = 'default';
                popup.onclick = null;
            }
            
            // ìë™ ë‹«ê¸° íƒ€ì´ë¨¸
            window.notificationTimer = setTimeout(() => {
                closeNotification();
            }, duration);
        }
        
        function closeNotification() {
            const popup = document.getElementById('notificationPopup');
            popup.classList.remove('show');
        }
        
        // ===== ëŒ€ì‹œë³´ë“œ íƒ­ ì „í™˜ =====
        function switchDashboardTab(type) {
            document.querySelectorAll('.comparison-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.type === type) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });
            
            if (type === 'comparison') {
                document.getElementById('comparisonSection').classList.add('active');
            } else if (type === 'monthly') {
                document.getElementById('monthlyPaymentSection').classList.add('active');
            }
              else if (type === 'individual') {
                document.getElementById('individualAnalysisSection').classList.add('active');
            } else if (type === 'trend') {
                document.getElementById('trendAnalysisSection').classList.add('active');
                updateTrendOptions();
            }
        }
        
        // ===== í‰ê°€ì›” ì—…ë°ì´íŠ¸ í•¨ìˆ˜ =====
        function updateEvalMonth() {
            const year = document.getElementById('evalYear').value;
            const month = document.getElementById('evalMonthSelect').value;
            document.getElementById('evalMonth').value = `${year}-${month}`;
            
            if (document.getElementById('teamleadSelect').value) {
                checkExistingEvaluation();
            }
        }
        
        function updateEvalMonth2nd() {
            const year = document.getElementById('evalYear2nd').value;
            const month = document.getElementById('evalMonthSelect2nd').value;
            document.getElementById('evalMonth2nd').value = `${year}-${month}`;
        }
        
        function updateEvalMonthFinal() {
            const year = document.getElementById('evalYearFinal').value;
            const month = document.getElementById('evalMonthSelectFinal').value;
            document.getElementById('evalMonthFinal').value = `${year}-${month}`;
            
            // í‰ê°€ ìƒíƒœ ìë™ ë¡œë“œ
            loadEvaluationStatus();
        }
        
        function updateCompareMonth1() {
            const year = document.getElementById('compareYear1').value;
            const month = document.getElementById('compareMonth1Select').value;
            // ê°’ ì €ì¥
            window.compareMonth1 = `${year}-${month}`;
        }
        
        function updateCompareMonth2() {
            const year = document.getElementById('compareYear2').value;
            const month = document.getElementById('compareMonth2Select').value;
            // ê°’ ì €ì¥
            window.compareMonth2 = `${year}-${month}`;
        }
        
        // ===== í‰ê°€ ìƒíƒœ ë¡œë“œ (ì¤‘ë³µ ì œê±°ë¨ - utils.html.txtì—ì„œ ì²˜ë¦¬) =====
        // loadEvaluationStatusëŠ” utils.html.txtì— ì •ì˜ë˜ì–´ ìˆìŒ
        
        // ===== í‰ê°€ ìƒíƒœ í‘œì‹œ =====
        function displayEvaluationStatus(statusData) {
            const grid = document.getElementById('evaluationStatusGrid');
            let html = '';
            
            for (const teamId in statusData) {
                const team = statusData[teamId];
                const statusClass = team.stage === 'ìµœì¢…ì™„ë£Œ' ? 'status-complete' : 
                                   team.stage === '2ì°¨ì™„ë£Œ' ? 'status-second' : 
                                   team.stage === '1ì°¨ì™„ë£Œ' ? 'status-first' : 'status-pending';
                
                html += `
                    <div class="status-card ${statusClass}">
                        <h4>${team.name}</h4>
                        <div class="status-stage">${team.stage || 'ë¯¸ì§„í–‰'}</div>
                        <div class="status-details">
                            <span>ì±„ë„: ${team.channelCount}ê°œ</span>
                            <span>íŒ€ì›: ${team.memberCount}ëª…</span>
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }
        
        // ===== íŒ€ì› ë¶„ì„ ë¡œë“œ =====
        function loadTeamMembersForAnalysis() {
            const teamId = document.getElementById('analysisTeamSelect').value;
            const memberSelect = document.getElementById('analysisMemberSelect');
            
            if (!teamId) {
                memberSelect.innerHTML = '<option value="">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                return;
            }
            
            const teamMembers = evaluationData.members.filter(m => m.teamId === teamId);
            memberSelect.innerHTML = '<option value="">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            
            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                memberSelect.appendChild(option);
            });
        }
        
        // ===== ê°œì¸ë³„ ë¶„ì„ ì‹¤í–‰ =====
        function loadIndividualAnalysis() {
            const memberId = document.getElementById('analysisMemberSelect').value;
            if (!memberId) {
                showAlert('ë¶„ì„í•  íŒ€ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(data) {
                    displayIndividualAnalysis(data);
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('ê°œì¸ ë¶„ì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
                    showLoading(false);
                })
                .getIndividualYearlyData(memberId);
        }
        
        // ===== ê°œì¸ë³„ ë¶„ì„ í‘œì‹œ =====
        function displayIndividualAnalysis(yearlyData) {
            const area = document.getElementById('individualAnalysisArea');
            const memberName = document.getElementById('analysisMemberSelect').selectedOptions[0].text;
            
            let html = `<h3>ğŸ“Š ${memberName}ë‹˜ì˜ ì—°ê°„ ì„±ê³¼ ë¶„ì„</h3>`;
            
            // ì—°ê°„ ìš”ì•½
            let totalAmount = 0;
            let monthCount = 0;
            const monthlyData = [];
            
            for (const month in yearlyData) {
                const data = yearlyData[month];
                if (data.finalAmount) {
                    totalAmount += data.finalAmount;
                    monthCount++;
                }
                monthlyData.push({
                    month: month,
                    amount: data.finalAmount || 0,
                    mm: data.mm || 0,
                    contribution: data.contribution2 || data.contribution1 || 0
                });
            }
            
            html += `
                <div class="summary-box">
                    <h4>ì—°ê°„ ìš”ì•½</h4>
                    <div class="summary-item">
                        <span class="summary-label">ì´ ì„±ê³¼ê¸ˆ:</span>
                        <span class="summary-value amount">${(totalAmount/10000).toFixed(1)}ë§Œì›</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">í‰ê·  ì›” ì„±ê³¼ê¸ˆ:</span>
                        <span class="summary-value amount">${monthCount > 0 ? (totalAmount/monthCount/10000).toFixed(1) : 0}ë§Œì›</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">í‰ê°€ ì™„ë£Œ ì›”:</span>
                        <span class="summary-value">${monthCount}ê°œì›”</span>
                    </div>
                </div>
            `;
            
            // ì›”ë³„ ìƒì„¸
            html += `
                <h4>ì›”ë³„ ìƒì„¸ ë‚´ì—­</h4>
                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th>í‰ê°€ì›”</th>
                            <th>ì±„ë„ëª…</th>
                            <th>íˆ¬ì… MM</th>
                            <th>ê¸°ì—¬ë„</th>
                            <th>ì„±ê³¼ê¸ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            monthlyData.sort((a, b) => a.month.localeCompare(b.month));
            
            monthlyData.forEach(data => {
                const monthData = yearlyData[data.month];
                html += `
                    <tr>
                        <td>${data.month}</td>
                        <td>${monthData.channelName || '-'}</td>
                        <td>${data.mm}</td>
                        <td>${data.contribution}%</td>
                        <td class="amount">${data.amount ? (data.amount/10000).toFixed(1) + 'ë§Œì›' : '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            // ì°¨íŠ¸ ì˜ì—­
            html += `
                <div style="margin-top: 30px;">
                    <canvas id="individualChart"></canvas>
                </div>
            `;
            
            area.innerHTML = html;
            
            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            setTimeout(() => {
                drawIndividualChart(monthlyData);
            }, 100);
        }
        
        // ===== ê°œì¸ë³„ ì°¨íŠ¸ ê·¸ë¦¬ê¸° =====
        function drawIndividualChart(monthlyData) {
            const ctx = document.getElementById('individualChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.map(d => d.month),
                    datasets: [{
                        label: 'ì›”ë³„ ì„±ê³¼ê¸ˆ (ë§Œì›)',
                        data: monthlyData.map(d => d.amount / 10000),
                        borderColor: '#1a73e8',
                        backgroundColor: 'rgba(26, 115, 232, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ì›”ë³„ ì„±ê³¼ê¸ˆ ì¶”ì´'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + 'ë§Œì›';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ===== íŠ¸ë Œë“œ ì˜µì…˜ ì—…ë°ì´íŠ¸ =====
        function updateTrendOptions() {
            const type = document.getElementById('trendType').value;
            const targetSelect = document.getElementById('trendTarget');
            
            targetSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            if (type === 'team') {
                for (const teamId in evaluationData.teams) {
                    const option = document.createElement('option');
                    option.value = teamId;
                    option.textContent = evaluationData.teams[teamId].name;
                    targetSelect.appendChild(option);
                }
            } else {
                evaluationData.channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.id;
                    option.textContent = channel.name;
                    targetSelect.appendChild(option);
                });
            }
        }
        
        // ===== íŠ¸ë Œë“œ ë¶„ì„ ë¡œë“œ =====
        function loadTrendAnalysis() {
            const type = document.getElementById('trendType').value;
            const target = document.getElementById('trendTarget').value;
            const period = document.getElementById('trendPeriod').value;
            
            if (!target) {
                showAlert('ë¶„ì„ ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(data) {
                    drawTrendChart(data, type);
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('íŠ¸ë Œë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
                    showLoading(false);
                })
                .getTrendData(type, target, period);
        }
        
        // ===== íŠ¸ë Œë“œ ì°¨íŠ¸ ê·¸ë¦¬ê¸° =====
        function drawTrendChart(data, type) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (window.trendChartInstance) {
                window.trendChartInstance.destroy();
            }
            
            window.trendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'ì´ ì„±ê³¼ê¸ˆ (ë§Œì›)',
                        data: data.amounts.map(a => a / 10000),
                        backgroundColor: 'rgba(26, 115, 232, 0.5)',
                        borderColor: '#1a73e8',
                        borderWidth: 1
                    }, {
                        label: 'í‰ê·  ê¸°ì—¬ë„ (%)',
                        data: data.contributions,
                        type: 'line',
                        yAxisID: 'y1',
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: type === 'team' ? 'íŒ€ë³„ ì„±ê³¼ íŠ¸ë Œë“œ' : 'ì±„ë„ë³„ ì„±ê³¼ íŠ¸ë Œë“œ'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                callback: function(value) {
                                    return value + 'ë§Œì›';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ===== ì´ˆê¸°í™” =====
        window.onload = function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì‹œì‘ - currentUser:', currentUser);
            
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadInitialData();
            
            // ê¶Œí•œì— ë”°ë¥¸ ì²« í™”ë©´ ì„¤ì •
            setTimeout(() => {
                if (currentUser.level >= 1) {
                    console.log('1ì°¨ í‰ê°€ í™”ë©´ìœ¼ë¡œ ì „í™˜');
                    switchRole('teamlead');
                    
                    if (currentUser.level === 1 && currentUser.teamId) {
                        setTimeout(() => {
                            const teamSelect = document.getElementById('evaluationTeamSelect');
                            if (teamSelect) {
                                for (let option of teamSelect.options) {
                                    if (option.value && option.value !== currentUser.teamId) {
                                        option.disabled = true;
                                        option.style.color = '#666';
                                    }
                                }
                                teamSelect.value = currentUser.teamId;
                                loadTeamChannels();
                            }
                        }, 50);
                    }
                } else {
                    document.querySelector('.role-btn').click();
                }
            }, 50);
            
            // í…Œë§ˆ ì´ˆê¸°í™”
            initializeTheme();
            
            // ì•Œë¦¼ í…ŒìŠ¤íŠ¸
            showNotification('ğŸ‰ ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!', 'success');
        };
        
        // ===== ê¶Œí•œ ê´€ë¦¬ í•¨ìˆ˜ë“¤ (ì¤‘ë³µ ì œê±°ë¨ - utils.html.txtì—ì„œ ì²˜ë¦¬) =====
        // loadPermissionsListëŠ” utils.html.txtì— ì •ì˜ë˜ì–´ ìˆìŒ
        // displayPermissionsListë§Œ ì—¬ê¸°ì„œ ì •ì˜ (DOM ìš”ì†Œê°€ ì´ íŒŒì¼ì— ìˆìŒ)
        
        // displayPermissionsList í•¨ìˆ˜ëŠ” utils.html.txtì— ì •ì˜ë˜ì–´ ìˆìŒ
        
        // ===== ì‹œíŠ¸ êµ¬ì¡° ë””ë²„ê¹… í•¨ìˆ˜ (ê°•í™”) =====
        function debugSheets() {
            console.log('ì‹œíŠ¸ êµ¬ì¡° ë””ë²„ê¹… ì‹œì‘...');
            showLoading(true, 'ì‹œíŠ¸ êµ¬ì¡° í™•ì¸ ì¤‘...');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('=== ğŸ” ì‹œíŠ¸ ë””ë²„ê¹… ê²°ê³¼ ===');
                    console.log('ğŸ“‹ ì‹œíŠ¸ ëª©ë¡:', result.sheets);
                    console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì:', result.userEmail);
                    console.log('ğŸ”‘ ì‚¬ìš©ì ì •ë³´:', JSON.stringify(result.userInfo, null, 2));
                    console.log('ğŸ“Š ê¶Œí•œ ì‹œíŠ¸ ì¡´ì¬:', result.hasPermissionSheet);
                    console.log('ğŸ” ì‚¬ìš©ì ì‹œíŠ¸ ë‚´ ì¡´ì¬:', result.userFoundInSheet);
                    
                    if (result.permissionData) {
                        console.log('ğŸ“„ ê¶Œí•œ ì‹œíŠ¸ ë°ì´í„° (ì²˜ìŒ 5í–‰):');
                        result.permissionData.forEach((row, index) => {
                            console.log(`  í–‰ ${index}:`, row);
                        });
                    }
                    
                    if (result.autoAdded) {
                        console.log('âœ… ì‚¬ìš©ì ìë™ ì¶”ê°€ë¨');
                    }
                    
                    if (result.error) {
                        console.error('âŒ ë””ë²„ê¹… ì˜¤ë¥˜:', result.error);
                        if (result.stack) {
                            console.error('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', result.stack);
                        }
                        showNotification('ë””ë²„ê¹… ì˜¤ë¥˜: ' + result.error, 'error');
                    } else {
                        // ê¶Œí•œê´€ë¦¬ ë¬¸ì œ ì§„ë‹¨
                        let diagnosis = '';
                        if (!result.hasPermissionSheet) {
                            diagnosis = 'âŒ ì‚¬ìš©ìê¶Œí•œ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤';
                        } else if (!result.userFoundInSheet && !result.autoAdded) {
                            diagnosis = 'âŒ ì‚¬ìš©ìê°€ ê¶Œí•œ ì‹œíŠ¸ì— ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';
                        } else if (!result.userInfo) {
                            diagnosis = 'âŒ getUserPermission í•¨ìˆ˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                        } else if (result.userInfo.level < 3) {
                            diagnosis = `âŒ ê¶Œí•œ ë ˆë²¨ ë¶€ì¡± (í˜„ì¬: ${result.userInfo.level}, í•„ìš”: 3)`;
                        } else {
                            diagnosis = 'âœ… ê¶Œí•œ ì‹œìŠ¤í…œ ì •ìƒ - ê¶Œí•œê´€ë¦¬ í˜ì´ì§€ê°€ ì‘ë™í•´ì•¼ í•©ë‹ˆë‹¤';
                        }
                        
                        console.log('ğŸ¥ ì§„ë‹¨ ê²°ê³¼:', diagnosis);
                        showNotification('ë””ë²„ê¹… ì™„ë£Œ: ' + diagnosis, 
                                       diagnosis.startsWith('âœ…') ? 'success' : 'warning');
                        
                        // ìë™ ì¶”ê°€ëœ ê²½ìš° ê¶Œí•œê´€ë¦¬ í˜ì´ì§€ ë‹¤ì‹œ ë¡œë“œ ì‹œë„
                        if (result.autoAdded) {
                            setTimeout(() => {
                                console.log('ê¶Œí•œê´€ë¦¬ í˜ì´ì§€ ë‹¤ì‹œ ë¡œë“œ ì‹œë„...');
                                if (document.getElementById('permissionContent')) {
                                    loadPermissionsList();
                                }
                            }, 2000);
                        }
                    }
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    console.error('âŒ ë””ë²„ê¹… ì‹¤íŒ¨:', error);
                    showNotification('ë””ë²„ê¹… ì‹¤íŒ¨: ' + error, 'error');
                    showLoading(false);
                })
                .debugSheetStructure();
        }
        
        function addNewUser() {
            const email = document.getElementById('newUserEmail').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const department = document.getElementById('newUserDept').value.trim();
            const level = document.getElementById('newUserLevel').value;
            
            if (!email || !name || !department) {
                showAlert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (!email.endsWith('@awesomeent.kr')) {
                showAlert('íšŒì‚¬ ì´ë©”ì¼(@awesomeent.kr)ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        showNotification(result.message, 'success');
                        document.getElementById('newUserEmail').value = '';
                        document.getElementById('newUserName').value = '';
                        document.getElementById('newUserDept').value = '';
                        document.getElementById('newUserLevel').value = '1';
                        loadPermissionsList();
                    } else {
                        showAlert(result.message, 'error');
                    }
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨: ' + error, 'error');
                    showLoading(false);
                })
                .addUserPermission({
                    email: email,
                    name: name,
                    department: department,
                    level: parseInt(level)
                });
        }
        
        function updateUserLevel(email, newLevel) {
            if (!confirm(`${email}ì˜ ê¶Œí•œì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                loadPermissionsList();
                return;
            }
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(result) {
                    showNotification(result.message, result.success ? 'success' : 'error');
                    loadPermissionsList();
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('ê¶Œí•œ ìˆ˜ì • ì‹¤íŒ¨: ' + error, 'error');
                    loadPermissionsList();
                    showLoading(false);
                })
                .updateUserPermission(email, parseInt(newLevel));
        }
        
        function toggleUserStatus(email) {
            const action = confirm(`${email}ì˜ ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!action) return;
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(result) {
                    showNotification(result.message, result.success ? 'success' : 'error');
                    loadPermissionsList();
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + error, 'error');
                    showLoading(false);
                })
                .toggleUserActive(email);
        }
        
        function loadActionLogs() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(logs) {
                    displayActionLogs(logs);
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showAlert('ì•¡ì…˜ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
                    showLoading(false);
                })
                .getActionLogs(50);
        }
        
        function displayActionLogs(logs) {
            const logsDiv = document.getElementById('actionLogsList');
            
            if (logs.length === 0) {
                logsDiv.innerHTML = '<p style="text-align: center; color: #aaa;">ì•¡ì…˜ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let html = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="evaluation-table">
                        <thead>
                            <tr>
                                <th>ì¼ì‹œ</th>
                                <th>ì‚¬ìš©ì</th>
                                <th>ì•¡ì…˜</th>
                                <th>ìƒì„¸ë‚´ìš©</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            logs.forEach(log => {
                html += `
                    <tr>
                        <td>${log.timestamp}</td>
                        <td>${log.user}</td>
                        <td>${log.action}</td>
                        <td>${log.details}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            logsDiv.innerHTML = html;
        }
    </script>

<!-- index.htmlì— ì¶”ê°€ -->
<div id="activitySidebar" class="activity-sidebar">
    <div class="sidebar-header">
        <h4>ğŸ“‹ ë‚´ ì‘ì—… ë‚´ì—­</h4>
        <button class="close-btn" onclick="toggleActivitySidebar()">Ã—</button>
    </div>
    <div class="sidebar-content">
        <div id="recentActivities"></div>
    </div>
    <div class="sidebar-footer">
    </div>
</div>

<style>
.activity-sidebar {
    position: fixed;
    right: -300px;
    top: 100px;
    width: 280px;
    height: calc(100vh - 120px);
    background: #1a1a1a;
    border: 1px solid #3f3f3f;
    border-radius: 12px 0 0 12px;
    box-shadow: -2px 0 10px rgba(0,0,0,0.5);
    transition: right 0.3s ease;
    z-index: 1000;
    display: block !important;
    overflow: hidden;
}

/* í”Œë¡œíŒ… ë²„íŠ¼ ì¶”ê°€ */
.activity-toggle-btn {
    position: fixed;
    right: 20px;
    top: 100px;
    width: 50px;
    height: 50px;
    background: #1a73e8;
    border-radius: 50%;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 999;
    transition: transform 0.3s;
}

.activity-toggle-btn:hover {
    transform: scale(1.1);
}

.activity-sidebar.show {
    right: 0;
}

.sidebar-header {
    padding: 15px;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sidebar-content {
    height: calc(100% - 120px);
    overflow-y: auto;
    padding: 15px;
}

.activity-item {
    padding: 10px;
    margin-bottom: 10px;
    background: #272727;
    border-radius: 8px;
    font-size: 14px;
}

.activity-time {
    color: #666;
    font-size: 12px;
}
</style>

    
</body>

    
    <!-- ì‘ì—… ë‚´ì—­ í”Œë¡œíŒ… ë²„íŠ¼ -->
    <button class="activity-toggle-btn" onclick="toggleActivitySidebar()" title="ì‘ì—… ë‚´ì—­">ğŸ“‹</button>
    
    <script>
        // ===== ì‘ì—…ë‚´ì—­ ì‚¬ì´ë“œë°” í† ê¸€ =====
        function toggleActivitySidebar() {
            const sidebar = document.getElementById('activitySidebar');
            const isVisible = sidebar.classList.contains('show');
            
            if (isVisible) {
                sidebar.classList.remove('show');
            } else {
                sidebar.classList.add('show');
                // ì‘ì—… ë‚´ì—­ ë¡œë“œ
                loadActivityHistory();
            }
        }
        
        // ===== ì‘ì—…ë‚´ì—­ ë¡œë“œ =====
        function loadActivityHistory() {
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í™œë™ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
            const stored = localStorage.getItem('activityHistory');
            if (stored) {
                activityHistory = JSON.parse(stored);
                updateActivitySidebar();
            } else {
                // ì„œë²„ì—ì„œ ì•¡ì…˜ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
                showLoading(true, 'ì‘ì—… ë‚´ì—­ ë¡œë“œ ì¤‘...');
                google.script.run
                    .withSuccessHandler(function(logs) {
                        displayActionLogs(logs);
                        showLoading(false);
                    })
                    .withFailureHandler(function(error) {
                        console.error('ì‘ì—… ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                        showNotification('ì‘ì—… ë‚´ì—­ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                        showLoading(false);
                    })
                    .getActionLogs();
            }
        }
        
        // ===== ì•¡ì…˜ ë¡œê·¸ í‘œì‹œ =====
        function displayActionLogs(logs) {
            const container = document.getElementById('recentActivities');
            let html = '';
            
            if (!logs || logs.length === 0) {
                html = '<p style="text-align: center; color: #666;">ì‘ì—… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                logs.slice(0, 20).forEach(log => {
                    html += `
                        <div class="activity-item">
                            <div><strong>${log.action}</strong></div>
                            <div>${log.details}</div>
                            <div class="activity-time">${log.timestamp}</div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }
    </script>

</html>
