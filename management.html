<script>
// ===== ê´€ë¦¬ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ =====
function filterManagementByTeam() {
    const selectedTeam = document.getElementById('managementTeamFilter').value;
    updateMemberList(selectedTeam);
    updateChannelList(selectedTeam);
}

function updateMemberList(teamFilter = '') {
    const listDiv = document.getElementById('memberList');
    if (!listDiv) return;
    
    listDiv.innerHTML = '';
    
    let filteredMembers;
    if (currentUser.level === 1 && currentUser.teamId) {
        filteredMembers = evaluationData.members.filter(m => m.teamId === currentUser.teamId);
    } else {
        filteredMembers = teamFilter 
            ? evaluationData.members.filter(m => m.teamId === teamFilter)
            : evaluationData.members;
    }
    
    filteredMembers.forEach(member => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
            <span>${member.name} (${evaluationData.teams[member.teamId].name})</span>
            <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteMember('${member.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
        `;
        listDiv.appendChild(item);
    });
}

function updateChannelList(teamFilter = '') {
    const listDiv = document.getElementById('channelList');
    if (!listDiv) return;
    
    listDiv.innerHTML = '';
    
    let filteredChannels;
    if (currentUser.level === 1 && currentUser.teamId) {
        filteredChannels = evaluationData.channels.filter(c => c.teamId === currentUser.teamId);
    } else {
        filteredChannels = teamFilter 
            ? evaluationData.channels.filter(c => c.teamId === teamFilter)
            : evaluationData.channels;
    }
    
    filteredChannels.forEach(channel => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
            <span>${channel.name} (${evaluationData.teams[channel.teamId].name})</span>
            <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteChannel('${channel.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
        `;
        listDiv.appendChild(item);
    });
}

function addNewMember() {
    const name = document.getElementById('newMemberName').value.trim();
    const teamId = document.getElementById('newMemberTeam').value;
    
    if (!name || !teamId) {
        showNotification('íŒ€ì› ì´ë¦„ê³¼ íŒ€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    if (currentUser.level === 1 && currentUser.teamId && teamId !== currentUser.teamId) {
        showNotification('ìì‹ ì˜ íŒ€ì—ë§Œ íŒ€ì›ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification(result.message, 'success');
                document.getElementById('newMemberName').value = '';
                document.getElementById('newMemberTeam').value = '';
                loadInitialData();
            } else {
                showNotification(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('íŒ€ì› ì¶”ê°€ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .addMember({ name: name, teamId: teamId });
}

function deleteMember(memberId) {
    if (currentUser.level === 1 && currentUser.teamId) {
        const member = evaluationData.members.find(m => m.id === memberId);
        if (member && member.teamId !== currentUser.teamId) {
            showNotification('ìì‹ ì˜ íŒ€ ë©¤ë²„ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
            return;
        }
    }
    
    if (!confirm('ì •ë§ë¡œ ì´ íŒ€ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification(result.message, 'success');
                loadInitialData();
            } else {
                showNotification(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('íŒ€ì› ì‚­ì œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .deleteMember(memberId);
}

function addNewChannel() {
    const name = document.getElementById('newChannelName').value.trim();
    const teamId = document.getElementById('newChannelTeam').value;
    
    if (!name || !teamId) {
        showNotification('ì±„ë„ëª…ê³¼ íŒ€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    if (currentUser.level === 1 && currentUser.teamId && teamId !== currentUser.teamId) {
        showNotification('ìì‹ ì˜ íŒ€ì—ë§Œ ì±„ë„ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification(result.message, 'success');
                document.getElementById('newChannelName').value = '';
                document.getElementById('newChannelTeam').value = '';
                loadInitialData();
            } else {
                showNotification(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì±„ë„ ì¶”ê°€ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .addChannel({ name: name, teamId: teamId });
}

function deleteChannel(channelId) {
    if (currentUser.level === 1 && currentUser.teamId) {
        const channel = evaluationData.channels.find(c => c.id === channelId);
        if (channel && channel.teamId !== currentUser.teamId) {
            showNotification('ìì‹ ì˜ íŒ€ ì±„ë„ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
            return;
        }
    }
    
    if (!confirm('ì •ë§ë¡œ ì´ ì±„ë„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification(result.message, 'success');
                loadInitialData();
            } else {
                showNotification(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì±„ë„ ì‚­ì œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .deleteChannel(channelId);
}

function loadChannelMembersForAssignment() {
    const channelId = document.getElementById('channelForMemberAssignment').value;
    const assignmentArea = document.getElementById('channelMemberAssignmentArea');
    
    if (!channelId) {
        assignmentArea.style.display = 'none';
        return;
    }
    
    if (currentUser.level === 1 && currentUser.teamId) {
        const channel = evaluationData.channels.find(c => c.id === channelId);
        if (channel && channel.teamId !== currentUser.teamId) {
            showNotification('ìì‹ ì˜ íŒ€ ì±„ë„ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
            assignmentArea.style.display = 'none';
            return;
        }
    }
    
    assignmentArea.style.display = 'block';
    showLoading(true);
    
    google.script.run
        .withSuccessHandler(function(channelMembers) {
            const channelMemberIds = channelMembers.map(m => m.id);
            evaluationData.currentChannelMembers = channelMemberIds;
            filterAssignmentMembers();
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì±„ë„ ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getChannelMembersData(channelId);
}

function filterAssignmentMembers() {
    const teamFilter = document.getElementById('memberAssignmentTeamFilter').value;
    const checkboxList = document.getElementById('memberCheckboxList');
    checkboxList.innerHTML = '';
    
    let filteredMembers;
    if (currentUser.level === 1 && currentUser.teamId) {
        filteredMembers = evaluationData.members.filter(m => m.teamId === currentUser.teamId);
    } else {
        filteredMembers = teamFilter 
            ? evaluationData.members.filter(m => m.teamId === teamFilter)
            : evaluationData.members;
    }
    
    filteredMembers.forEach(member => {
        const item = document.createElement('div');
        item.className = 'member-checkbox-item';
        
        const isChecked = evaluationData.currentChannelMembers.includes(member.id);
        
        item.innerHTML = `
            <input type="checkbox" id="member_cb_${member.id}" value="${member.id}" ${isChecked ? 'checked' : ''}>
            <label for="member_cb_${member.id}">
                <span>${member.name}</span>
                <span class="member-team-badge">${evaluationData.teams[member.teamId].name}</span>
            </label>
        `;
        
        checkboxList.appendChild(item);
    });
}

function saveChannelMembers() {
    const channelId = document.getElementById('channelForMemberAssignment').value;
    if (!channelId) {
        showNotification('ì±„ë„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const selectedMemberIds = [];
    document.querySelectorAll('#memberCheckboxList input[type="checkbox"]:checked').forEach(checkbox => {
        selectedMemberIds.push(checkbox.value);
    });
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                showNotification(result.message, 'success');
            } else {
                showNotification(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('ì €ì¥ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .updateChannelMembers(channelId, selectedMemberIds);
}

// ===== ì±„ë„ë³„ íŒ€ì› ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
function toggleMemberManagement(channelId) {
    const managementSection = document.getElementById(`memberManagement_${channelId}`);
    const toggleButton = document.getElementById(`memberToggle_${channelId}`);
    
    if (managementSection.style.display === 'none') {
        managementSection.style.display = 'block';
        toggleButton.textContent = 'ğŸ‘¥ íŒ€ì› ê´€ë¦¬ ë‹«ê¸°';
        setTimeout(() => {
            forceDarkModeForChannel(channelId);
        }, 20);
    } else {
        managementSection.style.display = 'none';
        toggleButton.textContent = 'ğŸ‘¥ íŒ€ì› ê´€ë¦¬';
    }
}

function loadTeamMembers(channelId) {
    const teamId = document.getElementById(`teamSelect_${channelId}`).value;
    const memberSelect = document.getElementById(`memberSelect_${channelId}`);
    
    if (!teamId) {
        memberSelect.innerHTML = '<option value="" style="background-color: #0f0f0f; color: #f1f1f1;">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        return;
    }
    
    const existingMemberIds = evaluationData.currentChannels[channelId] ? 
        evaluationData.currentChannels[channelId].map(m => m.id) : [];
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(teamMembers) {
            memberSelect.innerHTML = '<option value="" style="background-color: #0f0f0f; color: #f1f1f1;">íŒ€ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            
            teamMembers.forEach(member => {
                if (!existingMemberIds.includes(member.id)) {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    option.dataset.teamName = evaluationData.teams[member.teamId].name;
                    option.style.backgroundColor = '#0f0f0f';
                    option.style.color = '#f1f1f1';
                    memberSelect.appendChild(option);
                }
            });
            
            memberSelect.style.backgroundColor = '#0f0f0f';
            memberSelect.style.color = '#f1f1f1';
            memberSelect.style.border = '1px solid #3f3f3f';
            
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('íŒ€ì› ë¡œë“œ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .getTeamMembersData(teamId);
}

function addMemberToChannelEval(channelId) {
    const memberSelect = document.getElementById(`memberSelect_${channelId}`);
    const selectedOption = memberSelect.selectedOptions[0];
    
    if (!selectedOption || !selectedOption.value) {
        showNotification('ì¶”ê°€í•  íŒ€ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const memberId = selectedOption.value;
    const memberName = selectedOption.textContent;
    const teamName = selectedOption.dataset.teamName;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                const tbody = document.getElementById(`tbody_${channelId}`);
                const newMember = {
                    id: memberId,
                    name: memberName,
                    teamName: teamName
                };
                
                if (!evaluationData.currentChannels[channelId]) {
                    evaluationData.currentChannels[channelId] = [];
                }
                evaluationData.currentChannels[channelId].push(newMember);
                
                const newRow = createMemberRow(channelId, newMember, {}, ['']);
                tbody.insertAdjacentHTML('beforeend', newRow);
                
                selectedOption.remove();
                
                const countElement = document.querySelector(`[data-channel-id="${channelId}"] .channel-members-count`);
                countElement.textContent = `íŒ€ì› ìˆ˜: ${evaluationData.currentChannels[channelId].length}ëª…`;
                
                showNotification(result.message, 'success');
            } else {
                showNotification(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('íŒ€ì› ì¶”ê°€ ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .addMemberToChannel(channelId, memberId);
}

function removeMemberFromChannelEval(channelId, memberId) {
    if (!confirm('ì´ íŒ€ì›ì„ ì±„ë„ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    showLoading(true);
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                document.getElementById(`row_${channelId}_${memberId}`).remove();
                document.getElementById(`detail_row_${channelId}_${memberId}`).remove();
                
                evaluationData.currentChannels[channelId] = evaluationData.currentChannels[channelId]
                    .filter(m => m.id !== memberId);
                
                const countElement = document.querySelector(`[data-channel-id="${channelId}"] .channel-members-count`);
                countElement.textContent = `íŒ€ì› ìˆ˜: ${evaluationData.currentChannels[channelId].length}ëª…`;
                
                updateMMTotal(channelId);
                updateContributionBar(channelId);
                
                showNotification(result.message, 'success');
            } else {
                showNotification(result.message, 'error');
            }
            showLoading(false);
        })
        .withFailureHandler(function(error) {
            showNotification('íŒ€ì› ì œê±° ì‹¤íŒ¨: ' + error, 'error');
            showLoading(false);
        })
        .removeMemberFromChannel(channelId, memberId);
}

function forceDarkModeForChannel(channelId) {
    const teamSelect = document.getElementById(`teamSelect_${channelId}`);
    const memberSelect = document.getElementById(`memberSelect_${channelId}`);
    
    [teamSelect, memberSelect].forEach(select => {
        if (select) {
            select.style.backgroundColor = '#0f0f0f';
            select.style.color = '#f1f1f1';
            select.style.border = '1px solid #3f3f3f';
            
            const options = select.querySelectorAll('option');
            options.forEach(option => {
                option.style.backgroundColor = '#0f0f0f';
                option.style.color = '#f1f1f1';
            });
        }
    });
}

// switchRole í•¨ìˆ˜ëŠ” utils.html.txtì—ì„œ ì •ì˜ë¨ (ì¤‘ë³µ ì œê±°)

// ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ê¶Œí•œ ì„¤ì • =====
window.addEventListener('load', function() {
    if (currentUser.level === 1 && currentUser.teamId) {
        setTimeout(() => {
            const newMemberTeam = document.getElementById('newMemberTeam');
            if (newMemberTeam) {
                for (let option of newMemberTeam.options) {
                    if (option.value && option.value !== currentUser.teamId) {
                        option.disabled = true;
                    }
                }
                newMemberTeam.value = currentUser.teamId;
            }
            
            const newChannelTeam = document.getElementById('newChannelTeam');
            if (newChannelTeam) {
                for (let option of newChannelTeam.options) {
                    if (option.value && option.value !== currentUser.teamId) {
                        option.disabled = true;
                    }
                }
                newChannelTeam.value = currentUser.teamId;
            }
            
            const channelSelect = document.getElementById('channelForMemberAssignment');
            if (channelSelect) {
                for (let option of channelSelect.options) {
                    if (option.value) {
                        const channel = evaluationData.channels.find(c => c.id === option.value);
                        if (channel && channel.teamId !== currentUser.teamId) {
                            option.style.display = 'none';
                        }
                    }
                }
            }
        }, 50);
    }
});

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
class ComponentManager {
    constructor() {
        this.listeners = new Map();
    }
    
    addListener(element, event, handler) {
        element.addEventListener(event, handler);
        
        if (!this.listeners.has(element)) {
            this.listeners.set(element, []);
        }
        this.listeners.get(element).push({ event, handler });
    }
    
    cleanup() {
        for (const [element, events] of this.listeners) {
            events.forEach(({ event, handler }) => {
                element.removeEventListener(event, handler);
            });
        }
        this.listeners.clear();
    }
}

const componentManager = new ComponentManager();

// ì—­í•  ì „í™˜ ì‹œ ì •ë¦¬
function switchRoleOptimized(role) {
    componentManager.cleanup(); // ì´ì „ í™”ë©´ì˜ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
    switchRole(role);
}



</script>
